<!DOCTYPE html>

<html>
<head>
  <title>cards.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="basicAI.html">
                basicAI.coffee
              </a>
            
              
              <a class="source" href="cards.html">
                cards.coffee
              </a>
            
              
              <a class="source" href="compileStrategies.html">
                compileStrategies.coffee
              </a>
            
              
              <a class="source" href="gameState.html">
                gameState.coffee
              </a>
            
              
              <a class="source" href="heuristics.html">
                heuristics.coffee
              </a>
            
              
              <a class="source" href="play.html">
                play.coffee
              </a>
            
              
              <a class="source" href="playWeb.html">
                playWeb.coffee
              </a>
            
              
              <a class="source" href="testSimulation.html">
                testSimulation.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>cards.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Dominion cards and their effects are defined in this file.  Each card is a
singleton, immutable object.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>We begin by creating the <code>c</code> object, an exported object with which one can 
look up any card by its name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>c = {}
<span class="hljs-keyword">this</span>.c = c
c.allCards = []</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="defining-cards">Defining cards</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Many cards are defined in terms of other cards using a pattern similar to
inheritance, except without the classes. There is no need for classes because
there are no separate instances.
Each Copper is a reference to the same single Copper object, for example.</p>
<p>The <code>makeCard</code> function will define a new card and add it to the card list.
<code>makeCard</code> works by copying an existing card object and applying a few new
properties to it.</p>
<p><code>name</code> is the name of the card, which will be the card’s string
representation and the key that you look it up in the card list <code>c</code> by.</p>
<p>To define a card independently of any existing card, let <code>origCard</code> be the
abstract card called <code>basicCard</code>. To define a card in terms of another card,
let <code>origCard</code> be that card object (probably a member of <code>c</code>, such as
<code>c.Estate</code>).</p>
<p><code>props</code> are the properties of the card that differ from its parent.</p>
<p><code>fake</code> is true when this should be an abstract card, not a card in the
supply. Fake cards are simply returned, not added to <code>c</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-title">makeCard</span> = <span class="hljs-params">(name, origCard, props, fake)</span> -&gt;</span>
  newCard = {}
  <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> origCard
    newCard[key] = value
  newCard.name = name
  <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> props
    newCard[key] = value
  newCard.parent = origCard.name   <span class="hljs-comment"># for debugging</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> fake
    c[name] = newCard
    c.allCards.push(name)
  newCard</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h3 id="the-basiccard-object">The basicCard object</h3>
<p><code>basicCard</code> contains all the things that are true by default
about a card, plus many useful methods that will be available on all cards.
All other cards should have <code>basicCard</code> as an ancestor. Many of the
properties and methods of <code>basicCard</code> are meant to be overridden in
real cards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>basicCard = {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>This set of boolean values defines a card’s types. Cards may have any
number of types.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">isAction</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">isTreasure</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">isVictory</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">isAttack</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">isReaction</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">isDuration</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">isPrize</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">isMultiplier</span>: <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The <strong>base cost</strong> of a card is defined here. To find out what a card
<em>actually</em> costs, use the getCost() method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cost</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">costPotion</span>: <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>These methods may be overridden by cards whose costs vary on their own,
particularly Peddler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">costInCoins</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-keyword">this</span>.cost
  <span class="hljs-attribute">costInPotions</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-keyword">this</span>.costPotion</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Card costs can change according to things external to the card, such as
bridges and quarries in play. Therefore, any code that wants to know the
actual cost of a card in a state should call <code>card.getCost(state)</code>.</p>
<p>This method returns a list of two elements, which are the cost in
coins and the cost in potions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getCost</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    coins = <span class="hljs-keyword">this</span>.costInCoins(state)

    <span class="hljs-keyword">for</span> modifier <span class="hljs-keyword">in</span> state.costModifiers
      coins += modifier.modify(<span class="hljs-keyword">this</span>)

    <span class="hljs-keyword">if</span> coins &lt; <span class="hljs-number">0</span>
      coins = <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> [coins, <span class="hljs-keyword">this</span>.costInPotions(state)]</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>These properties define simple, non-variable effects of playing a card.
They may only have constant numeric values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">actions</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">cards</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">coinTokens</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">buys</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">vp</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">trash</span>: <span class="hljs-number">0</span>        <span class="hljs-comment"># if the card requires trashing for no further effect</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>If a card has simple effects that <em>vary</em> based on the state, define
them by overriding these methods, which do take the state as a parameter.
The constant properties above will be ignored in that case, but you could
fill them in with reasonable guesses for the benefit of AI methods that
don’t want to examine the state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getActions</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-keyword">this</span>.actions
  <span class="hljs-attribute">getCards</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-keyword">this</span>.cards
  <span class="hljs-attribute">getCoins</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-keyword">this</span>.coins
  <span class="hljs-attribute">getCoinTokens</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-keyword">this</span>.coinTokens
  <span class="hljs-attribute">getBuys</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-keyword">this</span>.buys
  <span class="hljs-attribute">getTrash</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-keyword">this</span>.trash
  <span class="hljs-attribute">getVP</span>: <span class="hljs-function"><span class="hljs-params">(player)</span> -&gt;</span> <span class="hljs-keyword">this</span>.vp
  <span class="hljs-attribute">getMultiplier</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.isMultiplier <span class="hljs-keyword">then</span> <span class="hljs-keyword">this</span>.multiplier
    <span class="hljs-keyword">else</span> <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>getPotion says whether the card provides a potion. There is only one
card for which this is true, which is Potion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getPotion</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Some cards (Grand Market) may not be bought in certain situations.
Use <code>cards.mayBeBought(state)</code> to define when. By default, a card may be
bought whenever it is in the supply.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">mayBeBought</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><code>card.startingSupply(state)</code> is called once for each card in the supply
at the start of the game, to determine how many of them go into the supply.
This is 10 by default, but some types of cards override it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">startingSupply</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-number">10</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h3 id="complex-effects">Complex effects</h3>
<p>More complex effects of a card can be defined using arbitrary functions
that modify the state. These functions are no-ops in <code>basicCard</code>, and
may be overridden by cards that need them:</p>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Card initialization that happens at the start of the game, for instance
Black Market might set up the Black Market Deck, or Island might set up
the Island Mat</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">startGameEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <ul>
<li>What happens when the card is bought?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">buyEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <ul>
<li>What happens when the card is gained?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">gainEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <ul>
<li>What happens (besides the simple effects defined above) when the card is
played?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <ul>
<li>What happens when this card is trashed?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">trashEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <ul>
<li>What happens when this card is in play and another card is gained?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">gainInPlayEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <ul>
<li>What happens when this card is in play and another card is specifically
bought?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">buyInPlayEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <ul>
<li>What happens when this card is cleaned up from play?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cleanupEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <ul>
<li>What happens when the card is in play as a Duration at the start of
the turn?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">durationEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <ul>
<li>What happens when the card is shuffled into the draw deck?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">shuffleEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <ul>
<li>What happens when this card is in hand and an opponent plays an attack?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">reactToAttack</span>: <span class="hljs-function"><span class="hljs-params">(state, player, attackEvent)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <ul>
<li>What happens when this card is in the duration pile and an opponent plays an attack?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">durationReactToAttack</span>: <span class="hljs-function"><span class="hljs-params">(state, player, attackEvent)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <ul>
<li>What happens when this card is in hand and its owner gains a card?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">reactToGain</span>: <span class="hljs-function"><span class="hljs-params">(state, player, card)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <ul>
<li>What happens when this card is in hand and someone else gains a card?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">reactToOpponentGain</span>: <span class="hljs-function"><span class="hljs-params">(state, player, opponent, card)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <ul>
<li>What happens when this card is discarded?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">reactToDiscard</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <ul>
<li>What happens when a card is gained, in general?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">globalGainEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, player, card, source)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>This defines everything that happens when a card is played, including
basic effects and complex effects defined in <code>playEffect</code>. Cards
should not override <code>onPlay</code>; they should override <code>playEffect</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">onPlay</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.current.actions += <span class="hljs-keyword">this</span>.getActions(state)
    state.current.coins += <span class="hljs-keyword">this</span>.getCoins(state)
    state.current.potions += <span class="hljs-keyword">this</span>.getPotion(state)
    state.current.coinTokens += <span class="hljs-keyword">this</span>.getCoinTokens(state)
    state.current.buys += <span class="hljs-keyword">this</span>.getBuys(state)
    cardsToDraw = <span class="hljs-keyword">this</span>.getCards(state)
    cardsToTrash = <span class="hljs-keyword">this</span>.getTrash(state)
    <span class="hljs-keyword">if</span> cardsToDraw &gt; <span class="hljs-number">0</span>
      state.drawCards(state.current, cardsToDraw)
    <span class="hljs-keyword">if</span> cardsToTrash &gt; <span class="hljs-number">0</span>
      state.requireTrash(state.current, cardsToTrash)
    <span class="hljs-keyword">if</span> (ct = <span class="hljs-keyword">this</span>.getCoinTokens(state)) &gt; <span class="hljs-number">0</span>
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> gains <span class="hljs-subst">#{ct}</span> Coin Token<span class="hljs-subst">#{<span class="hljs-keyword">if</span> ct &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-string">"s"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>}</span>"</span>)
    <span class="hljs-keyword">this</span>.playEffect(state)</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Similarly, these are other ways for the game state to interact
with the card. Cards should override the <code>Effect</code> methods, not these.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">onDuration</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">this</span>.durationEffect(state)
  
  <span class="hljs-attribute">onCleanup</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">this</span>.cleanupEffect(state)

  <span class="hljs-attribute">onBuy</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">this</span>.buyEffect(state)
  
  <span class="hljs-attribute">onGain</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span>
    <span class="hljs-keyword">this</span>.gainEffect(state, player)

  <span class="hljs-attribute">onTrash</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span>
    <span class="hljs-keyword">this</span>.trashEffect(state, player)</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>A card’s string representation is its name.</p>
<p>If you have a value called
<code>card</code> that may be a string or a card object, you can ensure that it is
a card object by looking up <code>c[card]</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">toString</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> <span class="hljs-keyword">this</span>.name</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p><code>ai_</code> methods define the default AI preferences for this card. A prominent
example is ai_playValue, which tells the AI how much to prefer playing this
card (and of course changes with the state of the game). The higher the
ai_playValue, the more it prefers playing it before other cards.</p>
<p><code>ai_multipliedValue</code> is similar, but it can be higher when it’s playing an
action with a Throne Room or King’s Court.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">unless</span> <span class="hljs-keyword">this</span>.ai_playValue?
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"no ai_playValue for <span class="hljs-subst">#{<span class="hljs-keyword">this</span>}</span>"</span>)
    result = <span class="hljs-keyword">this</span>.ai_playValue(state, my)
    <span class="hljs-keyword">return</span> result
}</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h2 id="base-cards">Base cards</h2>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>These are the cards that are not Kingdom cards. Most of them appear in every
game; Potion, Platinum, and Colony appear in only some games.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
makeCard <span class="hljs-string">'Curse'</span>, basicCard, {</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Curse is the only card with no type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cost</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">vp</span>: -<span class="hljs-number">1</span>
  <span class="hljs-attribute">startingSupply</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">switch</span> state.nPlayers
      <span class="hljs-keyword">when</span> <span class="hljs-number">1</span>, <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-number">10</span>
      <span class="hljs-keyword">when</span> <span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-number">20</span>
      <span class="hljs-keyword">when</span> <span class="hljs-number">4</span> <span class="hljs-keyword">then</span> <span class="hljs-number">30</span>
      <span class="hljs-keyword">when</span> <span class="hljs-number">5</span> <span class="hljs-keyword">then</span> <span class="hljs-number">40</span>
      <span class="hljs-keyword">else</span> <span class="hljs-number">50</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>To define victory cards, we define Estate and then derive other cards from
it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>makeCard <span class="hljs-string">'Estate'</span>, basicCard, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">isVictory</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">vp</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">startingSupply</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">switch</span> state.nPlayers
      <span class="hljs-keyword">when</span> <span class="hljs-number">1</span>, <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-number">8</span>
      <span class="hljs-keyword">else</span> <span class="hljs-number">12</span> 
}

makeCard <span class="hljs-string">'Duchy'</span>, c.Estate, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>, <span class="hljs-attribute">vp</span>: <span class="hljs-number">3</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>If Duchess is in the game, the player has the option of gaining it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">gainEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.supply[<span class="hljs-string">'Duchess'</span>]?
      state.gainOneOf(player, [c.Duchess, <span class="hljs-literal">null</span>])
}
makeCard <span class="hljs-string">'Province'</span>, c.Estate, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">8</span>
  <span class="hljs-attribute">vp</span>: <span class="hljs-number">6</span>
  <span class="hljs-attribute">startingSupply</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">switch</span> state.nPlayers
      <span class="hljs-keyword">when</span> <span class="hljs-number">1</span>, <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-number">8</span>
      <span class="hljs-keyword">when</span> <span class="hljs-number">3</span>, <span class="hljs-number">4</span> <span class="hljs-keyword">then</span> <span class="hljs-number">12</span>
      <span class="hljs-keyword">when</span> <span class="hljs-number">5</span> <span class="hljs-keyword">then</span> <span class="hljs-number">15</span>
      <span class="hljs-keyword">else</span> <span class="hljs-number">18</span>
}
makeCard <span class="hljs-string">'Colony'</span>, c.Estate, {<span class="hljs-attribute">cost</span>: <span class="hljs-number">11</span>, <span class="hljs-attribute">vp</span>: <span class="hljs-number">10</span>}</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Now we define the basic treasure cards. Our prototypical card here is
Silver.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
makeCard <span class="hljs-string">'Silver'</span>, basicCard, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">isTreasure</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">startingSupply</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-number">40</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">100</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Copper is actually more complex than Silver: its value can vary when modified
by Coppersmith.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>makeCard <span class="hljs-string">'Copper'</span>, c.Silver, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">getCoins</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> state.copperValue ? <span class="hljs-number">1</span>
  <span class="hljs-attribute">startingSupply</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-number">60</span>
}

makeCard <span class="hljs-string">'Gold'</span>, c.Silver, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">6</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">startingSupply</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-number">30</span>
}

makeCard <span class="hljs-string">'Platinum'</span>, c.Silver, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">9</span>,
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attribute">startingSupply</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-number">12</span>
}
makeCard <span class="hljs-string">'Potion'</span>, c.Silver, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">getPotion</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-number">1</span>
  <span class="hljs-attribute">startingSupply</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-number">16</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <h2 id="vanilla-cards">Vanilla cards</h2>

            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>These cards have effects that involve no decisions, and are expressed entirely
in +actions, +cards, +coins, +buys, and VP.</p>
<p>Action cards may derive from the virtual card called <code>action</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>action = makeCard <span class="hljs-string">'action'</span>, basicCard, {<span class="hljs-attribute">isAction</span>: <span class="hljs-literal">true</span>}, <span class="hljs-literal">true</span>

makeCard <span class="hljs-string">'Village'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>, <span class="hljs-attribute">actions</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">cards</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">820</span>
}
makeCard <span class="hljs-string">"Worker's Village"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">actions</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">cards</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">832</span>
}
makeCard <span class="hljs-string">'Laboratory'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>, <span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">cards</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">782</span>
}
makeCard <span class="hljs-string">'Smithy'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">cards</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-number">665</span> <span class="hljs-keyword">else</span> <span class="hljs-number">200</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1540</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}
makeCard <span class="hljs-string">'Festival'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>, <span class="hljs-attribute">actions</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">coins</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">845</span>
}
makeCard <span class="hljs-string">'Woodcutter'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>, <span class="hljs-attribute">coins</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">164</span>
}
makeCard <span class="hljs-string">'Market'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>, <span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">cards</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">775</span>
}
makeCard <span class="hljs-string">'Bazaar'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>, <span class="hljs-attribute">actions</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">cards</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">835</span>
}
makeCard <span class="hljs-string">'Candlestick Maker'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">coinTokens</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">734</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h2 id="kingdom-victory-cards">Kingdom Victory cards</h2>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>These cards are all derived from Estate to insure their starting supply
amount is correct. This goes for multi-type Victory cards too—deriving Great Hall
from action instead of Estate results in 10 Great Halls in the supply instead of
8 for a 2-player game or 12 for more players.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
makeCard <span class="hljs-string">'Duke'</span>, c.Estate, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">getVP</span>: <span class="hljs-function"><span class="hljs-params">(player)</span> -&gt;</span> player.countInDeck(<span class="hljs-string">'Duchy'</span>)
}

makeCard <span class="hljs-string">'Fairgrounds'</span>, c.Estate, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">6</span>
  <span class="hljs-attribute">getVP</span>: <span class="hljs-function"><span class="hljs-params">(player)</span> -&gt;</span>
    unique = []
    deck = player.getDeck()
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> deck
      <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> unique
        unique.push(card)
    <span class="hljs-number">2</span> * Math.floor(unique.length / <span class="hljs-number">5</span>)    
}

makeCard <span class="hljs-string">'Farmland'</span>, c.Estate, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">6</span>
  <span class="hljs-attribute">vp</span>: <span class="hljs-number">2</span>

  <span class="hljs-attribute">upgradeFilter</span>: <span class="hljs-function"><span class="hljs-params">(state, oldCard, newCard)</span> -&gt;</span>
    [coins1, potions1] = oldCard.getCost(state)
    [coins2, potions2] = newCard.getCost(state)
    <span class="hljs-keyword">return</span> (potions1 == potions2) <span class="hljs-keyword">and</span> (coins1 + <span class="hljs-number">2</span> == coins2)

  <span class="hljs-attribute">buyEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    choices = upgradeChoices(state, state.current.hand, <span class="hljs-keyword">this</span>.upgradeFilter)
    choice = state.current.ai.choose(<span class="hljs-string">'upgrade'</span>, state, choices)
    <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
      [oldCard, newCard] = choice
      state.doTrash(state.current, oldCard)
      state.gainCard(state.current, newCard)    
}

makeCard <span class="hljs-string">'Feodum'</span>, c.Estate, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">getVP</span>: <span class="hljs-function"><span class="hljs-params">(player)</span> -&gt;</span> Math.floor(player.countInDeck(<span class="hljs-string">'Silver'</span>) / <span class="hljs-number">3</span>)
  <span class="hljs-attribute">trashEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span>
    state.gainCard(player, c.Silver)
    state.gainCard(player, c.Silver)
    state.gainCard(player, c.Silver)
}

makeCard <span class="hljs-string">'Gardens'</span>, c.Estate, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">getVP</span>: <span class="hljs-function"><span class="hljs-params">(player)</span> -&gt;</span> Math.floor(player.getDeck().length / <span class="hljs-number">10</span>)
}

makeCard <span class="hljs-string">'Great Hall'</span>, c.Estate, {
  <span class="hljs-attribute">isAction</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> c.Crossroads <span class="hljs-keyword">in</span> my.hand
      <span class="hljs-number">520</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">742</span>

}

makeCard <span class="hljs-string">'Harem'</span>, c.Estate, {
  <span class="hljs-attribute">isTreasure</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">6</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">vp</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">startingSupply</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-number">8</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">100</span>
}

makeCard <span class="hljs-string">'Island'</span>, c.Estate, {
  <span class="hljs-attribute">isAction</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">vp</span>: <span class="hljs-number">2</span>

  <span class="hljs-attribute">startGameEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> player <span class="hljs-keyword">in</span> state.players
      player.mats.island = []

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.current.hand.length == <span class="hljs-number">0</span> <span class="hljs-comment"># handle a weird edge case</span>
      state.log(<span class="hljs-string">"…setting aside the Island (no other cards in hand)."</span>)
    <span class="hljs-keyword">else</span>
      card = state.current.ai.choose(<span class="hljs-string">'island'</span>, state, state.current.hand)
      state.log(<span class="hljs-string">"…setting aside the Island and a <span class="hljs-subst">#{card}</span>."</span>)
      state.current.hand.remove(card)
      state.current.mats.island.push(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>removing the Island from play is conditional so it won’t break with 
Throne Room and King’s Court</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span> <span class="hljs-keyword">in</span> state.current.inPlay
      state.current.inPlay.remove(<span class="hljs-keyword">this</span>)
      state.current.mats.island.push(<span class="hljs-keyword">this</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">132</span>
}

makeCard <span class="hljs-string">'Nobles'</span>, c.Estate, {
  <span class="hljs-attribute">isAction</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">6</span>
  <span class="hljs-attribute">vp</span>: <span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Nobles is an example of a card that allows a choice from multiple
simple effects. We implement this using the <code>choose(&#39;benefit&#39;)</code> AI method,
which is passed a list of benefit objects, one of which it will choose
to apply to the state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    benefit = state.current.ai.choose(<span class="hljs-string">'benefit'</span>, state, [
      {<span class="hljs-attribute">actions</span>: <span class="hljs-number">2</span>},
      {<span class="hljs-attribute">cards</span>: <span class="hljs-number">3</span>}
    ])
    applyBenefit(state, benefit)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">296</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">1340</span>
}

makeCard <span class="hljs-string">'Silk Road'</span>, c.Estate, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">getVP</span>: <span class="hljs-function"><span class="hljs-params">(player)</span> -&gt;</span> Math.floor(player.countCardTypeInDeck(<span class="hljs-string">'Victory'</span>) / <span class="hljs-number">4</span>)
}</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Revealing Tunnel for Gold as it is discarded is automatic.
TODO: make this into a decision.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>makeCard <span class="hljs-string">'Tunnel'</span>, c.Estate, {
  <span class="hljs-attribute">isReaction</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">vp</span>: <span class="hljs-number">2</span>

  <span class="hljs-attribute">reactToDiscard</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.phase <span class="hljs-keyword">isnt</span> <span class="hljs-string">'cleanup'</span>
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> gains a Gold for discarding the Tunnel."</span>)
      state.gainCard(player, c.Gold)
    
}

makeCard <span class="hljs-string">'Vineyard'</span>, c.Estate, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">costPotion</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">getVP</span>: <span class="hljs-function"><span class="hljs-params">(player)</span> -&gt;</span> Math.floor(player.numActionCardsInDeck() / <span class="hljs-number">3</span>)
}</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <h2 id="kingdom-treasure-cards">Kingdom Treasure cards</h2>

            </div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Kingdom cards that are also treasure cards derive from treasure, which
derives from Silver, but with a changed startingSupply.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
treasure = makeCard <span class="hljs-string">'treasure'</span>, c.Silver, {<span class="hljs-attribute">startingSupply</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-number">10</span>}, <span class="hljs-literal">true</span>

makeCard <span class="hljs-string">'Bank'</span>, treasure, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">7</span>
  <span class="hljs-attribute">getCoins</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    coins = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.inPlay
      <span class="hljs-keyword">if</span> card.isTreasure
        coins += <span class="hljs-number">1</span>
    coins
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.log(<span class="hljs-string">"...which is worth <span class="hljs-subst">#{<span class="hljs-keyword">this</span>.getCoins(state)}</span>."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">20</span>
}

makeCard <span class="hljs-string">'Cache'</span>, treasure, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">3</span>
  
  <span class="hljs-attribute">gainEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span>
    state.gainCard(player, c.Copper)
    state.gainCard(player, c.Copper)
}

makeCard <span class="hljs-string">"Fool's Gold"</span>, treasure, {
  <span class="hljs-attribute">isReaction</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>
  
  <span class="hljs-attribute">getCoins</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.current.countInPlay(<span class="hljs-string">"Fool's Gold"</span>) &gt; <span class="hljs-number">1</span>
      <span class="hljs-number">4</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">1</span>
  
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.current.foolsGoldInPlay = <span class="hljs-literal">true</span>

  <span class="hljs-attribute">reactToOpponentGain</span>: <span class="hljs-function"><span class="hljs-params">(state, player, opp, card)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> card <span class="hljs-keyword">is</span> c.Province
      <span class="hljs-keyword">if</span> player.ai.choose(<span class="hljs-string">'foolsGoldTrash'</span>, state, [<span class="hljs-literal">yes</span>, <span class="hljs-literal">no</span>])
        state.doTrash(player, <span class="hljs-keyword">this</span>)
        state.gainCard(player, c.Gold, <span class="hljs-string">'draw'</span>)
        state.log(<span class="hljs-string">"...putting the Gold on top of the draw pile."</span>)
}

makeCard <span class="hljs-string">"Hoard"</span>, treasure, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">6</span>
  <span class="hljs-attribute">buyInPlayEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> card.isVictory
      state.gainCard(state.current, c.Gold, <span class="hljs-string">'discard'</span>, <span class="hljs-literal">true</span>)
      state.log(<span class="hljs-string">"...gaining a Gold."</span>)
}

makeCard <span class="hljs-string">"Horn of Plenty"</span>, treasure, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> 
    limit = state.current.numUniqueCardsInPlay()
    choices = []
    <span class="hljs-keyword">for</span> cardName <span class="hljs-keyword">of</span> state.supply
      card = c[cardName]
      [coins, potions] = card.getCost(state)
      <span class="hljs-keyword">if</span> state.supply[cardName] &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> potions == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> coins &lt;= limit
        choices.push(card)
    choice = state.gainOneOf(state.current, choices)
    <span class="hljs-keyword">if</span> choice.isVictory
      transferCard(<span class="hljs-keyword">this</span>, state.current.inPlay, state.trash)
      state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> trashes the Horn of Plenty."</span>)

  <span class="hljs-attribute">aiPlayValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.numUniqueCardsInPlay() &gt;= <span class="hljs-number">2</span>
      <span class="hljs-number">10</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">10</span>
}

makeCard <span class="hljs-string">'Ill-Gotten Gains'</span>, treasure, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> 
    <span class="hljs-keyword">if</span> state.current.ai.choose(<span class="hljs-string">'gainCopper'</span>, state, [<span class="hljs-literal">yes</span>, <span class="hljs-literal">no</span>])
      state.gainCard(state.current, c.Copper, <span class="hljs-string">'hand'</span>)
  
  <span class="hljs-attribute">gainEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>For each player but the gainer: gain a curse.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..state.nPlayers]
      <span class="hljs-keyword">if</span> state.players[i] != player
        state.gainCard(state.players[i], c.Curse)
}

makeCard <span class="hljs-string">'Loan'</span>, treasure, {
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    drawn = state.current.dig(state,
      <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span> card.isTreasure
    )    
    <span class="hljs-keyword">if</span> drawn.length &gt; <span class="hljs-number">0</span>
      treasure = drawn[<span class="hljs-number">0</span>]
      trash = state.current.ai.choose(<span class="hljs-string">'trash'</span>, state, [treasure, <span class="hljs-literal">null</span>])
      <span class="hljs-keyword">if</span> trash?
        state.log(<span class="hljs-string">"...trashing the <span class="hljs-subst">#{treasure}</span>."</span>)
        transferCard(treasure, drawn, state.trash)
      <span class="hljs-keyword">else</span>
        state.log(<span class="hljs-string">"...discarding the <span class="hljs-subst">#{treasure}</span>."</span>)
        state.current.discard.push(treasure)
        state.handleDiscards(state.current, [treasure])

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">70</span>
}

makeCard <span class="hljs-string">"Philosopher's Stone"</span>, treasure, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">costPotion</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">getCoins</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    Math.floor((state.current.draw.length + state.current.discard.length) / <span class="hljs-number">5</span>)
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.log(<span class="hljs-string">"...which is worth <span class="hljs-subst">#{<span class="hljs-keyword">this</span>.getCoins(state)}</span>."</span>)
}

makeCard <span class="hljs-string">'Quarry'</span>, treasure, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> =&gt;</span>
    state.costModifiers.push
      <span class="hljs-attribute">source</span>: <span class="hljs-keyword">this</span>
      <span class="hljs-attribute">modify</span>: <span class="hljs-function"><span class="hljs-params">(card)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> card.isAction
          -<span class="hljs-number">2</span>
        <span class="hljs-keyword">else</span>
          <span class="hljs-number">0</span>
}

makeCard <span class="hljs-string">'Royal Seal'</span>, treasure, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">gainInPlayEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span>
    player = state.current
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> player.gainLocation == <span class="hljs-string">'trash'</span>
    source = player[player.gainLocation]
    <span class="hljs-keyword">if</span> player.ai.choose(<span class="hljs-string">'gainOnDeck'</span>, state, [card, <span class="hljs-literal">null</span>])
      state.log(<span class="hljs-string">"...putting the <span class="hljs-subst">#{card}</span> on top of the deck."</span>)
      player.gainLocation = <span class="hljs-string">'draw'</span>
      transferCardToTop(card, source, player.draw)
}

makeCard <span class="hljs-string">'Spoils'</span>, treasure, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">3</span>
  
  <span class="hljs-attribute">mayBeBought</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-literal">false</span>
  <span class="hljs-attribute">startingSupply</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-number">0</span>
  
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.current.inPlay.remove(<span class="hljs-keyword">this</span>)
    state.specialSupply[<span class="hljs-string">'Spoils'</span>] += <span class="hljs-number">1</span>
    state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.specialSupply[<span class="hljs-string">'Spoils'</span>]}</span> Spoils in the supply"</span>)
   
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.ai.wantsToPlaySpoils(state) 
      <span class="hljs-number">81</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-literal">null</span>    
}

makeCard <span class="hljs-string">'Talisman'</span>, treasure, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">buyInPlayEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> card.getCost(state)[<span class="hljs-number">0</span>] &lt;= <span class="hljs-number">4</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> card.isVictory
      state.gainCard(state.current, card, <span class="hljs-string">'discard'</span>, <span class="hljs-literal">true</span>)
      state.log(<span class="hljs-string">"...gaining a <span class="hljs-subst">#{card}</span>."</span>)
}

makeCard <span class="hljs-string">'Venture'</span>, treasure, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    drawn = state.current.dig(state,
      <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span> card.isTreasure
    )
    <span class="hljs-keyword">if</span> drawn.length &gt; <span class="hljs-number">0</span>
      treasure = drawn[<span class="hljs-number">0</span>]
      state.log(<span class="hljs-string">"...playing <span class="hljs-subst">#{treasure}</span>."</span>)
      state.current.inPlay.push(treasure)
      treasure.onPlay(state)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">80</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <h2 id="duration-cards">Duration cards</h2>

            </div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>These cards have additional properties, such as <code>durationActions</code>, defining
constant effects that happen when the card is resolved as a duration card.
The virtual card <code>duration</code> specifies how to process these effects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>duration = makeCard <span class="hljs-string">'duration'</span>, action, {
  <span class="hljs-attribute">durationActions</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">durationBuys</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">durationCoins</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">durationCards</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">isDuration</span>: <span class="hljs-literal">true</span>

  <span class="hljs-attribute">durationEffect</span>:
    <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
      state.current.actions += <span class="hljs-keyword">this</span>.durationActions
      state.current.buys += <span class="hljs-keyword">this</span>.durationBuys
      state.current.coins += <span class="hljs-keyword">this</span>.durationCoins
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.durationCards &gt; <span class="hljs-number">0</span>
        state.drawCards(state.current, <span class="hljs-keyword">this</span>.durationCards)
}, <span class="hljs-literal">true</span>

makeCard <span class="hljs-string">'Haven'</span>, duration, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">startGameEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> player <span class="hljs-keyword">in</span> state.players</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>We put Haven and the cards it sets aside on a “mat”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      player.mats.haven = []

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    cardInHaven = state.current.ai.choose(<span class="hljs-string">'putOnDeck'</span>, state, state.current.hand)
    <span class="hljs-keyword">if</span> cardInHaven?
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> sets aside a <span class="hljs-subst">#{cardInHaven}</span> with Haven."</span>)
      transferCard(cardInHaven, state.current.hand, state.current.mats.haven)
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">if</span> state.current.hand.length==<span class="hljs-number">0</span>
        state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> has no cards to set aside."</span>)
      <span class="hljs-keyword">else</span>
        state.warn(<span class="hljs-string">"hand not empty but no card set aside"</span>)

  <span class="hljs-attribute">durationEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    cardFromHaven = state.current.mats.haven.pop()
    <span class="hljs-keyword">if</span> cardFromHaven?
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> picks up a <span class="hljs-subst">#{cardFromHaven}</span> from Haven."</span>)
      state.current.hand.unshift(cardFromHaven)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">710</span>
}

makeCard <span class="hljs-string">'Caravan'</span>, duration, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">durationCards</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">780</span>
}

makeCard <span class="hljs-string">'Fishing Village'</span>, duration, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">durationActions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">durationCoins</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">823</span>
}

makeCard <span class="hljs-string">'Wharf'</span>, duration, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">buys</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">durationCards</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">durationBuys</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">275</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1740</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Merchant Ship'</span>, duration, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">durationCoins</span>: +<span class="hljs-number">2</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">186</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1500</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Lighthouse'</span>, duration, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">durationCoins</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">715</span>

  <span class="hljs-attribute">durationReactToAttack</span>: <span class="hljs-function"><span class="hljs-params">(state, player, attackEvent)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Don’t bother blocking the attack if it’s already blocked (avoid log spam)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">unless</span> attackEvent.blocked
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> is protected by the Lighthouse."</span>)
      attackEvent.blocked = <span class="hljs-literal">true</span>
}

makeCard <span class="hljs-string">'Outpost'</span>, duration, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>effect implemented by gameState</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.extraTurn
      -<span class="hljs-number">15</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">154</span>
} 

makeCard <span class="hljs-string">'Tactician'</span>, duration, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">durationActions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">durationBuys</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">durationCards</span>: +<span class="hljs-number">5</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>If this is the first time we’ve played Tactician this turn, reset the count
of active Tacticians.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> state.current.countInPlay(<span class="hljs-string">'Tactician'</span>) == <span class="hljs-number">1</span>
      state.cardState[<span class="hljs-keyword">this</span>] =
        <span class="hljs-attribute">activeTacticians</span>: <span class="hljs-number">0</span>

    cardsInHand = state.current.hand.length</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>If any cards can be discarded…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> cardsInHand &gt; <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Discard the hand and activate the tactician.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      state.log(<span class="hljs-string">"...discarding the whole hand."</span>)
      state.cardState[<span class="hljs-keyword">this</span>].activeTacticians++
      discards = state.current.hand
      state.current.discard = state.current.discard.concat(discards)
      state.current.hand = []
      state.handleDiscards(state.current, discards)</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>The cleanupEffect of a dead Tactician is to discard it instead of putting it in the
duration area. It’s not a duration card in this case.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cleanupEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.cardState[<span class="hljs-keyword">this</span>].activeTacticians &gt; <span class="hljs-number">0</span>
      state.cardState[<span class="hljs-keyword">this</span>].activeTacticians--
    <span class="hljs-keyword">else</span>
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> discards an inactive Tactician."</span>)
      transferCard(c.Tactician, state.current.inPlay, state.current.discard)
      state.handleDiscards(state.current, [c.Tactician])

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>FIXME: playing Tactician is extremely situational and this doesn’t take
it into account.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-number">272</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <h2 id="trash-for-gain-cards">Trash-for-gain cards</h2>

            </div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>This section describes the actions where you trash one card to gain another.
I refer to this in general as “upgrading”, which is not meant to be specific
to the card Upgrade.</p>
<p>The prototype on which we base these cards is Remodel. Most of the other
cards are variants that simply change the filter for which upgrades are
possible.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>makeCard <span class="hljs-string">'Remodel'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>

  <span class="hljs-attribute">exactCostUpgrade</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">costFunction</span>: <span class="hljs-function"><span class="hljs-params">(coins)</span> -&gt;</span> coins + <span class="hljs-number">2</span>

  <span class="hljs-attribute">upgradeFilter</span>: <span class="hljs-function"><span class="hljs-params">(state, oldCard, newCard)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Given two cards, return whether upgrading from oldCard to newCard is allowed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [coins1, potions1] = oldCard.getCost(state)
    [coins2, potions2] = newCard.getCost(state)</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>We’ll leave the cost check in <code>this.costFunction</code>, so we can reuse this code
for many upgrading cards with different cost requirements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.exactCostUpgrade
      <span class="hljs-keyword">return</span> (potions1 == potions2) <span class="hljs-keyword">and</span> (<span class="hljs-keyword">this</span>.costFunction(coins1) == coins2)
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> (potions1 &gt;= potions2) <span class="hljs-keyword">and</span> (<span class="hljs-keyword">this</span>.costFunction(coins1) &gt;= coins2)

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Find the pairs of cards we’re allowed to upgrade from and to.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    choices = upgradeChoices(state, state.current.hand, <span class="hljs-keyword">this</span>.upgradeFilter.bind(<span class="hljs-keyword">this</span>))
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.exactCostUpgrade</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>If the card requires upgrading to a card with an <em>exact</em> cost, then
we’ll likely have the option to upgrade a card to nothing. Add in
those choices.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      choices2 = nullUpgradeChoices(state, state.current.hand, <span class="hljs-keyword">this</span>.costFunction.bind(<span class="hljs-keyword">this</span>))
      choices = choices.concat(choices2)

    choice = state.current.ai.choose(<span class="hljs-string">'upgrade'</span>, state, choices)
    <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
      [oldCard, newCard] = choice
      state.doTrash(state.current, oldCard)
      <span class="hljs-keyword">if</span> newCard <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
        state.gainCard(state.current, newCard)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">223</span>
}


makeCard <span class="hljs-string">'Expand'</span>, c.Remodel, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">7</span>

  <span class="hljs-attribute">costFunction</span>: <span class="hljs-function"><span class="hljs-params">(coins)</span> -&gt;</span> coins + <span class="hljs-number">3</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">226</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>New in Dark Ages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>makeCard <span class="hljs-string">'Graverobber'</span>, c.Remodel, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>

  <span class="hljs-attribute">upgradeFilter</span>: <span class="hljs-function"><span class="hljs-params">(state, oldCard, newCard)</span> -&gt;</span>
    [coins1, potions1] = oldCard.getCost(state)
    [coins2, potions2] = newCard.getCost(state)
    <span class="hljs-keyword">return</span> oldCard.isAction <span class="hljs-keyword">and</span> (potions1 &gt;= potions2) <span class="hljs-keyword">and</span> (coins1 + <span class="hljs-number">3</span> &gt;= coins2)</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>I’ll suppose this card is a bit better to play than Remodel and worse than
Expand, but I really don’t know.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">225</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Find the pairs of cards we’re allowed to upgrade from and to.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    choices = upgradeChoices(state, state.current.hand, <span class="hljs-keyword">this</span>.upgradeFilter.bind(<span class="hljs-keyword">this</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>We can instead choose to gain cards costing 3 to 6 from the trash onto the deck.
Consider those as “upgrades” from nothing to that card, so we can compare them
to our upgrade choices.</p>
<p>FIXME: This doesn’t take into account the benefit (or drawback) of gaining a card
on the deck.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.trash
      [coins, potions] = card.getCost(state)
      <span class="hljs-keyword">if</span> <span class="hljs-number">3</span> &lt;= coins &lt;= <span class="hljs-number">6</span> <span class="hljs-keyword">and</span> potions == <span class="hljs-number">0</span>
        choices.push [<span class="hljs-literal">null</span>, card]

    choice = state.current.ai.choose(<span class="hljs-string">'upgrade'</span>, state, choices)
    <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
      [oldCard, newCard] = choice
      <span class="hljs-keyword">if</span> oldCard <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
        state.doTrash(state.current, oldCard)
      <span class="hljs-keyword">if</span> newCard <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> oldCard <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
          state.log(<span class="hljs-string">"...gaining <span class="hljs-subst">#{newCard}</span> from the trash and putting it on top of the deck."</span>)
          state.supply[newCard] += <span class="hljs-number">1</span>
          state.trash.remove(newCard)
          state.gainCard(state.current, newCard, <span class="hljs-string">'draw'</span>, <span class="hljs-literal">true</span>)
        <span class="hljs-keyword">else</span>
          state.gainCard(state.current, newCard, <span class="hljs-string">'discard'</span>)

}

makeCard <span class="hljs-string">'Upgrade'</span>, c.Remodel, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">exactCostUpgrade</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">costFunction</span>: <span class="hljs-function"><span class="hljs-params">(coins)</span> -&gt;</span> coins + <span class="hljs-number">1</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    multiplier = my.getMultiplier()
    wantsToTrash = my.ai.wantsToTrash(state)
    <span class="hljs-keyword">if</span> wantsToTrash &gt;= multiplier
      <span class="hljs-number">490</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">30</span>
}

makeCard <span class="hljs-string">'Remake'</span>, c.Remodel, {
  <span class="hljs-attribute">exactCostUpgrade</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">costFunction</span>: <span class="hljs-function"><span class="hljs-params">(coins)</span> -&gt;</span> coins + <span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1.</span><span class="hljs-number">.2</span>]
      choices = upgradeChoices(state, state.current.hand, <span class="hljs-keyword">this</span>.upgradeFilter.bind(<span class="hljs-keyword">this</span>))
      choices2 = nullUpgradeChoices(state, state.current.hand, <span class="hljs-keyword">this</span>.costFunction.bind(<span class="hljs-keyword">this</span>))
      choice = state.current.ai.choose(<span class="hljs-string">'upgrade'</span>, state, choices.concat(choices2))
      <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
        [oldCard, newCard] = choice
        state.doTrash(state.current, oldCard)
        <span class="hljs-keyword">if</span> newCard <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
          state.gainCard(state.current, newCard)  

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    multiplier = my.getMultiplier()
    wantsToTrash = my.ai.wantsToTrash(state)
    <span class="hljs-keyword">if</span> wantsToTrash &gt;= multiplier*<span class="hljs-number">2</span>
      <span class="hljs-number">178</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">35</span>

}

makeCard <span class="hljs-string">'Mine'</span>, c.Remodel, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>

  <span class="hljs-attribute">upgradeFilter</span>: <span class="hljs-function"><span class="hljs-params">(state, oldCard, newCard)</span> -&gt;</span>
    [coins1, potions1] = oldCard.getCost(state)
    [coins2, potions2] = newCard.getCost(state)
    <span class="hljs-keyword">return</span> (potions1 &gt;= potions2) <span class="hljs-keyword">and</span> (coins1 + <span class="hljs-number">3</span> &gt;= coins2) \
       <span class="hljs-keyword">and</span> oldCard.isTreasure <span class="hljs-keyword">and</span> newCard.isTreasure</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Modify the Remodel playEffect so that it gains the card in hand.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    choices = upgradeChoices(state, state.current.hand, <span class="hljs-keyword">this</span>.upgradeFilter.bind(<span class="hljs-keyword">this</span>))
    choice = state.current.ai.choose(<span class="hljs-string">'upgrade'</span>, state, choices)
    <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
      [oldCard, newCard] = choice
      state.doTrash(state.current, oldCard)
      state.gainCard(state.current, newCard, <span class="hljs-string">'hand'</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">217</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1260</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <h2 id="prize-cards">Prize cards</h2>

            </div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Because Prize cards can only be gained through Tournament, and all have
cost = 0, startingSupply -&gt; 0, and mayBeBought -&gt; false it is useful to
have a prototype prize. The prototype has isAction: true since 4 of the 5
prizes are action cards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
prize = makeCard <span class="hljs-string">'prize'</span>, basicCard, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">isPrize</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">isAction</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">mayBeBought</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-literal">false</span>
  <span class="hljs-attribute">startingSupply</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-number">0</span>
}, <span class="hljs-literal">true</span>

makeCard <span class="hljs-string">'Bag of Gold'</span>, prize, {
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span> 
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.gainCard(state.current, c.Gold, <span class="hljs-string">'draw'</span>)
    state.log(<span class="hljs-string">"...putting the Gold on top of the deck."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">885</span>
}

makeCard <span class="hljs-string">'Diadem'</span>, prize, {
  <span class="hljs-attribute">isAction</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">isTreasure</span>: <span class="hljs-literal">true</span> 
  <span class="hljs-attribute">getCoins</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-number">2</span> + state.current.actions
}

makeCard <span class="hljs-string">'Followers'</span>, prize, {
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">isAttack</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.gainCard(state.current, c.Estate)
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      state.gainCard(opp, c.Curse)
      <span class="hljs-keyword">if</span> opp.hand.length &gt; <span class="hljs-number">3</span>
        state.requireDiscard(opp, opp.hand.length - <span class="hljs-number">3</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">292</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1890</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Since there is only one Princess card, and Princess’s cost
reduction effect has the clause “while this is in play”,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>makeCard <span class="hljs-string">'Princess'</span>, prize, {
  <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>:
    <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
      state.costModifiers.push
        <span class="hljs-attribute">source</span>: <span class="hljs-keyword">this</span>
        <span class="hljs-attribute">modify</span>: <span class="hljs-function"><span class="hljs-params">(card)</span> -&gt;</span> -<span class="hljs-number">2</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">264</span>

}

makeCard <span class="hljs-string">'Trusty Steed'</span>, prize, {
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    benefit = state.current.ai.choose(<span class="hljs-string">'benefit'</span>, state, [
      {<span class="hljs-attribute">cards</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">actions</span>: <span class="hljs-number">2</span>},
      {<span class="hljs-attribute">cards</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">coins</span>: <span class="hljs-number">2</span>},
      {<span class="hljs-attribute">actions</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">coins</span>: <span class="hljs-number">2</span>},
      {<span class="hljs-attribute">cards</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">horseEffect</span>: <span class="hljs-literal">yes</span>},
      {<span class="hljs-attribute">actions</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">horseEffect</span>: <span class="hljs-literal">yes</span>},
      {<span class="hljs-attribute">coins</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">horseEffect</span>: <span class="hljs-literal">yes</span>}
    ])
    applyBenefit(state, benefit)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">848</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <h2 id="attack-cards">Attack cards</h2>

            </div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Cards with the type Attack; their prototype is just used so
isAttack: true doesn’t need to be rewritten every time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
attack = makeCard <span class="hljs-string">'attack'</span>, action, {<span class="hljs-attribute">isAttack</span>: <span class="hljs-literal">true</span>}, <span class="hljs-literal">true</span>

makeCard <span class="hljs-string">'Ambassador'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Determine the cards and quantities that can be ambassadored</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    counts = {}
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.hand
      counts[card] ?= <span class="hljs-number">0</span>
      counts[card] += <span class="hljs-number">1</span>
    choices = []
    <span class="hljs-keyword">for</span> card, count <span class="hljs-keyword">of</span> counts
      <span class="hljs-keyword">if</span> count &gt;= <span class="hljs-number">2</span>
        choices.push [card, <span class="hljs-number">2</span>]
      <span class="hljs-keyword">if</span> count &gt;= <span class="hljs-number">1</span>
        choices.push [card, <span class="hljs-number">1</span>]
      choices.push [card, <span class="hljs-number">0</span>]

    choice = state.current.ai.choose(<span class="hljs-string">'ambassador'</span>, state, choices)

    <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
      [cardName, quantity] = choice
      card = c[cardName]
      state.log(<span class="hljs-string">"...choosing to return <span class="hljs-subst">#{quantity}</span> <span class="hljs-subst">#{cardName}</span>."</span>)
      <span class="hljs-keyword">if</span> state.supply[card]?
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..quantity]
          state.current.hand.remove(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Return it to the supply, if it had a slot in the supply to begin with</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.supply[card] += quantity
        state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
          state.gainCard(opp, card)
      <span class="hljs-keyword">else</span>
        state.log(<span class="hljs-string">"...but <span class="hljs-subst">#{cardName}</span> is not in the Supply."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    wantsToTrash = my.ai.wantsToTrash(state)
    <span class="hljs-keyword">if</span> wantsToTrash &gt; <span class="hljs-number">0</span>
      <span class="hljs-number">150</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">20</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    wantsToTrash = my.ai.wantsToTrash(state)
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> wantsToTrash &gt; <span class="hljs-number">0</span>
      <span class="hljs-number">1100</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Bureaucrat'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.gainCard(state.current, c.Silver, <span class="hljs-string">'draw'</span>)
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      victory = []
      <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> opp.hand
        <span class="hljs-keyword">if</span> card.isVictory
          victory.push(card)
      <span class="hljs-keyword">if</span> victory.length == <span class="hljs-number">0</span>
        state.revealHand(opp)
        state.log(<span class="hljs-string">"<span class="hljs-subst">#{opp.ai}</span> reveals a hand with no Victory cards."</span>)
      <span class="hljs-keyword">else</span>
        choice = opp.ai.choose(<span class="hljs-string">'putOnDeck'</span>, state, victory)
        transferCardToTop(choice, opp.hand, opp.draw)
        state.log(<span class="hljs-string">"<span class="hljs-subst">#{opp.ai}</span> returns <span class="hljs-subst">#{choice}</span> to the top of the deck."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">128</span>
}

makeCard <span class="hljs-string">'Cutpurse'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
      state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> c.Copper <span class="hljs-keyword">in</span> opp.hand
          state.doDiscard(opp, c.Copper)
        <span class="hljs-keyword">else</span>
          state.log(<span class="hljs-string">"<span class="hljs-subst">#{opp.ai}</span> has no Copper in hand."</span>)
          state.revealHand(opp)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">250</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1180</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Familiar'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">costPotion</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      state.gainCard(opp, c.Curse)
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">755</span>
}

makeCard <span class="hljs-string">'Fortune Teller'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      drawn = opp.dig(state,
        <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span> card.isVictory <span class="hljs-keyword">or</span> card <span class="hljs-keyword">is</span> c.Curse
      )
      <span class="hljs-keyword">if</span> drawn.length &gt; <span class="hljs-number">0</span>
        card = drawn[<span class="hljs-number">0</span>]
        transferCardToTop(card, drawn, opp.draw)
        state.log(<span class="hljs-string">"...<span class="hljs-subst">#{opp.ai}</span> puts <span class="hljs-subst">#{card}</span> on top of the deck."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">130</span>
}

makeCard <span class="hljs-string">'Ghost Ship'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      <span class="hljs-keyword">while</span> opp.hand.length &gt; <span class="hljs-number">3</span></pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Choosing cards one at a time does not necessarily lead to the
best decision. However, it leads to a reasonable, quick decision when
there could be a very large number of nearly-identical options
to evaluate, which is good for a simulator.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        choices = opp.hand
        putBack = opp.ai.choose(<span class="hljs-string">'putOnDeck'</span>, state, choices)
        state.log(<span class="hljs-string">"...<span class="hljs-subst">#{opp.ai}</span> puts <span class="hljs-subst">#{putBack}</span> on top of the deck."</span>)
        transferCardToTop(putBack, opp.hand, opp.draw)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-number">670</span> <span class="hljs-keyword">else</span> <span class="hljs-number">266</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1680</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>

}

makeCard <span class="hljs-string">'Jester'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">2</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      card = state.discardFromDeck(opp, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
      <span class="hljs-keyword">if</span> card?
        <span class="hljs-keyword">if</span> card.isVictory
          state.gainCard(opp, c.Curse)
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> state.current.ai.chooseGain(state, [card, <span class="hljs-literal">null</span>])
          state.gainCard(state.current, card)
        <span class="hljs-keyword">else</span>
          state.gainCard(opp, card)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">258</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1660</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>

}

makeCard <span class="hljs-string">'Margrave'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">3</span>
  <span class="hljs-attribute">buys</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      state.drawCards(opp, <span class="hljs-number">1</span>)
      <span class="hljs-keyword">if</span> opp.hand.length &gt; <span class="hljs-number">3</span>
        state.requireDiscard(opp, opp.hand.length - <span class="hljs-number">3</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-number">685</span> <span class="hljs-keyword">else</span> <span class="hljs-number">280</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1560</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Masterpiece'</span>, treasure, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>

  <span class="hljs-attribute">buyEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    amountOverpayed = state.current.ai.chooseOverpayMasterpiece(state, state.current.coins)
    state.log(<span class="hljs-string">"overpaying for <span class="hljs-subst">#{amountOverpayed}</span> and gaining <span class="hljs-subst">#{amountOverpayed}</span> Silvers"</span>)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1</span> .. amountOverpayed]
      state.gainCard(state.current, c[<span class="hljs-string">'Silver'</span>], <span class="hljs-string">'discard'</span>, <span class="hljs-literal">true</span>)
}

makeCard <span class="hljs-string">"Militia"</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Militia is a straightforward example of an attack card.</p>
<p>All attack effects are wrapped in the <code>state.attackOpponents</code>
method, to give opponents a chance to play reaction cards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> opp.hand.length &gt; <span class="hljs-number">3</span>
        state.requireDiscard(opp, opp.hand.length - <span class="hljs-number">3</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">254</span>

}

makeCard <span class="hljs-string">"Goons"</span>, c.Militia, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">6</span>
  <span class="hljs-attribute">buys</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">buyInPlayEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span>
    state.log(<span class="hljs-string">"...getting +1 ▼."</span>)
    state.current.chips += <span class="hljs-number">1</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">278</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1280</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">"Minion"</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">discardAndDraw4</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span>
    state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> discards the hand."</span>)
    discarded = player.hand
    <span class="hljs-attribute">Array</span>::push.apply(player.discard, discarded)
    player.hand = []
    state.handleDiscards(player, discarded)
    <span class="hljs-keyword">return</span> state.drawCards(player, <span class="hljs-number">4</span>)

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    player = state.current
    <span class="hljs-keyword">if</span> player.ai.choose(<span class="hljs-string">'minionDiscard'</span>, state, [<span class="hljs-literal">yes</span>, <span class="hljs-literal">no</span>])
      c[<span class="hljs-string">'Minion'</span>].discardAndDraw4(state, player)
      state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
        c[<span class="hljs-string">'Minion'</span>].discardAndDraw4(state, opp)
    <span class="hljs-keyword">else</span>
      state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span> <span class="hljs-literal">null</span>
      player.coins += <span class="hljs-number">2</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-number">705</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1700</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">"Mountebank"</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> c.Curse <span class="hljs-keyword">in</span> opp.hand</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Discarding a Curse against Mountebank is automatic.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.doDiscard(opp, c.Curse)
      <span class="hljs-keyword">else</span>
        state.gainCard(opp, c.Copper)
        state.gainCard(opp, c.Curse)
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">290</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1870</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Because attacking on buy does not count as playing an Attack, Noble Brigand’s
buyEffect and playEffect cannot directly borrow from each other: the buyEffect
should not be blockable by Moat, so it cannot just call the playEffect, and
stat.attackOpponents needs an opp parameter, but buyEffect does not have an opp
parameter. So a third method is defined which takes both the state and opp as
parameters, and is accessed by both the buyEffect and the playEffect.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>makeCard <span class="hljs-string">'Noble Brigand'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">1</span>
  
  <span class="hljs-attribute">buyEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> opp <span class="hljs-keyword">in</span> state.players[<span class="hljs-number">1.</span>.]
      c[<span class="hljs-string">'Noble Brigand'</span>].robTheRich(state, opp)
    
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      c[<span class="hljs-string">'Noble Brigand'</span>].robTheRich(state, opp)
      
  <span class="hljs-attribute">robTheRich</span>: <span class="hljs-function"><span class="hljs-params">(state, opp)</span> -&gt;</span>
    drawn = opp.getCardsFromDeck(<span class="hljs-number">2</span>)
    state.log(<span class="hljs-string">"...<span class="hljs-subst">#{opp.ai}</span> reveals <span class="hljs-subst">#{drawn}</span>."</span>)
    silversAndGolds = []
    gainCopper = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> drawn
      <span class="hljs-keyword">if</span> card.isTreasure
        gainCopper = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">if</span> card <span class="hljs-keyword">is</span> c.Gold <span class="hljs-keyword">or</span> card <span class="hljs-keyword">is</span> c.Silver
          silversAndGolds.push(card)
    treasureToTrash = state.current.ai.choose(<span class="hljs-string">'trashOppTreasure'</span>, state, silversAndGolds)
    <span class="hljs-keyword">if</span> treasureToTrash
      state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> trashes <span class="hljs-subst">#{opp.ai}</span>'s <span class="hljs-subst">#{treasureToTrash}</span>."</span>)
      transferCard(treasureToTrash, drawn, state.trash)
      transferCard(treasureToTrash, state.trash, state.current.discard)
      state.handleGainCard(state.current, treasureToTrash, <span class="hljs-string">'discard'</span>)
      state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> gains the trashed <span class="hljs-subst">#{treasureToTrash}</span>."</span>)
    <span class="hljs-keyword">if</span> gainCopper
      state.gainCard(opp, c.Copper)
    opp.discard = opp.discard.concat(drawn)
    state.handleDiscards(opp, [drawn])
    state.log(<span class="hljs-string">"...<span class="hljs-subst">#{opp.ai}</span> discards <span class="hljs-subst">#{drawn}</span>."</span>)     

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">134</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1440</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Oracle'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    player = state.current
    myCards = state.getCardsFromDeck(player, <span class="hljs-number">2</span>)
    <span class="hljs-keyword">if</span> player.ai.oracleDiscardValue(state, myCards, player) &gt; <span class="hljs-number">0</span>
      state.log(<span class="hljs-string">"...discarding <span class="hljs-subst">#{myCards}</span>."</span>)
      <span class="hljs-attribute">Array</span>::push.apply(player.discard, myCards)
    <span class="hljs-keyword">else</span>
      state.log(<span class="hljs-string">"...keeping <span class="hljs-subst">#{myCards}</span> on top of the deck."</span>)
      <span class="hljs-attribute">Array</span>::unshift.apply(player.draw, myCards)
    
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      cards = state.getCardsFromDeck(opp, <span class="hljs-number">2</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Can’t use oracleDiscardValue because it’s a different situation, and
we don’t know what’s in the opponent’s hand.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      value = <span class="hljs-number">0</span>
      <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> cards
        value += player.ai.choiceToValue(<span class="hljs-string">'discardFromOpponentDeck'</span>, state, card)
      <span class="hljs-keyword">if</span> value &gt; <span class="hljs-number">0</span>
        state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> discards <span class="hljs-subst">#{cards}</span> from <span class="hljs-subst">#{opp.ai}</span>'s deck."</span>)
        <span class="hljs-attribute">Array</span>::push.apply(opp.discard, cards)
      <span class="hljs-keyword">else</span>
        state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> leaves <span class="hljs-subst">#{cards}</span> on <span class="hljs-subst">#{opp.ai}</span>'s deck."</span>)
        <span class="hljs-attribute">Array</span>::unshift.apply(opp.draw, cards)

    state.drawCards(player, <span class="hljs-number">2</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-number">610</span> <span class="hljs-keyword">else</span> <span class="hljs-number">180</span>

  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1200</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Pirate Ship'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>

  <span class="hljs-attribute">startGameEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> player <span class="hljs-keyword">in</span> state.players
      player.mats.pirateShip = <span class="hljs-number">0</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    choice = state.current.ai.choose(<span class="hljs-string">'pirateShip'</span>, state, [<span class="hljs-string">'coins'</span>,<span class="hljs-string">'attack'</span>])
    <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">is</span> <span class="hljs-string">'coins'</span>
      state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span> <span class="hljs-literal">null</span>
      state.current.coins += state.current.mats.pirateShip
      state.log(<span class="hljs-string">"...getting +$<span class="hljs-subst">#{state.current.mats.pirateShip}</span>."</span>)
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">is</span> <span class="hljs-string">'attack'</span>
      state.log(<span class="hljs-string">"...attacking the other players."</span>)
      attackSuccess = <span class="hljs-literal">false</span>

      state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
        drawn = opp.getCardsFromDeck(<span class="hljs-number">2</span>)
        state.log(<span class="hljs-string">"...<span class="hljs-subst">#{opp.ai}</span> reveals <span class="hljs-subst">#{drawn}</span>."</span>)
        drawnTreasures = []
        <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> drawn
          <span class="hljs-keyword">if</span> card.isTreasure
            drawnTreasures.push(card)
        treasureToTrash = state.current.ai.choose(<span class="hljs-string">'trashOppTreasure'</span>, state, drawnTreasures)
        <span class="hljs-keyword">if</span> treasureToTrash
          attackSuccess = <span class="hljs-literal">true</span>
          transferCard(treasureToTrash, drawn, state.trash)
          state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> trashes <span class="hljs-subst">#{opp.ai}</span>'s <span class="hljs-subst">#{treasureToTrash}</span>."</span>)
        opp.discard = opp.discard.concat(drawn)
        state.handleDiscards(opp, drawn)
        state.log(<span class="hljs-string">"...<span class="hljs-subst">#{opp.ai}</span> discards <span class="hljs-subst">#{drawn}</span>."</span>)
        
      <span class="hljs-keyword">if</span> attackSuccess
        state.current.mats.pirateShip += <span class="hljs-number">1</span>
        state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> takes a Coin token (<span class="hljs-subst">#{state.current.mats.pirateShip}</span> on the mat)."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">136</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1480</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Rabble'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">3</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      drawn = opp.getCardsFromDeck(<span class="hljs-number">3</span>)
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{opp.ai}</span> draws <span class="hljs-subst">#{drawn}</span>."</span>)

      <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> drawn
        <span class="hljs-keyword">if</span> card.isTreasure <span class="hljs-keyword">or</span> card.isAction
          opp.discard.push(card)
          state.log(<span class="hljs-string">"...discarding <span class="hljs-subst">#{card}</span>."</span>)
          state.handleDiscards(opp, [card])
        <span class="hljs-keyword">else</span>
          opp.setAside.push(card)
      
      <span class="hljs-keyword">if</span> opp.setAside.length &gt; <span class="hljs-number">0</span>
        order = opp.ai.chooseOrderOnDeck(state, opp.setAside, opp)
        state.log(<span class="hljs-string">"...putting <span class="hljs-subst">#{order}</span> back on the deck."</span>)
        opp.draw = order.concat(opp.draw)
        opp.setAside = []

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-number">680</span> <span class="hljs-keyword">else</span> <span class="hljs-number">206</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1600</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Rogue'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">2</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    my = state.current
    gainables = []
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.trash
      [coins, potions] = card.getCost(state)
      <span class="hljs-keyword">if</span> coins &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">and</span> coins &lt;= <span class="hljs-number">6</span> <span class="hljs-keyword">and</span> potions == <span class="hljs-number">0</span>
        gainables.push(card)
    <span class="hljs-keyword">if</span> gainables.length &gt; <span class="hljs-number">0</span>
      cardToGain = my.ai.choose(<span class="hljs-string">'rogueGain'</span>, state, gainables)
      state.supply[cardToGain] += <span class="hljs-number">1</span>
      state.trash.remove(cardToGain)
      state.gainCard(state.current, cardToGain, <span class="hljs-string">'discard'</span>, <span class="hljs-literal">true</span>)
      state.log(<span class="hljs-string">"...<span class="hljs-subst">#{my.ai}</span> gains <span class="hljs-subst">#{cardToGain}</span> from trash."</span>)
    <span class="hljs-keyword">else</span>
      state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
        drawn = opp.getCardsFromDeck(<span class="hljs-number">2</span>)
        state.log(<span class="hljs-string">"...<span class="hljs-subst">#{opp.ai}</span> reveals <span class="hljs-subst">#{drawn}</span>."</span>)
        drawnTrashables = []
        <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> drawn
          [coins, potions] = card.getCost(state)
          <span class="hljs-keyword">if</span> coins &gt;= <span class="hljs-number">3</span> <span class="hljs-keyword">and</span> coins &lt;= <span class="hljs-number">6</span>
            drawnTrashables.push(card)
        cardToTrash = opp.ai.choose(<span class="hljs-string">'rogueTrash'</span>, state, drawnTrashables)
        <span class="hljs-keyword">if</span> cardToTrash
          transferCard(cardToTrash, drawn, state.trash)
          state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> trashes <span class="hljs-subst">#{opp.ai}</span>'s <span class="hljs-subst">#{cardToTrash}</span>."</span>)
        opp.discard = opp.discard.concat(drawn)
        state.handleDiscards(opp, drawn)
        state.log(<span class="hljs-string">"...<span class="hljs-subst">#{opp.ai}</span> discards <span class="hljs-subst">#{drawn}</span>."</span>)
        
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">136</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1480</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Saboteur'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">upgradeFilter</span>: <span class="hljs-function"><span class="hljs-params">(state, oldCard, newCard)</span> -&gt;</span>
    [coins1, potions1] = oldCard.getCost(state)
    [coins2, potions2] = newCard.getCost(state)
    <span class="hljs-keyword">return</span> (potions1 &gt;= potions2) <span class="hljs-keyword">and</span> (coins1-<span class="hljs-number">2</span> &gt;= coins2)
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      drawn = opp.dig(state,
        <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span> card.getCost(state)[<span class="hljs-number">0</span>] &gt;= <span class="hljs-number">3</span>                      
      )
      <span class="hljs-keyword">if</span> drawn.length &gt; <span class="hljs-number">0</span>
        cardToTrash = drawn[<span class="hljs-number">0</span>]
        state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> trashes <span class="hljs-subst">#{opp.ai}</span>'s <span class="hljs-subst">#{cardToTrash}</span>."</span>)
        state.trash.push(drawn[<span class="hljs-number">0</span>])
        drawn[<span class="hljs-number">0</span>].trashEffect(state, state.current)
        choices = upgradeChoices(state, drawn, c.Saboteur.upgradeFilter)
        choices.push([cardToTrash,<span class="hljs-literal">null</span>])
        choice = opp.ai.choose(<span class="hljs-string">'upgrade'</span>, state, choices)
        newCard = choice[<span class="hljs-number">1</span>]
        <span class="hljs-keyword">if</span> newCard?
          state.gainCard(opp, newCard, <span class="hljs-string">'discard'</span>, <span class="hljs-literal">true</span>)
          state.log(<span class="hljs-string">"...<span class="hljs-subst">#{opp.ai}</span> gains <span class="hljs-subst">#{newCard}</span>."</span>)
        <span class="hljs-keyword">else</span>
          state.log(<span class="hljs-string">"...<span class="hljs-subst">#{opp.ai}</span> gains nothing."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">104</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1460</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Scrying Pool'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">costPotion</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    spyDecision(state.current, state.current, state, <span class="hljs-string">'scryingPoolDiscard'</span>)

    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      spyDecision(state.current, opp, state, <span class="hljs-string">'discardFromOpponentDeck'</span>)
    
    <span class="hljs-keyword">loop</span>
      drawn = state.drawCards(state.current, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
      <span class="hljs-keyword">break</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> drawn?) <span class="hljs-keyword">or</span> (<span class="hljs-keyword">not</span> drawn.isAction)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">870</span>
}

makeCard <span class="hljs-string">'Sea Hag'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      state.discardFromDeck(opp, <span class="hljs-number">1</span>)
      state.gainCard(opp, c.Curse, <span class="hljs-string">'draw'</span>)
      state.log(<span class="hljs-string">"...putting the Curse on top of the deck."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">286</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> state.countInSupply(<span class="hljs-string">'Curse'</span>) &gt;= <span class="hljs-number">2</span>
      <span class="hljs-number">1850</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Spy'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    spyDecision(state.current, state.current, state, <span class="hljs-string">'discard'</span>)

    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      spyDecision(state.current, opp, state, <span class="hljs-string">'discardFromOpponentDeck'</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">860</span>

}

makeCard <span class="hljs-string">'Thief'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      drawn = opp.getCardsFromDeck(<span class="hljs-number">2</span>)
      state.log(<span class="hljs-string">"...<span class="hljs-subst">#{opp.ai}</span> reveals <span class="hljs-subst">#{drawn}</span>."</span>)
      drawnTreasures = []
      <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> drawn
        <span class="hljs-keyword">if</span> card.isTreasure
          drawnTreasures.push(card)
      treasureToTrash = state.current.ai.choose(<span class="hljs-string">'trashOppTreasure'</span>, state, drawnTreasures)
      <span class="hljs-keyword">if</span> treasureToTrash
        state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> trashes <span class="hljs-subst">#{opp.ai}</span>'s <span class="hljs-subst">#{treasureToTrash}</span>."</span>)
        transferCard(treasureToTrash, drawn, state.trash)

        cardToGain = state.current.ai.chooseGain(state, [treasureToTrash, <span class="hljs-literal">null</span>])
        <span class="hljs-keyword">if</span> cardToGain
          transferCard(cardToGain, state.trash, state.current.discard)
          state.handleGainCard(state.current, cardToGain, <span class="hljs-string">'discard'</span>)
          state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> gains the trashed <span class="hljs-subst">#{treasureToTrash}</span>."</span>)
      opp.discard = opp.discard.concat(drawn)
      state.handleDiscards(opp, [drawn])
      state.log(<span class="hljs-string">"...<span class="hljs-subst">#{opp.ai}</span> discards <span class="hljs-subst">#{drawn}</span>."</span>)
  
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">100</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1420</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">"Torturer"</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">3</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> opp.ai.choose(<span class="hljs-string">'torturer'</span>, state, [<span class="hljs-string">'curse'</span>, <span class="hljs-string">'discard'</span>]) == <span class="hljs-string">'curse'</span>
        state.gainCard(opp, c.Curse, <span class="hljs-string">'hand'</span>)
      <span class="hljs-keyword">else</span>
        state.requireDiscard(opp, <span class="hljs-number">2</span>)
  
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-number">690</span> <span class="hljs-keyword">else</span> <span class="hljs-number">284</span>

  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> state.countInSupply(<span class="hljs-string">'Curse'</span>) &gt;= <span class="hljs-number">2</span>
      <span class="hljs-number">1840</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Witch'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      state.gainCard(opp, c.Curse)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-number">675</span> <span class="hljs-keyword">else</span> <span class="hljs-number">288</span>

  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> state.countInSupply(<span class="hljs-string">"Curse"</span>) &gt;= <span class="hljs-number">2</span>
      <span class="hljs-number">1860</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Young Witch'</span>, attack, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">2</span>

  <span class="hljs-attribute">startGameEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.cardState[<span class="hljs-keyword">this</span>] = cardState = {}

    cards = c.allCards
    nCards = cards.length
    bane = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Try random cards until we find a suitable bane</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">until</span> cardState.bane?
      bane = c[cards[Math.floor(Math.random() * nCards)]]
      <span class="hljs-keyword">if</span> (bane.cost == <span class="hljs-number">2</span> <span class="hljs-keyword">or</span> bane.cost == <span class="hljs-number">3</span>) <span class="hljs-keyword">and</span> bane.costPotion == <span class="hljs-number">0</span>
        <span class="hljs-keyword">unless</span> state.supply[bane]
          cardState.bane = bane</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Add the bane to the supply</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    state.supply[bane] = bane.startingSupply(state)</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Notify the new card that the game is starting</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    bane.startGameEffect(state)
    state.log(<span class="hljs-string">"Young Witch Bane card is <span class="hljs-subst">#{bane}</span>"</span>)

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    bane = state.cardState.bane
    state.requireDiscard(state.current, <span class="hljs-number">2</span>)
    state.attackOpponents <span class="hljs-function"><span class="hljs-params">(opp)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> bane <span class="hljs-keyword">in</span> opp.hand
        state.log(<span class="hljs-string">"<span class="hljs-subst">#{opp.ai}</span> is protected by the Bane card, <span class="hljs-subst">#{bane}</span>."</span>)
      <span class="hljs-keyword">else</span>
        state.gainCard(opp, c.Curse)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">282</span>    

  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> state.countInSupply(<span class="hljs-string">'Curse'</span>) &gt;= <span class="hljs-number">2</span>
      <span class="hljs-number">1830</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">1</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <h2 id="miscellaneous-cards">Miscellaneous cards</h2>

            </div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>All of these cards have effects beyond what can be expressed with a
simple formula, which are generally defined by overriding the complex
methods such as <code>playEffect</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
makeCard <span class="hljs-string">'Advisor'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    drawn = state.current.getCardsFromDeck(<span class="hljs-number">3</span>)
    state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> draws <span class="hljs-subst">#{drawn}</span>."</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Have the left-hand neighbor (or the AI itself in solitaire) choose a card
to discard. Borrow the Envoy AI code for this. It’s not quite right b/c 
Envoy is terminal, however.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    neighbor = state.players[<span class="hljs-number">1</span>] ? state.players[<span class="hljs-number">0</span>]
    choice = neighbor.ai.choose(<span class="hljs-string">'envoy'</span>, state, drawn)
    <span class="hljs-keyword">if</span> choice?
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{neighbor.ai}</span> chooses for <span class="hljs-subst">#{state.current.ai}</span> to discard <span class="hljs-subst">#{choice}</span>."</span>)
      transferCard(choice, drawn, state.current.discard)
      <span class="hljs-attribute">Array</span>::push.apply state.current.hand, drawn
    
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">1000</span>
}

makeCard <span class="hljs-string">'Adventurer'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">6</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    drawn = state.current.dig(state,
      <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span> card.isTreasure,
      <span class="hljs-number">2</span>
    )
    <span class="hljs-keyword">if</span> drawn.length &gt; <span class="hljs-number">0</span>
      treasures = drawn
      state.current.hand = state.current.hand.concat(treasures)
      state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> draws <span class="hljs-subst">#{treasures}</span>."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">176</span>
}

makeCard <span class="hljs-string">'Alchemist'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">costPotion</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">2</span>

  <span class="hljs-attribute">cleanupEffect</span>:
    <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> c.Potion <span class="hljs-keyword">in</span> state.current.inPlay <span class="hljs-keyword">and</span> c.Alchemist <span class="hljs-keyword">in</span> state.current.inPlay
        transferCardToTop(c.Alchemist, state.current.inPlay, state.current.draw)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">785</span>
}

makeCard <span class="hljs-string">'Apothecary'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">costPotion</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    drawn = state.getCardsFromDeck(state.current, <span class="hljs-number">4</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Sort the cards into coppers and potions, which go to the hand,
and others, which go temporarily to the setAside pile.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    state.log(<span class="hljs-string">"...drawing <span class="hljs-subst">#{drawn}</span>."</span>)
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> drawn
      <span class="hljs-keyword">if</span> card <span class="hljs-keyword">is</span> c.Copper <span class="hljs-keyword">or</span> card <span class="hljs-keyword">is</span> c.Potion
        state.current.hand.push(card)
        state.log(<span class="hljs-string">"...putting <span class="hljs-subst">#{card}</span> in the hand."</span>)
      <span class="hljs-keyword">else</span>
        state.current.setAside.push(card)
    
    <span class="hljs-keyword">if</span> state.current.setAside.length &gt; <span class="hljs-number">0</span>
      order = state.current.ai.chooseOrderOnDeck(state, state.current.setAside, state.current)
      state.log(<span class="hljs-string">"...putting <span class="hljs-subst">#{order}</span> back on the deck."</span>)
      state.current.draw = order.concat(state.current.draw)
      state.current.setAside = []

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">880</span>
}

makeCard <span class="hljs-string">'Apprentice'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    toTrash = state.current.ai.choose(<span class="hljs-string">'apprenticeTrash'</span>, state, state.current.hand)
    <span class="hljs-keyword">if</span> toTrash?
      [coins, potions] = toTrash.getCost(state)
      state.doTrash(state.current, toTrash)
      state.drawCards(state.current, coins+<span class="hljs-number">2</span>*potions)
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">730</span>
}

makeCard <span class="hljs-string">'Baker'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">cards</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">coinTokens</span>: <span class="hljs-number">1</span>
  
  <span class="hljs-attribute">startGameEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> player <span class="hljs-keyword">in</span> state.players
      player.coinTokens += <span class="hljs-number">1</span>
  
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">774</span>
}

makeCard <span class="hljs-string">'Bandit Camp'</span>, c.Village, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.gainCard(state.current, c.Spoils)
    
  <span class="hljs-attribute">startGameEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.specialSupply[<span class="hljs-string">'Spoils'</span>] = <span class="hljs-number">15</span>
    
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">821</span>
  
}

makeCard <span class="hljs-string">'Baron'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">buys</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    discardEstate = <span class="hljs-literal">no</span>
    <span class="hljs-keyword">if</span> c.Estate <span class="hljs-keyword">in</span> state.current.hand
      discardEstate = state.current.ai.choose(<span class="hljs-string">'baronDiscard'</span>, state, [<span class="hljs-literal">yes</span>, <span class="hljs-literal">no</span>])
    <span class="hljs-keyword">if</span> discardEstate
      state.doDiscard(state.current, c.Estate)
      state.current.coins += <span class="hljs-number">4</span>
    <span class="hljs-keyword">else</span>
      state.gainCard(state.current, c.Estate)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> c.Estate <span class="hljs-keyword">in</span> my.hand
      <span class="hljs-number">184</span>
    <span class="hljs-keyword">else</span> 
      <span class="hljs-keyword">if</span> my.ai.cardInDeckValue(state, c.Estate, my) &gt; <span class="hljs-number">0</span>
        <span class="hljs-number">5</span>
      <span class="hljs-keyword">else</span>
        -<span class="hljs-number">5</span>
}

makeCard <span class="hljs-string">'Beggar'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">isReaction</span>: <span class="hljs-literal">true</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.gainCard(state.current, c.Copper, <span class="hljs-string">'hand'</span>)
    state.gainCard(state.current, c.Copper, <span class="hljs-string">'hand'</span>)
    state.gainCard(state.current, c.Copper, <span class="hljs-string">'hand'</span>)

  <span class="hljs-attribute">reactToAttack</span>: <span class="hljs-function"><span class="hljs-params">(state, player, attackEvent)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> player.ai.wantsToDiscardBeggar(state, player)
      state.doDiscard(player, c.Beggar)
      state.gainCard(player, c.Silver, <span class="hljs-string">'draw'</span>)
      state.gainCard(player, c.Silver, <span class="hljs-string">'draw'</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">243</span>
}

makeCard <span class="hljs-string">'Bishop'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    toTrash = state.current.ai.choose(<span class="hljs-string">'bishopTrash'</span>, state, state.current.hand)
    state.current.chips += <span class="hljs-number">1</span>
    state.log(<span class="hljs-string">"...gaining 1 VP."</span>)
    <span class="hljs-keyword">if</span> toTrash?
      state.doTrash(state.current, toTrash)
      [coins, potions] = toTrash.getCost(state)
      vp = Math.floor(coins/<span class="hljs-number">2</span>)
      state.log(<span class="hljs-string">"...gaining <span class="hljs-subst">#{vp}</span> VP."</span>)
      state.current.chips += vp

    <span class="hljs-keyword">for</span> opp <span class="hljs-keyword">in</span> state.players[<span class="hljs-number">1.</span>..]
      state.allowTrash(opp, <span class="hljs-number">1</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">243</span>
}

makeCard <span class="hljs-string">'Border Village'</span>, c.Village, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">6</span>

  <span class="hljs-attribute">gainEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span>
    choices = []
    [myCoins, myPotions] = c[<span class="hljs-string">'Border Village'</span>].getCost(state)
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">of</span> state.supply
      <span class="hljs-keyword">if</span> state.supply[card] &gt; <span class="hljs-number">0</span>
        [coins, potions] = c[card].getCost(state)
        <span class="hljs-keyword">if</span> potions &lt;= myPotions <span class="hljs-keyword">and</span> coins &lt; myCoins
          choices.push(c[card])
    state.gainOneOf(player, choices)
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">817</span>
}

makeCard <span class="hljs-string">'Bridge'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.costModifiers.push
      <span class="hljs-attribute">source</span>: <span class="hljs-keyword">this</span>
      <span class="hljs-attribute">modify</span>: <span class="hljs-function"><span class="hljs-params">(card)</span> -&gt;</span> -<span class="hljs-number">1</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">246</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1720</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Cartographer'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    player = state.current
    revealed = player.getCardsFromDeck(<span class="hljs-number">4</span>)
    kept = []
    state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> reveals <span class="hljs-subst">#{revealed}</span> from the deck."</span>)
    <span class="hljs-keyword">while</span> revealed.length
      card = revealed.pop()
      <span class="hljs-keyword">if</span> player.ai.choose(<span class="hljs-string">'discard'</span>, state, [card, <span class="hljs-literal">null</span>])
        state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> discards <span class="hljs-subst">#{card}</span>."</span>)
        player.discard.push(card)
        state.handleDiscards(player, [card])
      <span class="hljs-keyword">else</span>
        kept.push(card)
    order = player.ai.chooseOrderOnDeck(state, kept, player)
    state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> puts <span class="hljs-subst">#{order}</span> back on the deck."</span>)
    player.draw = order.concat(player.draw)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">890</span>

}

makeCard <span class="hljs-string">'Cellar'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    startingCards = state.current.hand.length
    state.allowDiscard(state.current, Infinity)
    numDiscarded = startingCards - state.current.hand.length
    state.drawCards(state.current, numDiscarded)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">450</span>
}

makeCard <span class="hljs-string">'Chancellor'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">2</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    player = state.current</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>The AI has the option of reshuffling. Ask directly if it’ll take it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> player.ai.choose(<span class="hljs-string">'reshuffle'</span>, state, [<span class="hljs-literal">yes</span>, <span class="hljs-literal">no</span>])
      state.log(<span class="hljs-string">"...putting the draw pile into the discard pile."</span>)
      draw = player.draw.slice(<span class="hljs-number">0</span>)
      player.draw = []
      player.discard = player.discard.concat(draw)
      state.handleDiscards(state.current, draw)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">160</span>

}

makeCard <span class="hljs-string">'Chapel'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">playEffect</span>:
    <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
      state.allowTrash(state.current, <span class="hljs-number">4</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    wantsToTrash = my.ai.wantsToTrash(state)
    <span class="hljs-keyword">if</span> wantsToTrash &gt; <span class="hljs-number">0</span>
      <span class="hljs-number">146</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">30</span>
}

makeCard <span class="hljs-string">'City'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>
  
  <span class="hljs-attribute">getCards</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.numEmptyPiles() &gt;= <span class="hljs-number">1</span>
      <span class="hljs-number">2</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">1</span>
  
  <span class="hljs-attribute">getBuys</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.numEmptyPiles() &gt;= <span class="hljs-number">2</span>
      <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">0</span>
  
  <span class="hljs-attribute">getCoins</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.numEmptyPiles() &gt;= <span class="hljs-number">2</span>
      <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">0</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">829</span>
}

makeCard <span class="hljs-string">'Conspirator'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>don’t count Duration cards because they’re not “played this turn”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getActions</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.current.actionsPlayed &gt;= <span class="hljs-number">3</span>
      <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">0</span>
  <span class="hljs-attribute">getCards</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.current.actionsPlayed &gt;= <span class="hljs-number">3</span>
      <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">0</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.inPlay.length &gt;= <span class="hljs-number">2</span> <span class="hljs-keyword">or</span> my.getCurrentAction()?.isMultiplier
      <span class="hljs-number">760</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> my.actions &lt; <span class="hljs-number">2</span>
      <span class="hljs-number">124</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">10</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">1380</span>
}

makeCard <span class="hljs-string">'Coppersmith'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">playEffect</span>:
    <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
      state.copperValue += <span class="hljs-number">1</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">switch</span> my.countInHand(<span class="hljs-string">"Copper"</span>)
      <span class="hljs-keyword">when</span> <span class="hljs-number">0</span>, <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-number">105</span>
      <span class="hljs-keyword">when</span> <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-number">156</span>
      <span class="hljs-keyword">else</span> <span class="hljs-number">213</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> my.countInHand(<span class="hljs-string">'Copper'</span>) &gt;= <span class="hljs-number">2</span>
      <span class="hljs-number">1140</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Council Room'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">cards</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> opp <span class="hljs-keyword">in</span> state.players[<span class="hljs-number">1.</span>..]
      state.drawCards(opp, <span class="hljs-number">1</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">619</span> <span class="hljs-keyword">else</span> <span class="hljs-number">194</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1580</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Counting House'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    coppersFromDiscard = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.discard <span class="hljs-keyword">when</span> card==c.Copper)
    state.current.discard = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.discard <span class="hljs-keyword">when</span> card!=c.Copper)
    <span class="hljs-attribute">Array</span>::push.apply state.current.hand, coppersFromDiscard
    state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> puts "</span> + coppersFromDiscard.length + <span class="hljs-string">" Coppers into his hand."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">158</span>

}

makeCard <span class="hljs-string">'Courtyard'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">cards</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.current.hand.length &gt; <span class="hljs-number">0</span>
      card = state.current.ai.choose(<span class="hljs-string">'putOnDeck'</span>, state, state.current.hand)
      state.doPutOnDeck(state.current, card)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (my.discard.length + my.draw.length) &lt;= <span class="hljs-number">3</span>
      <span class="hljs-keyword">return</span> <span class="hljs-number">615</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> <span class="hljs-number">188</span>
}

makeCard <span class="hljs-string">'Crossroads'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.current.countInPlay(<span class="hljs-string">'Crossroads'</span>) == <span class="hljs-number">1</span>
      state.current.actions += <span class="hljs-number">3</span></pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>shortcut, because it doesn’t particularly matter whether just the
victory cards are revealed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    state.revealHand(state.current)

    nVictory = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.hand <span class="hljs-keyword">when</span> card.isVictory).length
    state.drawCards(state.current, nVictory)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>FIXME: This represents a particularly dumb strategy. It doesn’t even take
into account whether it has any victory cards, or whether it could draw
more.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> my.countInPlay(state.cardInfo.Crossroads) &gt; <span class="hljs-number">0</span>
      <span class="hljs-keyword">return</span> <span class="hljs-number">298</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> <span class="hljs-number">580</span>

  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> my.countInPlay(c.Crossroads) == <span class="hljs-number">0</span>
      <span class="hljs-number">1800</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Duchess'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">2</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> pl <span class="hljs-keyword">in</span> state.players
      drawn = state.getCardsFromDeck(pl, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{pl.ai}</span> reveals <span class="hljs-subst">#{drawn}</span>."</span>)
      <span class="hljs-keyword">if</span> drawn?
        discarded = pl.ai.choose(<span class="hljs-string">'discard'</span>, state, [drawn, <span class="hljs-literal">null</span>])
        <span class="hljs-keyword">if</span> discarded?
          state.log(<span class="hljs-string">"...choosing to discard it."</span>)
          pl.discard.push(drawn)
        <span class="hljs-keyword">else</span>
          state.log(<span class="hljs-string">"...choosing to put it back."</span>)
          pl.draw.unshift(drawn)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">102</span>
}

makeCard <span class="hljs-string">'Embassy'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">5</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.requireDiscard(state.current, <span class="hljs-number">3</span>)
    
  <span class="hljs-attribute">gainEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> pl <span class="hljs-keyword">in</span> state.players
      <span class="hljs-keyword">if</span> pl <span class="hljs-keyword">isnt</span> player
        state.gainCard(pl, c.Silver)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-number">660</span> <span class="hljs-keyword">else</span> <span class="hljs-number">198</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1520</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Envoy'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    drawn = state.current.getCardsFromDeck(<span class="hljs-number">5</span>)
    state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> draws <span class="hljs-subst">#{drawn}</span>."</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Have the left-hand neighbor (or the AI itself in solitaire) choose a card
to discard.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    neighbor = state.players[<span class="hljs-number">1</span>] ? state.players[<span class="hljs-number">0</span>]
    choice = neighbor.ai.choose(<span class="hljs-string">'envoy'</span>, state, drawn)
    <span class="hljs-keyword">if</span> choice?
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{neighbor.ai}</span> chooses for <span class="hljs-subst">#{state.current.ai}</span> to discard <span class="hljs-subst">#{choice}</span>."</span>)
      transferCard(choice, drawn, state.current.discard)
      <span class="hljs-attribute">Array</span>::push.apply state.current.hand, drawn

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">203</span>
}

makeCard <span class="hljs-string">'Explorer'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    cardToGain = c.Silver

    <span class="hljs-keyword">if</span> c.Province <span class="hljs-keyword">in</span> state.current.hand
      state.log(<span class="hljs-string">"…revealing a Province."</span>)
      cardToGain = c.Gold

    <span class="hljs-keyword">if</span> state.countInSupply(cardToGain) &gt; <span class="hljs-number">0</span>
      state.gainCard(state.current, cardToGain, <span class="hljs-string">'hand'</span>, <span class="hljs-literal">true</span>)
      state.log(<span class="hljs-string">"…and gaining a <span class="hljs-subst">#{cardToGain}</span>, putting it in the hand."</span>)
    <span class="hljs-keyword">else</span>
      state.log(<span class="hljs-string">"…but there are no <span class="hljs-subst">#{cardToGain}</span>s available to gain."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.countInHand(<span class="hljs-string">"Province"</span>) &gt; <span class="hljs-number">1</span>
      <span class="hljs-number">282</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">166</span>
}

makeCard <span class="hljs-string">'Farming Village'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    drawn = state.current.dig(state,
      <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span> card.isAction <span class="hljs-keyword">or</span> card.isTreasure
    )
    <span class="hljs-keyword">if</span> drawn.length &gt; <span class="hljs-number">0</span>
      card = drawn[<span class="hljs-number">0</span>]
      state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> draws <span class="hljs-subst">#{card}</span>."</span>)
      state.current.hand.push(card)
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">838</span>
}

makeCard <span class="hljs-string">"Feast"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Trash the Feast, unless it’s already been trashed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> state.current.playLocation != <span class="hljs-string">'trash'</span>
      transferCard(c.Feast, state.current[state.current.playLocation], state.trash)
      state.current.playLocation = <span class="hljs-string">'trash'</span>
      state.log(<span class="hljs-string">"...trashing the Feast."</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Gain a card costing up to $5.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    choices = []
    <span class="hljs-keyword">for</span> cardName <span class="hljs-keyword">of</span> state.supply
      card = c[cardName]
      [coins, potions] = card.getCost(state)
      <span class="hljs-keyword">if</span> potions == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> coins &lt;= <span class="hljs-number">5</span>
        choices.push(card)
    state.gainOneOf(state.current, choices)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">108</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1390</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Golem'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">costPotion</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    drawn = state.current.dig(state,
      <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span> card.isAction <span class="hljs-keyword">and</span> card.name <span class="hljs-keyword">isnt</span> <span class="hljs-string">'Golem'</span>,
      <span class="hljs-number">2</span>
    )
    <span class="hljs-keyword">if</span> drawn.length &gt; <span class="hljs-number">0</span>
      firstAction = state.current.ai.choose(<span class="hljs-string">'play'</span>, state, drawn)
      drawn.remove(firstAction)
      secondAction = drawn[<span class="hljs-number">0</span>]
      actions = [firstAction, secondAction]
      <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> actions
        <span class="hljs-keyword">if</span> card?
          state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> plays <span class="hljs-subst">#{card}</span>."</span>)
          state.current.inPlay.push(card)
          state.current.playLocation = <span class="hljs-string">'inPlay'</span>
          state.resolveAction(card)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">743</span>
}

makeCard <span class="hljs-string">"Grand Market"</span>, c.Market, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">6</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">cards</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Grand Market is the only card with a non-constant mayBeBought value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">mayBeBought</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">not</span>(c.Copper <span class="hljs-keyword">in</span> state.current.inPlay)
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">795</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">880</span>
}

makeCard <span class="hljs-string">'Haggler'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">2</span>  
  <span class="hljs-attribute">buyInPlayEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, card1)</span> -&gt;</span>
    [coins1, potions1] = card1.getCost(state)
    choices = []
    <span class="hljs-keyword">for</span> cardName <span class="hljs-keyword">of</span> state.supply
      card2 = c[cardName]
      [coins2, potions2] = card2.getCost(state)
      <span class="hljs-keyword">if</span> (potions2 &lt;= potions1) <span class="hljs-keyword">and</span> (coins2 &lt; coins1) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> card2.isVictory
        choices.push(card2)
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (potions2 &lt; potions1) <span class="hljs-keyword">and</span> (coins2 == coins1) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> card2.isVictory
        choices.push(card2)        
    state.gainOneOf(state.current, choices)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">170</span>

}

makeCard <span class="hljs-string">"Hamlet"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    player = state.current</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>We take a bit of a shortcut for now: we discard up to two cards, then if only
one was discarded, decide whether to use it for +action or +buy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    discarded = state.allowDiscard(player, <span class="hljs-number">2</span>)
    <span class="hljs-keyword">if</span> discarded.length == <span class="hljs-number">2</span>
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> gets +1 action and +1 buy."</span>)
      player.actions++
      player.buys++
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> discarded.length == <span class="hljs-number">1</span>
      benefit = player.ai.choose(<span class="hljs-string">'benefit'</span>, state, [
        {<span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>},
        {<span class="hljs-attribute">cards</span>: <span class="hljs-number">1</span>}
      ])
      applyBenefit(state, benefit)
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">720</span>
}

makeCard <span class="hljs-string">"Harvest"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    unique = []
    cards = state.discardFromDeck(state.current, <span class="hljs-number">4</span>)
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> cards
      <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> unique
        unique.push(card)
    state.current.coins += unique.length
    state.log(<span class="hljs-string">"...gaining +$<span class="hljs-subst">#{unique.length}</span>."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">174</span>
}

makeCard <span class="hljs-string">"Herbalist"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">buys</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">cleanupEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    choices = []
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.inPlay
      <span class="hljs-keyword">if</span> card.isTreasure
        choices.push(card)
    choices.push(<span class="hljs-literal">null</span>)
    choice = state.current.ai.choose(<span class="hljs-string">'herbalist'</span>, state, choices)
    <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> uses Herbalist to put <span class="hljs-subst">#{choice}</span> back on the deck."</span>)
      transferCardToTop(choice, state.current.inPlay, state.current.draw)
      
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">122</span>
}

makeCard <span class="hljs-string">"Highway"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>
  
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.costModifiers.push
      <span class="hljs-attribute">source</span>: <span class="hljs-keyword">this</span>
      <span class="hljs-attribute">modify</span>: <span class="hljs-function"><span class="hljs-params">(card)</span> -&gt;</span> -<span class="hljs-number">1</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">750</span>
}

makeCard <span class="hljs-string">"Horse Traders"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">buys</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">3</span>
  <span class="hljs-attribute">isReaction</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">playEffect</span>:
    <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> state.requireDiscard(state.current, <span class="hljs-number">2</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Horse Traders is not actually a duration card, but it resolves like one
when it is set aside. There seems to be no harm in simplifying by
putting it in the duration area.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">durationEffect</span>:
    <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Pick up Horse Traders and draw another card.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transferCard(c[<span class="hljs-string">'Horse Traders'</span>], state.current.duration, state.current.hand)
      state.drawCards(state.current, <span class="hljs-number">1</span>)
  
  <span class="hljs-attribute">reactToAttack</span>:
    <span class="hljs-function"><span class="hljs-params">(state, player, attackEvent)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> c[<span class="hljs-string">'Horse Traders'</span>] <span class="hljs-keyword">in</span> player.hand
        transferCard(c[<span class="hljs-string">'Horse Traders'</span>], player.hand, player.duration)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">240</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1640</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>

}</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>So far Hunting Party is the only card that digs for something 
dependent on the game state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>makeCard <span class="hljs-string">'Hunting Party'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.revealHand(state.current)    
    drawn = state.current.dig(state,
      <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> state.current.hand
    )
    <span class="hljs-keyword">if</span> drawn.length &gt; <span class="hljs-number">0</span>
      card = drawn[<span class="hljs-number">0</span>]
      state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> draws <span class="hljs-subst">#{card}</span>."</span>)
      state.current.hand.push(card)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">790</span>
}


makeCard <span class="hljs-string">'Hunting Grounds'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">6</span>
  <span class="hljs-attribute">cards</span>: <span class="hljs-number">4</span>
  
  <span class="hljs-attribute">trashEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span>
    choice = player.ai.choose(<span class="hljs-string">'huntingGroundsGain'</span>, state, [<span class="hljs-string">"Estates"</span>, <span class="hljs-string">"Duchy"</span>])
    <span class="hljs-keyword">if</span> choice == <span class="hljs-string">"Estates"</span>
      state.gainCard(player, c.Estate)
      state.gainCard(player, c.Estate)
      state.gainCard(player, c.Estate)
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> choice == <span class="hljs-string">"Duchy"</span>
      state.gainCard(player, c.Duchy)
    <span class="hljs-keyword">else</span>
      state.log(<span class="hljs-string">"Invalid choice for HuntingGroundsGain: <span class="hljs-subst">#{choice}</span>!"</span>)
      state.gainCard(player, c.Duchy)
  
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-number">666</span> <span class="hljs-keyword">else</span> <span class="hljs-number">201</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1542</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Ironworks'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    choices = []
    <span class="hljs-keyword">for</span> cardName, count <span class="hljs-keyword">of</span> state.supply
      card = c[cardName]
      [coins, potions] = card.getCost(state)
      <span class="hljs-keyword">if</span> potions == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> coins &lt;= <span class="hljs-number">4</span> <span class="hljs-keyword">and</span> count &gt; <span class="hljs-number">0</span>
        choices.push(card)
    gained = state.gainOneOf(state.current, choices)

    <span class="hljs-keyword">if</span> gained <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
      <span class="hljs-keyword">if</span> gained.isAction
        state.current.actions += <span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> gained.isTreasure
        state.current.coins += <span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> gained.isVictory
        state.current.drawCards(<span class="hljs-number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>FIXME: The current ai_playValue assumes that Ironworks is a terminal.
If it wants to gain an action, it should have a higher value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">115</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Jack of All Trades is a complex card made up of steps that are simple
to code:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>makeCard <span class="hljs-string">'Jack of All Trades'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Gain a silver.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    state.gainCard(state.current, c.Silver)</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Look at the top card of your deck…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    card = state.current.getCardsFromDeck(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>discard it or put it back.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> card?
      <span class="hljs-keyword">if</span> state.current.ai.choose(<span class="hljs-string">'discard'</span>, state, [card, <span class="hljs-literal">null</span>])
        state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> reveals and discards <span class="hljs-subst">#{card}</span>."</span>)
        state.current.discard.push(card)
      <span class="hljs-keyword">else</span>
        state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> reveals <span class="hljs-subst">#{card}</span> and puts it back."</span>)
        state.current.draw.unshift(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>Draw until you have 5 cards in hand.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> state.current.hand.length &lt; <span class="hljs-number">5</span>
      state.drawCards(state.current, <span class="hljs-number">5</span> - state.current.hand.length)</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>You may trash a card from your hand that is not a Treasure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    choices = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.hand <span class="hljs-keyword">when</span> <span class="hljs-keyword">not</span> card.isTreasure)
    choices.push(<span class="hljs-literal">null</span>)
    choice = state.current.ai.choose(<span class="hljs-string">'trash'</span>, state, choices)
    <span class="hljs-keyword">if</span> choice?
      state.doTrash(state.current, choice)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">236</span>
}

makeCard <span class="hljs-string">'Journeyman'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    unique = []
    deck = state.current.getDeck()
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> deck
      <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> unique
        unique.push(card)
    choices = unique
    choice = state.current.ai.choose(<span class="hljs-string">'skip'</span>, state, choices)
    my = state.current
    drawn = state.current.dig(state,
      <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span> <span class="hljs-keyword">return</span> card != choice,
      <span class="hljs-number">3</span>
    )

    <span class="hljs-keyword">if</span> drawn.length &gt; <span class="hljs-number">0</span>
      newcards = drawn
      state.current.hand = state.current.hand.concat(newcards)
      state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> draws <span class="hljs-subst">#{newcards}</span>."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    wantsToJM = my.ai.wantsToJM(state, my)
    <span class="hljs-keyword">if</span> wantsToJM &gt; <span class="hljs-number">0</span>
      <span class="hljs-number">146</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">0</span>
}

makeCard <span class="hljs-string">"King's Court"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">7</span>
  <span class="hljs-attribute">isMultiplier</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">multiplier</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">optional</span>: <span class="hljs-literal">true</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    choices = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.hand <span class="hljs-keyword">when</span> card.isAction)
    <span class="hljs-keyword">if</span> choices.length == <span class="hljs-number">0</span>
      state.log(<span class="hljs-string">"...but has no action to play with the <span class="hljs-subst">#{<span class="hljs-keyword">this</span>}</span>."</span>)
    <span class="hljs-keyword">else</span>
      choices.push(<span class="hljs-literal">null</span>) <span class="hljs-keyword">if</span> <span class="hljs-property">@optional</span>
      chosenAction = state.current.ai.choose(<span class="hljs-string">'multiplied'</span>, state, choices)
      <span class="hljs-keyword">if</span> chosenAction <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
        state.log(<span class="hljs-string">"...choosing not to play an action."</span>)
      <span class="hljs-keyword">else</span>
        transferCard(chosenAction, state.current.hand, state.current.inPlay)

        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@multiplier</span>]
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> chosenAction <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
          state.log(<span class="hljs-string">"...playing <span class="hljs-subst">#{chosenAction}</span> (<span class="hljs-subst">#{i+<span class="hljs-number">1</span>}</span> of <span class="hljs-subst">#{<span class="hljs-property">@multiplier</span>}</span>)."</span>)
          state.resolveAction(chosenAction)</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>Determine whether this multiplier is going to go to the duration area
during the cleanup phase.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        putInDuration = <span class="hljs-literal">false</span>
        neverPutInDuration = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>If we’ve already marked a multiplier to be put in the Duration area,
don’t mark this one. It’s either already marked or it’s not needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        md = state.current.multipliedDurations
        <span class="hljs-keyword">if</span> md.length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> md[md.length - <span class="hljs-number">1</span>].isMultiplier
          neverPutInDuration = <span class="hljs-literal">true</span>

        <span class="hljs-keyword">unless</span> neverPutInDuration
          <span class="hljs-keyword">if</span> chosenAction.isMultiplier</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Mark the multiplier as if it were a multiplied Duration, which is
a flag to not clean it up (as if it were a Duration) later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> md.length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (md[md.length - <span class="hljs-number">1</span>].isMultiplier)
              putInDuration = <span class="hljs-literal">true</span>
          <span class="hljs-keyword">if</span> chosenAction.isDuration <span class="hljs-keyword">and</span> chosenAction.name != <span class="hljs-string">'Tactician'</span>
            putInDuration = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Store virtual copies of a multiplied duration card in <code>multipliedDurations</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@multiplier</span>-<span class="hljs-number">1</span>]
              md.push(chosenAction)
        
        <span class="hljs-keyword">if</span> putInDuration</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>Mark it by putting it in multipliedDurations. This also signals that
all multiplied duration cards previous to it are accounted for.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          md.push(<span class="hljs-keyword">this</span>)

  <span class="hljs-attribute">durationEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>TR and KC don’t actually have a duration effect. The multiplication of
of the Duration card has already happened, possibly more than once, and
the number of times it happens is not strictly related to the number of
multipliers in the duration area. It took a very long BGG thread to
figure this out.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.ai.wantsToPlayMultiplier(state) <span class="hljs-keyword">then</span> <span class="hljs-number">910</span> <span class="hljs-keyword">else</span> <span class="hljs-number">390</span>

  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">2000</span>
}

makeCard <span class="hljs-string">"Library"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    player = state.current
    <span class="hljs-keyword">while</span> player.hand.length &lt; <span class="hljs-number">7</span>
      drawn = player.getCardsFromDeck(<span class="hljs-number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>If nothing was drawn, the deck and discard pile are empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> drawn.length == <span class="hljs-number">0</span>
        state.log(<span class="hljs-string">"...stopping because there are no cards to draw."</span>)
        <span class="hljs-keyword">break</span>

      card = drawn[<span class="hljs-number">0</span>]
      <span class="hljs-keyword">if</span> card.isAction</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Assume the times the AI wants to set the card aside are the times it
is on the discard priority list or has a positive discard value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> player.ai.choose(<span class="hljs-string">'discard'</span>, state, [card, <span class="hljs-literal">null</span>])
          state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> sets aside a <span class="hljs-subst">#{card}</span>."</span>)
          player.setAside.push(card)
        <span class="hljs-keyword">else</span>
          state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> draws a <span class="hljs-subst">#{card}</span> and chooses to keep it."</span>)
          player.hand.push(card)
      <span class="hljs-keyword">else</span>
        state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> draws a <span class="hljs-subst">#{card}</span>."</span>)
        player.hand.push(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Discard the set-aside cards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    discards = player.setAside
    player.discard = player.discard.concat(discards)
    player.setAside = []
    state.handleDiscards(state.current, discards)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span>
      <span class="hljs-keyword">switch</span> my.hand.length
        <span class="hljs-keyword">when</span> <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-number">955</span>
        <span class="hljs-keyword">when</span> <span class="hljs-number">4</span> <span class="hljs-keyword">then</span> <span class="hljs-number">695</span>
        <span class="hljs-keyword">when</span> <span class="hljs-number">5</span> <span class="hljs-keyword">then</span> <span class="hljs-number">620</span>
        <span class="hljs-keyword">when</span> <span class="hljs-number">6</span> <span class="hljs-keyword">then</span> <span class="hljs-number">420</span>
        <span class="hljs-keyword">when</span> <span class="hljs-number">7</span> <span class="hljs-keyword">then</span> <span class="hljs-number">101</span>
        <span class="hljs-keyword">else</span> <span class="hljs-number">20</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">switch</span> my.hand.length
        <span class="hljs-keyword">when</span> <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-number">260</span>
        <span class="hljs-keyword">when</span> <span class="hljs-number">4</span> <span class="hljs-keyword">then</span> <span class="hljs-number">210</span>
        <span class="hljs-keyword">when</span> <span class="hljs-number">5</span> <span class="hljs-keyword">then</span> <span class="hljs-number">192</span>
        <span class="hljs-keyword">when</span> <span class="hljs-number">6</span> <span class="hljs-keyword">then</span> <span class="hljs-number">118</span>
        <span class="hljs-keyword">when</span> <span class="hljs-number">7</span> <span class="hljs-keyword">then</span> <span class="hljs-number">101</span>
        <span class="hljs-keyword">else</span> <span class="hljs-number">20</span>

}

makeCard <span class="hljs-string">"Lookout"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    drawn = state.getCardsFromDeck(state.current, <span class="hljs-number">3</span>)
    state.log(<span class="hljs-string">"...drawing <span class="hljs-subst">#{drawn}</span>."</span>)
    state.current.setAside = drawn
    trash = state.current.ai.choose(<span class="hljs-string">'trash'</span>, state, drawn)
    <span class="hljs-keyword">if</span> trash <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>Trash the card, with the side effect of removing it from the choice
list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      state.log(<span class="hljs-string">"...trashing <span class="hljs-subst">#{trash}</span>."</span>)
      transferCard(trash, state.current.setAside, state.trash)
    
    discard = state.current.ai.choose(<span class="hljs-string">'discard'</span>, state, drawn)
    <span class="hljs-keyword">if</span> discard <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
      transferCard(discard, state.current.setAside, state.current.discard)
      state.log(<span class="hljs-string">"...discarding <span class="hljs-subst">#{discard}</span>."</span>)
      state.handleDiscards(state.current, [discard])</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Put the remaining card back on the deck.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    state.log(<span class="hljs-string">"...putting <span class="hljs-subst">#{drawn}</span> back on the deck."</span>)
    state.current.draw = state.current.setAside.concat(state.current.draw)
    state.current.setAside = []

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.gainsToEndGame &gt;= <span class="hljs-number">5</span> <span class="hljs-keyword">or</span> state.cardInfo.Curse <span class="hljs-keyword">in</span> my.draw
      <span class="hljs-number">895</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">5</span>

}

makeCard <span class="hljs-string">"Mandarin"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">3</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.current.hand.length &gt; <span class="hljs-number">0</span>
      putBack = state.current.ai.choose(<span class="hljs-string">'putOnDeck'</span>, state, state.current.hand)
      state.doPutOnDeck(state.current, putBack)
  
  <span class="hljs-attribute">gainEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span>
    treasures = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> player.inPlay <span class="hljs-keyword">when</span> card.isTreasure)
    <span class="hljs-keyword">if</span> treasures.length &gt; <span class="hljs-number">0</span>
      <span class="hljs-keyword">for</span> treasure <span class="hljs-keyword">in</span> treasures
        player.inPlay.remove(treasure)
      order = player.ai.chooseOrderOnDeck(state, treasures, state.current)
      state.log(<span class="hljs-string">"...putting <span class="hljs-subst">#{order}</span> back on the deck."</span>)
      player.draw = order.concat(player.draw)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">168</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1620</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>

}

makeCard <span class="hljs-string">"Masquerade"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">2</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>Get everyone’s choice of cards to pass.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    passed = []
    <span class="hljs-keyword">for</span> player <span class="hljs-keyword">in</span> state.players
      cardToPass = player.ai.choose(<span class="hljs-string">'trash'</span>, state, player.hand)
      passed.push(cardToPass)</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>Pass the cards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..state.nPlayers]
      player = state.players[i]
      nextPlayer = state.players[(i + <span class="hljs-number">1</span>) % state.nPlayers]
      cardToPass = passed[i]
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> passes <span class="hljs-subst">#{cardToPass}</span>."</span>)
      <span class="hljs-keyword">if</span> cardToPass <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
        transferCard(cardToPass, player.hand, nextPlayer.hand)</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Allow the Masquerade player to trash a card.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    state.allowTrash(state.current, <span class="hljs-number">1</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">270</span>

  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1240</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">"Menagerie"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.revealHand(state.current)
    state.drawCards(state.current, state.current.menagerieDraws())
  
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.menagerieDraws() == <span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-number">980</span> <span class="hljs-keyword">else</span> <span class="hljs-number">340</span>

}

makeCard <span class="hljs-string">"Merchant Guild"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>
  
  <span class="hljs-attribute">buyInPlayEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span>
    state.current.coinTokens += <span class="hljs-number">1</span>
    state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> gains 1 Coin Token"</span>)
  
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-number">269</span>
    
}

makeCard <span class="hljs-string">"Mining Village"</span>, c.Village, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.current.ai.choose(<span class="hljs-string">'miningVillageTrash'</span>, state, [<span class="hljs-literal">yes</span>, <span class="hljs-literal">no</span>])
      <span class="hljs-keyword">if</span> state.current.playLocation != <span class="hljs-string">'trash'</span>
        transferCard(c[<span class="hljs-string">'Mining Village'</span>], state.current[state.current.playLocation], state.trash)
        state.current.playLocation = <span class="hljs-string">'trash'</span>
        state.log(<span class="hljs-string">"...trashing the Mining Village for +$2."</span>)
        state.current.coins += <span class="hljs-number">2</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">814</span>
}

makeCard <span class="hljs-string">"Mint"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">buyEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Remove cost modifiers that were created by treasure (e.g. Quarry)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    state.costModifiers = (m <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> state.costModifiers <span class="hljs-keyword">when</span> !m.source.isTreasure)
    state.potions = <span class="hljs-number">0</span>
    inPlay = state.current.inPlay
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [inPlay.length-<span class="hljs-number">1.</span>..-<span class="hljs-number">1</span>]
      <span class="hljs-keyword">if</span> inPlay[i].isTreasure
        state.log(<span class="hljs-string">"...trashing a <span class="hljs-subst">#{inPlay[i]}</span>."</span>)
        state.trash.push(inPlay[i])
        inPlay.splice(i, <span class="hljs-number">1</span>)

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    treasures = []
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.hand
      <span class="hljs-keyword">if</span> card.isTreasure
        treasures.push(card)
    choice = state.current.ai.choose(<span class="hljs-string">'mint'</span>, state, treasures)
    <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
      state.gainCard(state.current, choice)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    multiplier = my.getMultiplier()
    wantsToTrash = my.ai.wantsToTrash(state)
    <span class="hljs-keyword">if</span> my.ai.choose(<span class="hljs-string">'mint'</span>, state, my.hand)
      <span class="hljs-number">140</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">7</span>
}

makeCard <span class="hljs-string">"Moat"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">isReaction</span>: <span class="hljs-literal">true</span>

  <span class="hljs-attribute">reactToAttack</span>: <span class="hljs-function"><span class="hljs-params">(state, player, attackEvent)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>Don’t bother blocking the attack if it’s already blocked (avoid log spam)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">unless</span> attackEvent.blocked
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> is protected by a Moat."</span>)
      attackEvent.blocked = <span class="hljs-literal">true</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">120</span>
}

makeCard <span class="hljs-string">'Moneylender'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> c.Copper <span class="hljs-keyword">in</span> state.current.hand
      state.doTrash(state.current, c.Copper)
      state.current.coins += <span class="hljs-number">3</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">230</span>
}

makeCard <span class="hljs-string">"Monument"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">playEffect</span>:
    <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
      state.current.chips += <span class="hljs-number">1</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">182</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1400</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Nomad Camp'</span>, c.Woodcutter, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>

  <span class="hljs-attribute">gainEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, player)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> player.gainLocation != <span class="hljs-string">'trash'</span>
      transferCardToTop(c[<span class="hljs-string">'Nomad Camp'</span>], player[player.gainLocation], player.draw)
      player.gainLocation = <span class="hljs-string">'draw'</span>
      state.log(<span class="hljs-string">"...putting the Nomad Camp on top of the deck."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">162</span>
}

makeCard <span class="hljs-string">'Navigator'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">2</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    drawn = state.getCardsFromDeck(state.current, <span class="hljs-number">5</span>)
    <span class="hljs-keyword">if</span> state.current.ai.choose(<span class="hljs-string">'discardHand'</span>, state, [drawn, <span class="hljs-literal">null</span>]) <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
      state.log(<span class="hljs-string">"...choosing to keep <span class="hljs-subst">#{drawn}</span>."</span>)
      order = state.current.ai.chooseOrderOnDeck(state, drawn, state.current)
      state.log(<span class="hljs-string">"...putting <span class="hljs-subst">#{order}</span> back on the deck."</span>)
      state.current.draw = order.concat(state.current.draw)
    <span class="hljs-keyword">else</span>
      state.log(<span class="hljs-string">"...discarding <span class="hljs-subst">#{drawn}</span>."</span>)
      <span class="hljs-attribute">Array</span>::push.apply state.current.discard, drawn
      state.handleDiscards(state.current, drawn)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">126</span>
}

makeCard <span class="hljs-string">'Oasis'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.requireDiscard(state.current, <span class="hljs-number">1</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">480</span>
}

makeCard <span class="hljs-string">'Pawn'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">playEffect</span>:
    <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
      benefit = state.current.ai.choose(<span class="hljs-string">'benefit'</span>, state, [
        {<span class="hljs-attribute">cards</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>},
        {<span class="hljs-attribute">cards</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>},
        {<span class="hljs-attribute">cards</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>},
        {<span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>},
        {<span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>},
        {<span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>}
      ])
      applyBenefit(state, benefit)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">470</span>
}

makeCard <span class="hljs-string">'Pearl Diver'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    player = state.current
    bottomCard = player.draw.pop()
    <span class="hljs-keyword">if</span> bottomCard?
      doNotWant = player.ai.choose(<span class="hljs-string">'discard'</span>, state, [bottomCard, <span class="hljs-literal">null</span>])
      <span class="hljs-keyword">if</span> doNotWant
        state.log(<span class="hljs-string">"...choosing to leave <span class="hljs-subst">#{bottomCard}</span> at the bottom of the deck."</span>)
        player.draw.push(bottomCard)
      <span class="hljs-keyword">else</span>
        state.log(<span class="hljs-string">"...moving <span class="hljs-subst">#{bottomCard}</span> from the bottom to the top of the deck."</span>)
        player.draw.unshift(bottomCard)
    <span class="hljs-keyword">else</span>
      state.log(<span class="hljs-string">"...but the draw pile is empty."</span>)
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">725</span>

}

makeCard <span class="hljs-string">'Peddler'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">8</span>
  <span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">cards</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">coins</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">costInCoins</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    cost = <span class="hljs-number">8</span>
    <span class="hljs-keyword">if</span> state.phase <span class="hljs-keyword">is</span> <span class="hljs-string">'buy'</span>
      cost -= <span class="hljs-number">2</span> * state.current.actionsPlayed
      <span class="hljs-keyword">if</span> cost &lt; <span class="hljs-number">0</span>
        cost = <span class="hljs-number">0</span>
    cost
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">770</span>
}

makeCard <span class="hljs-string">'Plaza'</span>, c.Village, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    numStartingCards = state.current.hand.length
    possibleDiscards = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.hand <span class="hljs-keyword">when</span> card.isTreasure)
    possibleDiscards.push(<span class="hljs-literal">null</span>)
    choice = state.current.ai.choose(<span class="hljs-string">'plazaDiscard'</span>, state, possibleDiscards)
    <span class="hljs-keyword">if</span> choice?
      <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">in</span> possibleDiscards
        state.requireDiscard<span class="hljs-function"><span class="hljs-params">(state.current, <span class="hljs-number">1</span>, (card) -&gt; card == choice)</span>
        <span class="hljs-title">state</span>.<span class="hljs-title">current</span>.<span class="hljs-title">coinTokens</span> += 1
        <span class="hljs-title">state</span>.<span class="hljs-title">log</span><span class="hljs-params">(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> discards a <span class="hljs-subst">#{choice}</span>"</span>)</span>
        <span class="hljs-title">state</span>.<span class="hljs-title">log</span><span class="hljs-params">(<span class="hljs-string">"... gaining a Coin Token"</span>)</span>
}

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>New in Dark Ages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>makeCard <span class="hljs-string">'Poor House'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">coins</span>: +<span class="hljs-number">4</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    my = state.current
    state.revealHand(my)

    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.hand
      <span class="hljs-keyword">if</span> card.isTreasure
        my.coins -= <span class="hljs-number">1</span>

    <span class="hljs-keyword">if</span> my.coins &lt; <span class="hljs-number">0</span>
      my.coins = <span class="hljs-number">0</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">103</span>
}

makeCard <span class="hljs-string">'Rats'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    my = state.current
    trashables = []
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.hand
      <span class="hljs-keyword">if</span> card.name != <span class="hljs-string">'Rats'</span>
        trashables.push(card)
    toTrash = state.current.ai.choose(<span class="hljs-string">'trash'</span>, state, trashables)
    <span class="hljs-keyword">if</span> toTrash?
      state.doTrash(my, toTrash)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.ai.wantsToPlayRats(state, my)
      <span class="hljs-number">486</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Rebuild'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    my = state.current
    choices = []
    <span class="hljs-keyword">for</span> cardname <span class="hljs-keyword">in</span> [<span class="hljs-string">"Estate"</span>, <span class="hljs-string">"Duchy"</span>, <span class="hljs-string">"Duke"</span>, <span class="hljs-string">"Province"</span>, <span class="hljs-string">"Colony"</span>]
      card = c[cardname]
      choices.push(cardname)
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.getDeck()
      <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> choices <span class="hljs-keyword">and</span> card.isVictory
        choices.push(card)
    choices.push(c.Copper)
    namedcard = my.ai.choose(<span class="hljs-string">'nameVP'</span>, state, choices)
    state.log(<span class="hljs-string">"...<span class="hljs-subst">#{my.ai}</span> names <span class="hljs-subst">#{namedcard}</span>."</span>)
    drawn = my.dig(state,
      <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span> 
        <span class="hljs-keyword">return</span> card.isVictory <span class="hljs-keyword">and</span> card != namedcard
    )
    <span class="hljs-keyword">if</span> drawn <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> drawn.length &gt; <span class="hljs-number">0</span>
      cardToTrash = drawn[<span class="hljs-number">0</span>]
      state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> trashes <span class="hljs-subst">#{state.current.ai}</span>'s <span class="hljs-subst">#{cardToTrash}</span>."</span>)
      state.trash.push(drawn[<span class="hljs-number">0</span>])

      vpChoices = []
      <span class="hljs-keyword">for</span> cardname <span class="hljs-keyword">in</span> [<span class="hljs-string">"Estate"</span>, <span class="hljs-string">"Duchy"</span>, <span class="hljs-string">"Duke"</span>, <span class="hljs-string">"Province"</span>, <span class="hljs-string">"Colony"</span>]
        card = c[cardname]
        <span class="hljs-keyword">if</span> state.supply[card] &gt; <span class="hljs-number">0</span>
          [coins1, potions1] = cardToTrash.getCost(state)
          [coins2, potions2] = card.getCost(state)
          <span class="hljs-keyword">if</span> coins2 &lt;= coins1 + <span class="hljs-number">3</span>
            vpChoices.push(card)
    
      newCard = my.ai.choose(<span class="hljs-string">'rebuild'</span>, state, vpChoices)
      <span class="hljs-keyword">if</span> newCard <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
        state.gainCard(my, newCard, <span class="hljs-string">'discard'</span>, <span class="hljs-literal">true</span>)
        state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> gains <span class="hljs-subst">#{newCard}</span>."</span>)
      <span class="hljs-keyword">else</span>
        state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> gains nothing."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> 
    <span class="hljs-keyword">if</span> my.ai.wantsToRebuild(state, my)
      <span class="hljs-keyword">return</span> <span class="hljs-number">1000</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span> 
}</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>Also new in Dark Ages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>makeCard <span class="hljs-string">'Sage'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    my = state.current
    drawn = state.current.dig(state,
      <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span>
        [coins, potions] = card.getCost(state)
        <span class="hljs-keyword">return</span> coins &gt;= <span class="hljs-number">3</span>
    )
    <span class="hljs-keyword">if</span> drawn.length &gt; <span class="hljs-number">0</span>
      card = drawn[<span class="hljs-number">0</span>]
      state.log(<span class="hljs-string">"...<span class="hljs-subst">#{state.current.ai}</span> draws <span class="hljs-subst">#{card}</span>."</span>)
      state.current.hand.push(card)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">746</span>
}

makeCard <span class="hljs-string">'Salvager'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">buys</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    toTrash = state.current.ai.choose(<span class="hljs-string">'salvagerTrash'</span>, state, state.current.hand)
    <span class="hljs-keyword">if</span> toTrash?
      [coins, potions] = toTrash.getCost(state)
      state.doTrash(state.current, toTrash)
      state.current.coins += coins

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">220</span>
}

makeCard <span class="hljs-string">'Scheme'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">cards</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">cleanupEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    choices = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.inPlay <span class="hljs-keyword">when</span> card.isAction)
    choices.push(<span class="hljs-literal">null</span>)
    choice = state.current.ai.choose(<span class="hljs-string">'scheme'</span>, state, choices)
    <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> uses Scheme to put <span class="hljs-subst">#{choice}</span> back on the deck."</span>)
      transferCardToTop(choice, state.current.inPlay, state.current.draw)
  
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">745</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.countInDeck(<span class="hljs-string">"King's Court"</span>) &gt; <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1780</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Scout'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    drawn = state.getCardsFromDeck(state.current, <span class="hljs-number">4</span>)
    state.log(<span class="hljs-string">"...drawing <span class="hljs-subst">#{drawn}</span>."</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Implemented approximately the same way as Apothecary.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> drawn
      <span class="hljs-keyword">if</span> card.isVictory
        state.current.hand.push(card)
        state.log(<span class="hljs-string">"...putting <span class="hljs-subst">#{card}</span> in the hand."</span>)
      <span class="hljs-keyword">else</span>
        state.current.setAside.push(card)
    
    <span class="hljs-keyword">if</span> state.current.setAside.length &gt; <span class="hljs-number">0</span>
      order = state.current.ai.chooseOrderOnDeck(state, state.current.setAside, state.current)
      state.log(<span class="hljs-string">"...putting <span class="hljs-subst">#{order}</span> back on the deck."</span>)
      state.current.draw = order.concat(state.current.draw)
      state.current.setAside = []

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">875</span>

}</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>Secret Chamber — Initial code by Jorbles</p>
<p>This is far from optimal, but I believe it does what the card
is supposed to do without breaking any rules. I may have to come
back to this when my coffee skills are stronger. And I have a 
greater understanding of how discards are decided. Ideally, the 
code for discards should be different depending on the type of 
attack and the total money already in hand.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
makeCard <span class="hljs-string">"Secret Chamber"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">isReaction</span>: <span class="hljs-literal">true</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    discarded = state.allowDiscard(state.current, Infinity)
    state.log(<span class="hljs-string">"...getting +$<span class="hljs-subst">#{discarded.length}</span> from the Secret Chamber."</span>)
    state.current.coins += discarded.length

  <span class="hljs-attribute">reactToAttack</span>: <span class="hljs-function"><span class="hljs-params">(state, player, attackEvent)</span> -&gt;</span>
    state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai.name}</span> reveals a Secret Chamber."</span>)
    state.drawCards(player, <span class="hljs-number">2</span>)
    card = player.ai.choose(<span class="hljs-string">'putOnDeck'</span>, state, player.hand)
    <span class="hljs-keyword">if</span> card <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
      state.doPutOnDeck(player, card)
    card = player.ai.choose(<span class="hljs-string">'putOnDeck'</span>, state, player.hand)
    <span class="hljs-keyword">if</span> card <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
      state.doPutOnDeck(player, card)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">138</span>
}

makeCard <span class="hljs-string">'Shanty Town'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">2</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.revealHand(state.current)
    state.drawCards(state.current, state.current.shantyTownDraws())

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.shantyTownDraws(<span class="hljs-literal">true</span>) == <span class="hljs-number">2</span>
      <span class="hljs-number">970</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> my.actions &lt; <span class="hljs-number">2</span>
      <span class="hljs-number">340</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">70</span>
}

makeCard <span class="hljs-string">'Smugglers'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.gainOneOf(state.current, state.smugglerChoices())

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">110</span>

}

makeCard <span class="hljs-string">'Spice Merchant'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    trashChoices = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.hand <span class="hljs-keyword">when</span> card.isTreasure)
    trashChoices.push(<span class="hljs-literal">null</span>)
    trashed = state.current.ai.choose(<span class="hljs-string">'spiceMerchantTrash'</span>, state, trashChoices)
    <span class="hljs-keyword">if</span> trashed?
      state.doTrash(state.current, trashed)
      benefit = state.current.ai.choose(<span class="hljs-string">'benefit'</span>, state, [
        {<span class="hljs-attribute">cards</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>},
        {<span class="hljs-attribute">coins</span>: <span class="hljs-number">2</span>, <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>}
      ])
      applyBenefit(state, benefit)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> c.Copper <span class="hljs-keyword">in</span> my.hand 
      <span class="hljs-number">740</span>
    <span class="hljs-keyword">else</span>
      trashChoices = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.hand <span class="hljs-keyword">when</span> card.isTreasure)
      trashChoices.push(<span class="hljs-literal">null</span>)

      <span class="hljs-keyword">if</span> my.ai.choose(<span class="hljs-string">'spiceMerchantTrash'</span>, state, trashChoices)
        <span class="hljs-number">410</span>
      <span class="hljs-keyword">else</span>
        <span class="hljs-number">80</span>
}

makeCard <span class="hljs-string">'Stables'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    discardChoices = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.hand <span class="hljs-keyword">when</span> card.isTreasure)
    discardChoices.push(<span class="hljs-literal">null</span>)
    discarded = state.current.ai.choose(<span class="hljs-string">'stablesDiscard'</span>, state, discardChoices)
    <span class="hljs-keyword">if</span> discarded?
      state.doDiscard(state.current, discarded)
      state.drawCards(state.current, <span class="hljs-number">3</span>)
      state.current.actions += <span class="hljs-number">1</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    discardChoices = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> state.current.hand <span class="hljs-keyword">when</span> card.isTreasure)
    discardChoices.push(<span class="hljs-literal">null</span>)
    <span class="hljs-keyword">if</span> my.ai.choose(<span class="hljs-string">'stablesDiscard'</span>, state, discardChoices)
      <span class="hljs-number">735</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">50</span>
}

makeCard <span class="hljs-string">'Steward'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">playEffect</span>:
    <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
      benefit = state.current.ai.choose(<span class="hljs-string">'benefit'</span>, state, [
        {<span class="hljs-attribute">cards</span>: <span class="hljs-number">2</span>},
        {<span class="hljs-attribute">coins</span>: <span class="hljs-number">2</span>},
        {<span class="hljs-attribute">trash</span>: <span class="hljs-number">2</span>}
      ])
      applyBenefit(state, benefit)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">233</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1300</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Throne Room'</span>, c[<span class="hljs-string">"King's Court"</span>], {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">multiplier</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">optional</span>: <span class="hljs-literal">false</span>

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.ai.wantsToPlayMultiplier(state)
      <span class="hljs-number">920</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> my.ai.okayToPlayMultiplier(state)
      <span class="hljs-number">380</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">50</span>
  
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">1900</span>
}

makeCard <span class="hljs-string">'Tournament'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>

  <span class="hljs-attribute">startGameEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>Add Tournament prizes to the game state’s special supply</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    prizeNames = [<span class="hljs-string">'Bag of Gold'</span>, <span class="hljs-string">'Diadem'</span>, <span class="hljs-string">'Followers'</span>, <span class="hljs-string">'Princess'</span>, <span class="hljs-string">'Trusty Steed'</span>]
    prizes = (c[name] <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> prizeNames)

    <span class="hljs-keyword">for</span> prize <span class="hljs-keyword">in</span> prizes
      state.specialSupply[prize] = <span class="hljs-number">1</span>

    state.cardState[<span class="hljs-keyword">this</span>] =
      <span class="hljs-attribute">copy</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-attribute">prizes</span>: <span class="hljs-property">@prizes</span>.concat()
      <span class="hljs-attribute">prizes</span>: prizes

  <span class="hljs-attribute">playEffect</span>:
    <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>All Provinces are automatically revealed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      opposingProvince = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">for</span> opp <span class="hljs-keyword">in</span> state.players[<span class="hljs-number">1.</span>..]
        <span class="hljs-keyword">if</span> c.Province <span class="hljs-keyword">in</span> opp.hand
          state.log(<span class="hljs-string">"<span class="hljs-subst">#{opp.ai}</span> reveals a Province."</span>)
          opposingProvince = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">if</span> c.Province <span class="hljs-keyword">in</span> state.current.hand
        discardProvince = state.current.ai.choose(<span class="hljs-string">'tournamentDiscard'</span>, state, [<span class="hljs-literal">yes</span>, <span class="hljs-literal">no</span>])
        <span class="hljs-keyword">if</span> discardProvince
          state.doDiscard(state.current, c.Province)
          prizes = state.cardState[<span class="hljs-keyword">this</span>].prizes
          choices = (prize <span class="hljs-keyword">for</span> prize <span class="hljs-keyword">in</span> prizes <span class="hljs-keyword">when</span> state.specialSupply[prize] &gt; <span class="hljs-number">0</span>)

          <span class="hljs-keyword">if</span> state.supply[c.Duchy] &gt; <span class="hljs-number">0</span>
            choices.push(c.Duchy)
          choice = state.gainOneOf(state.current, choices, <span class="hljs-string">'draw'</span>)

          <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
            state.log(<span class="hljs-string">"...putting the <span class="hljs-subst">#{choice}</span> on top of the deck."</span>)
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> opposingProvince
        state.current.coins += <span class="hljs-number">1</span>
        state.current.drawCards(<span class="hljs-number">1</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.countInHand(<span class="hljs-string">'Province'</span>) == <span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-number">960</span> <span class="hljs-keyword">else</span> <span class="hljs-number">360</span>

}

makeCard <span class="hljs-string">"Trade Route"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">buys</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">trash</span>: <span class="hljs-number">1</span>

  <span class="hljs-attribute">startGameEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.cardState[<span class="hljs-keyword">this</span>] =
      <span class="hljs-attribute">copy</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-attribute">mat</span>: <span class="hljs-property">@mat</span>.concat()
      <span class="hljs-attribute">mat</span>: []

  <span class="hljs-attribute">globalGainEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, player, card, source)</span> -&gt;</span>
    mat = state.cardState[<span class="hljs-keyword">this</span>].mat
    <span class="hljs-keyword">if</span> card.isVictory <span class="hljs-keyword">and</span> source == <span class="hljs-string">'supply'</span> <span class="hljs-keyword">and</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> mat
      mat.push(card)

  <span class="hljs-attribute">getCoins</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.cardState[<span class="hljs-keyword">this</span>].mat.length

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    multiplier = my.getMultiplier()
    wantsToTrash = my.ai.wantsToTrash(state)
    <span class="hljs-keyword">if</span> wantsToTrash &gt;= multiplier
      <span class="hljs-number">160</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">25</span>
}

makeCard <span class="hljs-string">"Trader"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">isReaction</span>: <span class="hljs-literal">true</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    trashed = state.requireTrash(state.current, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">if</span> trashed?
      [coins, potions] = trashed.getCost(state)
      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..coins]
        state.gainCard(state.current, c.Silver)</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p><code>reactReplacingGain</code> triggers before <code>reactToGain</code>, and lets you replace
the card with a different one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">reactReplacingGain</span>: <span class="hljs-function"><span class="hljs-params">(state, player, card)</span> -&gt;</span>
    card = player.ai.choose(<span class="hljs-string">'gain'</span>, state, [c.Silver, card])
    <span class="hljs-keyword">return</span> c[card]

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    multiplier = my.getMultiplier()
    wantsToTrash = my.ai.wantsToTrash(state)
    <span class="hljs-keyword">if</span> wantsToTrash &gt;= multiplier
      <span class="hljs-number">142</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">22</span>
}

makeCard <span class="hljs-string">"Trading Post"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.requireTrash(state.current, <span class="hljs-number">2</span>)
    state.gainCard(state.current, c.Silver, <span class="hljs-string">'hand'</span>)
    state.log(<span class="hljs-string">"...gaining a Silver in hand."</span>)    

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    multiplier = my.getMultiplier()
    wantsToTrash = my.ai.wantsToTrash(state)
    <span class="hljs-keyword">if</span> wantsToTrash &gt;= multiplier*<span class="hljs-number">2</span>
      <span class="hljs-number">148</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">38</span>

}

makeCard <span class="hljs-string">"Transmute"</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">0</span>
  <span class="hljs-attribute">costPotion</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    player = state.current
    trashed = player.ai.choose(<span class="hljs-string">'transmute'</span>, state, player.hand)
    <span class="hljs-keyword">if</span> trashed?
      state.doTrash(player, trashed)
      <span class="hljs-keyword">if</span> trashed.isAction
        state.gainCard(state.current, c.Duchy)
      <span class="hljs-keyword">if</span> trashed.isTreasure
        state.gainCard(state.current, c.Transmute)
      <span class="hljs-keyword">if</span> trashed.isVictory
        state.gainCard(state.current, c.Gold)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    multiplier = my.getMultiplier()
    wantsToTrash = my.ai.wantsToTrash(state)
    <span class="hljs-keyword">if</span> my.ai.choose(<span class="hljs-string">'mint'</span>, state, my.hand)
      <span class="hljs-number">106</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">27</span>
}

makeCard <span class="hljs-string">'Treasure Map'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    trashedMaps = <span class="hljs-number">0</span>

    <span class="hljs-keyword">if</span> c[<span class="hljs-string">'Treasure Map'</span>] <span class="hljs-keyword">in</span> state.current.inPlay
      state.log(<span class="hljs-string">"...trashing the Treasure Map."</span>)
      transferCard(c[<span class="hljs-string">'Treasure Map'</span>], state.current.inPlay, state.trash)
      trashedMaps += <span class="hljs-number">1</span>

    <span class="hljs-keyword">if</span> c[<span class="hljs-string">'Treasure Map'</span>] <span class="hljs-keyword">in</span> state.current.hand
      state.doTrash(state.current, c[<span class="hljs-string">'Treasure Map'</span>])
      state.log(<span class="hljs-string">"...and trashing another Treasure Map."</span>)
      trashedMaps += <span class="hljs-number">1</span>

    <span class="hljs-keyword">if</span> trashedMaps == <span class="hljs-number">2</span>
      numGolds = <span class="hljs-number">0</span>
      <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> [<span class="hljs-number">1.</span><span class="hljs-number">.4</span>]
        <span class="hljs-keyword">if</span> state.countInSupply(c.Gold) &gt; <span class="hljs-number">0</span>
          state.gainCard(state.current, c.Gold, <span class="hljs-string">'draw'</span>)
          numGolds += <span class="hljs-number">1</span>
      state.log(<span class="hljs-string">"…gaining <span class="hljs-subst">#{numGolds}</span> Golds, putting them on top of the deck."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.countInHand(<span class="hljs-string">"Treasure Map"</span>) &gt;= <span class="hljs-number">2</span>
      <span class="hljs-number">294</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> my.countInDeck(<span class="hljs-string">"Gold"</span>) &gt;= <span class="hljs-number">4</span> <span class="hljs-keyword">and</span> state.current.countInDeck(<span class="hljs-string">"Treasure Map"</span>) == <span class="hljs-number">1</span>
      <span class="hljs-number">90</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">40</span>
}

makeCard <span class="hljs-string">'Treasury'</span>, c.Market, {
  <span class="hljs-attribute">buys</span>: <span class="hljs-number">0</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.cardState[<span class="hljs-keyword">this</span>] =
      <span class="hljs-attribute">mayReturnTreasury</span>: <span class="hljs-literal">yes</span>
  
  <span class="hljs-attribute">buyInPlayEffect</span>: <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>FIXME: This is incorrect in one highly unlikely edge case - if you buy
       a victory card from the Black Market, then you play a Treasury,
       you are not allowed to return the treasury to the top of the deck
       even though the treasury wasn’t in play when you bought the card.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> card.isVictory
      state.cardState[<span class="hljs-keyword">this</span>].mayReturnTreasury = <span class="hljs-literal">no</span>

  <span class="hljs-attribute">cleanupEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>    
    <span class="hljs-keyword">if</span> state.cardState[<span class="hljs-keyword">this</span>].mayReturnTreasury <span class="hljs-keyword">and</span> c.Treasury <span class="hljs-keyword">in</span> state.current.inPlay
      transferCardToTop(c.Treasury, state.current.inPlay, state.current.draw)
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> returns a Treasury to the top of the deck."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">765</span>
}

makeCard <span class="hljs-string">'Tribute'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    revealedCards = state.discardFromDeck(state.players[<span class="hljs-number">1</span>], <span class="hljs-number">2</span>)

    unique = []
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> revealedCards
      <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> unique
        unique.push(card)

    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> unique
      <span class="hljs-keyword">if</span> card.isAction
        state.current.actions += <span class="hljs-number">2</span>
      <span class="hljs-keyword">if</span> card.isTreasure
        state.current.coins += <span class="hljs-number">2</span>
      <span class="hljs-keyword">if</span> card.isVictory
        state.current.drawCards(<span class="hljs-number">2</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>after Cursers but before other terminals; there is probably a better spot for it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-number">281</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">1320</span>
}

makeCard <span class="hljs-string">'University'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">costPotion</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    choices = []
    <span class="hljs-keyword">for</span> cardName <span class="hljs-keyword">of</span> state.supply
      card = c[cardName]
      [coins, potions] = card.getCost(state)
      <span class="hljs-keyword">if</span> potions == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> coins &lt;= <span class="hljs-number">5</span> <span class="hljs-keyword">and</span> card.isAction
        choices.push(card)
    state.gainOneOf(state.current, choices)
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">842</span>
}

makeCard <span class="hljs-string">'Vault'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">cards</span>: +<span class="hljs-number">2</span>

  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    discarded = state.allowDiscard(state.current, Infinity)
    state.log(<span class="hljs-string">"...getting +$<span class="hljs-subst">#{discarded.length}</span> from the Vault."</span>)
    state.current.coins += discarded.length

    <span class="hljs-keyword">for</span> opp <span class="hljs-keyword">in</span> state.players[<span class="hljs-number">1.</span>..]
      <span class="hljs-keyword">if</span> opp.ai.wantsToDiscard(state) &gt;= <span class="hljs-number">2</span>
        discarded = state.requireDiscard(opp, <span class="hljs-number">2</span>)
        <span class="hljs-keyword">if</span> discarded.length == <span class="hljs-number">2</span>
          state.drawCards(opp, <span class="hljs-number">1</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">268</span>
  <span class="hljs-attribute">ai_multipliedValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1220</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Walled Village'</span>, c.Village, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">826</span></pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>Clean up effect defined in <code>State.doCleanupPhase</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}

makeCard <span class="hljs-string">'Warehouse'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">actions</span>: +<span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    state.drawCards(state.current, <span class="hljs-number">3</span>)
    state.requireDiscard(state.current, <span class="hljs-number">3</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">460</span>
}

makeCard <span class="hljs-string">'Watchtower'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">isReaction</span>: <span class="hljs-literal">true</span>
  
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    handLength = state.current.hand.length
    <span class="hljs-keyword">if</span> handLength &lt; <span class="hljs-number">6</span>
      state.drawCards(state.current, <span class="hljs-number">6</span> - handLength)
  
  <span class="hljs-attribute">reactToGain</span>: <span class="hljs-function"><span class="hljs-params">(state, player, card)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> player.gainLocation == <span class="hljs-string">'trash'</span>
    source = player[player.gainLocation]</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>Determine if the player wants to trash the card. If so, use the
Watchtower to do so.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> player.ai.chooseTrash(state, [card, <span class="hljs-literal">null</span>]) <span class="hljs-keyword">is</span> card</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>trash the card</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> reveals a Watchtower and trashes the <span class="hljs-subst">#{card}</span>."</span>)
      transferCard(card, source, state.trash)</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>Note that the gained card now has no valid location; it’s in the trash.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      player.gainLocation = <span class="hljs-string">'trash'</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> player.ai.choose(<span class="hljs-string">'gainOnDeck'</span>, state, [card, <span class="hljs-literal">null</span>])
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> reveals a Watchtower and puts the <span class="hljs-subst">#{card}</span> on the deck."</span>)
      player.gainLocation = <span class="hljs-string">'draw'</span>
      transferCardToTop(card, source, player.draw)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span>
      <span class="hljs-keyword">switch</span> my.hand.length
        <span class="hljs-keyword">when</span> <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span> <span class="hljs-keyword">then</span> <span class="hljs-number">650</span>
        <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">switch</span> my.hand.length
        <span class="hljs-keyword">when</span> <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-number">196</span>
        <span class="hljs-keyword">when</span> <span class="hljs-number">4</span> <span class="hljs-keyword">then</span> <span class="hljs-number">190</span>
        <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
}

makeCard <span class="hljs-string">'Wishing Well'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">cards</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">actions</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    choices = []
    <span class="hljs-keyword">for</span> cardName <span class="hljs-keyword">in</span> c.allCards
      choices.push(c[cardName])
      
    wish = state.current.ai.choose(<span class="hljs-string">'wish'</span>, state, choices)
    state.log(<span class="hljs-string">"...wishing for a <span class="hljs-subst">#{wish}</span>."</span>)
    drawn = state.current.getCardsFromDeck(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">if</span> drawn.length &gt; <span class="hljs-number">0</span>
      card = drawn[<span class="hljs-number">0</span>]
      <span class="hljs-keyword">if</span> card <span class="hljs-keyword">is</span> wish
        state.log(<span class="hljs-string">"...revealing a <span class="hljs-subst">#{card}</span> and keeping it."</span>)
        state.current.hand.push(card)
      <span class="hljs-keyword">else</span>
        state.log(<span class="hljs-string">"...revealing a <span class="hljs-subst">#{card}</span> and putting it back."</span>)
        state.current.draw.unshift(card)
    <span class="hljs-keyword">else</span>
      state.log(<span class="hljs-string">"...drawing nothing."</span>)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">745</span>
}

makeCard <span class="hljs-string">'Workshop'</span>, action, {
  <span class="hljs-attribute">cost</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">playEffect</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    choices = []
    <span class="hljs-keyword">for</span> cardName <span class="hljs-keyword">of</span> state.supply
      card = c[cardName]
      [coins, potions] = card.getCost(state)
      <span class="hljs-keyword">if</span> potions == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> coins &lt;= <span class="hljs-number">4</span> <span class="hljs-keyword">and</span> state.supply[cardName] &gt; <span class="hljs-number">0</span>
        choices.push(card)
    state.gainOneOf(state.current, choices)

  <span class="hljs-attribute">ai_playValue</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> <span class="hljs-number">112</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <h2 id="utility-functions">Utility functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p><code>transferCard</code> will move a card from one list to the end of another.</p>
<p>If you are doing something to each card in a list which might result in
that card being moved somewhere else, you <em>must</em> iterate over the list
backwards. Otherwise you’ll run off the end of the list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">transferCard</span> = <span class="hljs-params">(card, fromList, toList)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> fromList
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"<span class="hljs-subst">#{fromList}</span> does not contain <span class="hljs-subst">#{card}</span>"</span>)
  fromList.remove(card)
  toList.push(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p><code>transferCardToTop</code> will move a card from one list to the front of another.
This is used to put a card on top of the deck, for example.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">transferCardToTop</span> = <span class="hljs-params">(card, fromList, toList)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> fromList
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"<span class="hljs-subst">#{fromList}</span> does not contain <span class="hljs-subst">#{card}</span>"</span>)
  fromList.remove(card)
  toList.unshift(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p><code>Array::unique</code> returns the unique keys from a given array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-attribute">Array</span>::<span class="hljs-function"><span class="hljs-title">unique</span> = -&gt;</span>
  output = {}
  output[@[key]] = @[key] <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@length</span>]
  value <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> output</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>Some cards give you a constant benefit, such as +cards or +actions,
every time you play them; these benefits are defined directly on the card
object. Other cards give you such a benefit only under certain conditions,
and if the benefits are straightforward, we may use <code>applyBenefit</code> to make
them happen. This takes in an object that describes the benefit, and
applies it to the game state.</p>
<p>The actions that can be performed through <code>applyBenefit</code> currently are:</p>
<ul>
<li><code>{cards: n}</code>: draw <em>n</em> cards</li>
<li><code>{actions: n}</code>: get <em>+n</em> actions</li>
<li><code>{buys: n}</code>: get <em>+n</em> buys</li>
<li><code>{coins: n}</code>: get <em>+n</em> coins</li>
<li><code>{trash: n}</code>: trash <em>n</em> cards</li>
<li><code>{horseEffect: yes}</code>: gain 4 Silvers and discard your draw pile</li>
</ul>
<p>The AI has no rule in it that chooses <code>horseEffect</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">applyBenefit</span> = <span class="hljs-params">(state, benefit)</span> -&gt;</span>
  state.log(<span class="hljs-string">"<span class="hljs-subst">#{state.current.ai}</span> gets <span class="hljs-subst">#{JSON.stringify(benefit)}</span>."</span>)
  <span class="hljs-keyword">if</span> benefit.cards?
    state.drawCards(state.current, benefit.cards)
  <span class="hljs-keyword">if</span> benefit.actions?
    state.current.actions += benefit.actions
  <span class="hljs-keyword">if</span> benefit.buys?
    state.current.buys += benefit.buys
  <span class="hljs-keyword">if</span> benefit.coins?
    state.current.coins += benefit.coins
  <span class="hljs-keyword">if</span> benefit.trash?
    state.requireTrash(state.current, benefit.trash)
  <span class="hljs-keyword">if</span> benefit.horseEffect
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>.<span class="hljs-number">.4</span>]
      state.gainCard(state.current, c.Silver)
    discards = state.current.draw
    state.current.discard = state.current.discard.concat(discards)
    state.current.draw = []
    state.handleDiscards(state.current, discards)</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p><code>upgradeChoices</code> is a helper function to get a list of choices for
Remodel and similar “upgrading” cards. In addition to the game state, it
takes in:</p>
<ul>
<li><code>cards</code>: a list of cards that may be improved, which is usually the cards
in hand; duplicates are fine.</li>
<li><code>filter</code>: a function of (oldCard, newCard) that describes whether the
improvement is allowed.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">upgradeChoices</span> = <span class="hljs-params">(state, cards, filter)</span> -&gt;</span>
  used = []
  choices = []
  <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> cards
    <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> used
      used.push(card)
      <span class="hljs-keyword">for</span> cardname2 <span class="hljs-keyword">of</span> state.supply
        card2 = c[cardname2]
        <span class="hljs-keyword">if</span> filter(state, card, card2) <span class="hljs-keyword">and</span> state.supply[card2] &gt; <span class="hljs-number">0</span>
          choices.push([card, card2])          
  <span class="hljs-keyword">return</span> choices</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Find options where you can upgrade a card into nothing, because you’re
required to gain a card at a cost where there isn’t anything.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">nullUpgradeChoices</span> = <span class="hljs-params">(state, cards, costFunction)</span> -&gt;</span>
  costs = []
  <span class="hljs-keyword">for</span> cardname <span class="hljs-keyword">of</span> state.supply
    <span class="hljs-keyword">if</span> state.supply[cardname] &gt; <span class="hljs-number">0</span>
      card = c[cardname]
      cost = <span class="hljs-string">""</span>+card.getCost(state)  <span class="hljs-comment"># make it a string so it's searchable</span>
      <span class="hljs-keyword">if</span> cost <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> costs
        costs.push(cost)

  used = []
  choices = []
  <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> cards
    <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> used
      used.push(card)
      [coins, potions] = card.getCost(state)
      coins2 = costFunction(coins)
      costStr = <span class="hljs-string">""</span>+[coins2, potions]
      <span class="hljs-keyword">if</span> costStr <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> costs
        choices.push([card, <span class="hljs-literal">null</span>])
  <span class="hljs-keyword">return</span> choices</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>The <code>player</code> makes a single spying decision on <code>target</code>‘s deck, using
the decision named <code>decision</code> to decide whether to keep the card. For
example, if the player is choosing to discard from its own deck, the
decision name is <code>discard</code>; if it’s an opponent’s deck, the decision
name is <code>discardFromOpponentDeck</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">spyDecision</span> = <span class="hljs-params">(player, target, state, decision)</span> -&gt;</span>
  drawn = state.getCardsFromDeck(target, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">if</span> drawn?
    state.log(<span class="hljs-string">"<span class="hljs-subst">#{target.ai}</span> reveals <span class="hljs-subst">#{drawn}</span>."</span>)
    discarded = player.ai.choose(decision, state, [drawn, <span class="hljs-literal">null</span>])
    <span class="hljs-keyword">if</span> discarded?
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> chooses to discard it."</span>)
      target.discard.push(drawn)
    <span class="hljs-keyword">else</span>
      state.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> chooses to put it back on the draw pile."</span>)
      target.draw.unshift(drawn)
  <span class="hljs-keyword">else</span>
    state.log(<span class="hljs-string">"<span class="hljs-subst">#{target.ai}</span> has no card to reveal."</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>Export functions that are needed elsewhere.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">this</span>.transferCard = transferCard
<span class="hljs-keyword">this</span>.transferCardToTop = transferCardToTop</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
