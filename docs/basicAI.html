<!DOCTYPE html>

<html>
<head>
  <title>basicAI.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="basicAI.html">
                basicAI.coffee
              </a>
            
              
              <a class="source" href="cards.html">
                cards.coffee
              </a>
            
              
              <a class="source" href="compileStrategies.html">
                compileStrategies.coffee
              </a>
            
              
              <a class="source" href="gameState.html">
                gameState.coffee
              </a>
            
              
              <a class="source" href="heuristics.html">
                heuristics.coffee
              </a>
            
              
              <a class="source" href="play.html">
                play.coffee
              </a>
            
              
              <a class="source" href="playWeb.html">
                playWeb.coffee
              </a>
            
              
              <a class="source" href="testSimulation.html">
                testSimulation.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>basicAI.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>{c} = <span class="hljs-built_in">require</span> <span class="hljs-string">'./cards'</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">exports</span>?</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="the-basic-ai">The Basic AI</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>This class defines a rule-based AI of the kind that is popular
for evaluating Dominion strategies. It can be subclassed — or simply
have its methods overwritten on an instance — to play new strategies.</p>
<p>Every time the player needs to make a meaningful decision, a method called
<code>chooseX</code> (for some X) will be called on the AI, which can examine the game
state and make a decision accordingly.</p>
<p>In any case that is not a simple yes/no decision, the method will be 
given a list of choices. It will first check a method called <code>xPriority</code>,
which takes in the state and returns an ordered list of choices.
The player will make the first valid choice in that list. Choices are
skipped when they have an “if” clause that fails.</p>
<p>If the priority list doesn’t choose anything, or if there is no priority
function, it will consult the <code>xValue</code> method instead, which takes in
a specific choice and assigns it a numerical value.</p>
<p>Priority functions are usually easier to define than value functions, but
value functions can easily cover every possible case.</p>
<p>The BasicAI has a default decision function for every decision, so
every AI that derives from it will have <em>some</em> way to decide what to do in
any situation. However, when defining an AI, you will often want to override
some of these decision functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BasicAI</span></span>
  <span class="hljs-attribute">name</span>: <span class="hljs-string">'Basic AI'</span>
  <span class="hljs-attribute">author</span>: <span class="hljs-string">'rspeer'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Referring to <code>state.current</code> to find information about one’s own state is
not always safe! Some of these decisions may be made during other players’
turns. In those cases, what we want is <code>this.myPlayer(state)</code>.</p>
<p>This is passed in as an argument <code>my</code> to the decision functions, because
it’s convenient and it creates nice idioms such as <code>my.hand</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
  <span class="hljs-attribute">myPlayer</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> player <span class="hljs-keyword">in</span> state.players
      <span class="hljs-keyword">if</span> player.ai <span class="hljs-keyword">is</span> <span class="hljs-keyword">this</span>
        <span class="hljs-keyword">return</span> player
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-keyword">this</span>}</span> is being asked to make a decision, but isn't playing the game...?"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="decision-making-machinery">Decision-making machinery</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Make the AI’s preferred choice, first by checking its explicit priority
list. If no valid choices are on the list, ask the value function instead.</p>
<p>The priority function returns an ordered list of choices it will want to
make when they are available. If ‘null’ is on the priority list, that
represents an explicit preference to choose “none of the above” when it’s
an option.</p>
<p>The value list assigns a numerical value to every possible choice. ‘null’
automatically has a value of 0. Here you can represent actions you will
only take when forced to, by giving them negative values.</p>
<p>If a choice should be made entirely using the value function, make the
priority function return an empty list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">choose</span>: <span class="hljs-function"><span class="hljs-params">(type, state, choices)</span> -&gt;</span>
    my = <span class="hljs-keyword">this</span>.myPlayer(state)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Are there no choices? We follow the rule that makes the null choice
available in that situation, and choose it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> choices.length == <span class="hljs-number">0</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>First, try the priority function. If the priority function reaches
the end of its list, it is treated as “none of the above”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    priorityfunc = <span class="hljs-keyword">this</span>[type+<span class="hljs-string">'Priority'</span>]
    <span class="hljs-keyword">if</span> priorityfunc?</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Construct an object with the choices as keys, so we can look them
up quickly.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      choiceSet = {}
      <span class="hljs-keyword">for</span> choice <span class="hljs-keyword">in</span> choices
        choiceSet[choice] = choice

      nullable = <span class="hljs-literal">null</span> <span class="hljs-keyword">in</span> choices</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Get the priority list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      priority = priorityfunc.call(<span class="hljs-keyword">this</span>, state, my)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Now look up all the preferences in that list. The moment we encounter
a valid choice, we can return it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> preference <span class="hljs-keyword">in</span> priority
        <span class="hljs-keyword">if</span> preference <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">and</span> nullable
          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> choiceSet[preference]?
          <span class="hljs-keyword">return</span> choiceSet[preference]</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>The priority list doesn’t want any of these choices (perhaps because
it doesn’t exist). Now try the value function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    bestChoice = <span class="hljs-literal">null</span>
    bestValue = -Infinity
  
    <span class="hljs-keyword">for</span> choice <span class="hljs-keyword">in</span> choices
      value = <span class="hljs-keyword">this</span>.getChoiceValue(type, state, choice, my)
      <span class="hljs-keyword">if</span> value &gt; bestValue
        bestValue = value
        bestChoice = choice</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>If we got a valid choice, return it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> bestChoice <span class="hljs-keyword">in</span> choices
      <span class="hljs-keyword">return</span> bestChoice</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>If we get here, the AI probably wants to choose none of the above.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">in</span> choices
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-keyword">this</span>}</span> somehow failed to make a choice"</span>)
  
  <span class="hljs-attribute">getChoiceValue</span>: <span class="hljs-function"><span class="hljs-params">(type, state, choice, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">or</span> choice <span class="hljs-keyword">is</span> <span class="hljs-literal">no</span>
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

    specificValueFunc = <span class="hljs-keyword">this</span>[type+<span class="hljs-string">'Value'</span>]
    <span class="hljs-keyword">if</span> specificValueFunc?
      result = specificValueFunc.call(<span class="hljs-keyword">this</span>, state, choice, my)
      <span class="hljs-keyword">if</span> result <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-keyword">this</span>}</span> has an undefined <span class="hljs-subst">#{type}</span> value for <span class="hljs-subst">#{choice}</span>"</span>)
      <span class="hljs-keyword">if</span> result <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">return</span> result

    defaultValueFunc = choice[<span class="hljs-string">'ai_'</span>+type+<span class="hljs-string">'Value'</span>]
    <span class="hljs-keyword">if</span> defaultValueFunc?
      result = defaultValueFunc.call(choice, state, my)
      <span class="hljs-keyword">if</span> result <span class="hljs-keyword">is</span> <span class="hljs-literal">undefined</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-keyword">this</span>}</span> has an undefined <span class="hljs-subst">#{type}</span> value for <span class="hljs-subst">#{choice}</span>"</span>)
      <span class="hljs-keyword">if</span> result <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">return</span> result

    state.warn(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-keyword">this</span>}</span> doesn't know how to make a <span class="hljs-subst">#{type}</span> decision for <span class="hljs-subst">#{choice}</span>"</span>)
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1000</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Sometimes we need to compare choices in a strictly numeric way. This takes
a particular choice for a particular choice type, and gets its numeric value.
If the value comes from a priority list, it will be 100 * (distance from end
of list).</p>
<p>So, for example, the default choiceToValue of discarding a Colony is 999, while
the choiceToValue of discarding an extra terminal is 1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">choiceToValue</span>: <span class="hljs-function"><span class="hljs-params">(type, state, choice)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">or</span> choice <span class="hljs-keyword">is</span> <span class="hljs-literal">no</span>
    my = <span class="hljs-keyword">this</span>.myPlayer(state)
    priorityfunc = <span class="hljs-keyword">this</span>[type+<span class="hljs-string">'Priority'</span>]
    <span class="hljs-keyword">if</span> priorityfunc?
      priority = priorityfunc.bind(<span class="hljs-keyword">this</span>)(state, my)
    <span class="hljs-keyword">else</span>
      priority = []
    index = priority.indexOf(stringify(choice))
    <span class="hljs-keyword">if</span> index != -<span class="hljs-number">1</span>
      <span class="hljs-keyword">return</span> (priority.length - index) * <span class="hljs-number">100</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getChoiceValue(type, state, choice, my)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Originally implemented in the <code>Rebuild.coffee</code> strategy, this method gets
the difference in score if the game were to end now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getScoreDifference</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> 
    <span class="hljs-keyword">for</span> status <span class="hljs-keyword">in</span> state.getFinalStatus()
      [name, score, turns] = status
      <span class="hljs-keyword">if</span> name == my.ai.toString()
        myScore = score
      <span class="hljs-keyword">else</span>
        opponentScore = score
    <span class="hljs-keyword">return</span> myScore - opponentScore</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>More utilities from the Rebuild strategy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">countNotInHand</span>: <span class="hljs-function"><span class="hljs-params">(my, card)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> my.countInDeck(card) - my.countInHand(card)

  <span class="hljs-attribute">countInDraw</span>: <span class="hljs-function"><span class="hljs-params">(my, card)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> my.countInDeck(card) - my.countInHand(card) - my.countInDiscard(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h3 id="backwards-compatible-choices">Backwards-compatible choices</h3>
<p>To avoid having to rewrite all the code at once, we support these functions
that pass <code>chooseAction</code> onto <code>choose(&#39;action&#39;)</code>, and so on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">chooseAction</span>: <span class="hljs-function"><span class="hljs-params">(state, choices)</span> -&gt;</span> <span class="hljs-keyword">this</span>.choose(<span class="hljs-string">'play'</span>, state, choices)
  <span class="hljs-attribute">chooseTreasure</span>: <span class="hljs-function"><span class="hljs-params">(state, choices)</span> -&gt;</span> <span class="hljs-keyword">this</span>.choose(<span class="hljs-string">'play'</span>, state, choices)
  <span class="hljs-attribute">chooseGain</span>: <span class="hljs-function"><span class="hljs-params">(state, choices)</span> -&gt;</span> <span class="hljs-keyword">this</span>.choose(<span class="hljs-string">'gain'</span>, state, choices)
  <span class="hljs-attribute">chooseDiscard</span>: <span class="hljs-function"><span class="hljs-params">(state, choices)</span> -&gt;</span> <span class="hljs-keyword">this</span>.choose(<span class="hljs-string">'discard'</span>, state, choices)
  <span class="hljs-attribute">chooseTrash</span>: <span class="hljs-function"><span class="hljs-params">(state, choices)</span> -&gt;</span> <span class="hljs-keyword">this</span>.choose(<span class="hljs-string">'trash'</span>, state, choices)</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h2 id="default-strategies">Default strategies</h2>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>The default buying strategy is a form of Big Money that has, by now,
been beaten by the newer one in BigMoney.coffee.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">gainPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [
    <span class="hljs-string">"Colony"</span> <span class="hljs-keyword">if</span> my.countInDeck(<span class="hljs-string">"Platinum"</span>) &gt; <span class="hljs-number">0</span>
    <span class="hljs-string">"Province"</span> <span class="hljs-keyword">if</span> state.countInSupply(<span class="hljs-string">"Colony"</span>) &lt;= <span class="hljs-number">6</span>
    <span class="hljs-string">"Duchy"</span> <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt; state.gainsToEndGame() &lt;= <span class="hljs-number">5</span>
    <span class="hljs-string">"Estate"</span> <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt; state.gainsToEndGame() &lt;= <span class="hljs-number">2</span>
    <span class="hljs-string">"Platinum"</span>
    <span class="hljs-string">"Gold"</span>
    <span class="hljs-string">"Silver"</span>
    <span class="hljs-string">"Copper"</span> <span class="hljs-keyword">if</span> state.gainsToEndGame() &lt;= <span class="hljs-number">3</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>gainValue covers cases where a strategy has to gain a card that isn’t in
its priority list. The default is to favor more expensive cards,
particularly action and treasure cards.</p>
<p>It is important for all these values to be negative, to avoid giving defined
strategies cards they don’t actually want.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">gainValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span>
    card.cost + <span class="hljs-number">2</span>*card.costPotion + card.isTreasure + card.isAction - <span class="hljs-number">20</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>This used to be the default action-playing priority. Now the value of playing
a card is defined on the “ai_playValue” function of each card.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">old_actionPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my, skipMultipliers = <span class="hljs-literal">false</span>)</span> -&gt;</span> 
    wantsToTrash = <span class="hljs-keyword">this</span>.wantsToTrash(state)
    countInHandCopper = my.countInHand(<span class="hljs-string">"Copper"</span>)
    currentAction = my.getCurrentAction()
    multiplier = <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> currentAction?.isMultiplier
      multiplier = currentAction.multiplier
    
    wantsToPlayMultiplier = <span class="hljs-literal">false</span>
    okayToPlayMultiplier = <span class="hljs-literal">false</span>

    <span class="hljs-keyword">unless</span> skipMultipliers
      mults = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.hand <span class="hljs-keyword">when</span> card.isMultiplier)
      <span class="hljs-keyword">if</span> mults.length &gt; <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>We’ve got a multiplier in hand. Figure out if we want to play it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        mult = mults[<span class="hljs-number">0</span>]
        choices = my.hand.slice(<span class="hljs-number">0</span>)
        choices.remove(mult)
        choices.push(<span class="hljs-literal">null</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Determine if it’s better than nothing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        choice1 = <span class="hljs-keyword">this</span>.choose(<span class="hljs-string">'multipliedAction'</span>, state, choices)
        <span class="hljs-keyword">if</span> choice1 <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
          okayToPlayMultiplier = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Now add the “wait” option and see if we want to multiply an action
<em>right now</em>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> choices.length &gt; <span class="hljs-number">1</span>
          choices.push(<span class="hljs-string">"wait"</span>)
        choice = <span class="hljs-keyword">this</span>.choose(<span class="hljs-string">'multipliedAction'</span>, state, choices)
        <span class="hljs-keyword">if</span> choice != <span class="hljs-string">"wait"</span>
          wantsToPlayMultiplier = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Priority 1: cards that succeed if we play them now, and might
not if we play them later. (950-999)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    [<span class="hljs-string">"Menagerie"</span> <span class="hljs-keyword">if</span> my.menagerieDraws() == <span class="hljs-number">3</span>
    <span class="hljs-string">"Shanty Town"</span> <span class="hljs-keyword">if</span> my.shantyTownDraws(<span class="hljs-literal">true</span>) == <span class="hljs-number">2</span>
    <span class="hljs-string">"Tournament"</span> <span class="hljs-keyword">if</span> my.countInHand(<span class="hljs-string">"Province"</span>) &gt; <span class="hljs-number">0</span>
    <span class="hljs-string">"Library"</span> <span class="hljs-keyword">if</span> my.hand.length &lt;= <span class="hljs-number">3</span> <span class="hljs-keyword">and</span> my.actions &gt; <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>2: Multipliers that do something sufficiently cool. (900-949)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"Throne Room"</span> <span class="hljs-keyword">if</span> wantsToPlayMultiplier
    <span class="hljs-string">"King's Court"</span> <span class="hljs-keyword">if</span> wantsToPlayMultiplier</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>3: cards that stack the deck. (850-899)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"Lookout"</span> <span class="hljs-keyword">if</span> state.gainsToEndGame() &gt;= <span class="hljs-number">5</span> <span class="hljs-keyword">or</span> state.cardInfo.Curse <span class="hljs-keyword">in</span> my.draw
    <span class="hljs-string">"Cartographer"</span>
    <span class="hljs-string">"Bag of Gold"</span>
    <span class="hljs-string">"Apothecary"</span>
    <span class="hljs-string">"Scout"</span>
    <span class="hljs-string">"Scrying Pool"</span>
    <span class="hljs-string">"Spy"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>4: cards that give +2 actions. (800-849)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"Trusty Steed"</span>
    <span class="hljs-string">"Festival"</span>
    <span class="hljs-string">"University"</span>
    <span class="hljs-string">"Farming Village"</span>
    <span class="hljs-string">"Bazaar"</span>
    <span class="hljs-string">"Worker's Village"</span>
    <span class="hljs-string">"City"</span>
    <span class="hljs-string">"Walled Village"</span>
    <span class="hljs-string">"Fishing Village"</span>
    <span class="hljs-string">"Village"</span>
    <span class="hljs-string">"Border Village"</span>
    <span class="hljs-string">"Mining Village"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>5: cards that give +1 action and are almost always good. (700-800)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"Grand Market"</span>
    <span class="hljs-string">"Hunting Party"</span>
    <span class="hljs-string">"Alchemist"</span>
    <span class="hljs-string">"Laboratory"</span>
    <span class="hljs-string">"Caravan"</span>
    <span class="hljs-string">"Market"</span>
    <span class="hljs-string">"Peddler"</span>
    <span class="hljs-string">"Treasury"</span>
    <span class="hljs-string">"Conspirator"</span> <span class="hljs-keyword">if</span> my.inPlay.length &gt;= <span class="hljs-number">2</span> <span class="hljs-keyword">or</span> multiplier &gt; <span class="hljs-number">1</span>
    <span class="hljs-string">"Familiar"</span>
    <span class="hljs-string">"Highway"</span>
    <span class="hljs-string">"Scheme"</span>
    <span class="hljs-string">"Wishing Well"</span>
    <span class="hljs-string">"Golem"</span>  <span class="hljs-comment"># seems to be reasonable to expect +1 action from Golem</span>
    <span class="hljs-string">"Great Hall"</span> <span class="hljs-keyword">if</span> state.cardInfo.Crossroads <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> my.hand
    <span class="hljs-string">"Spice Merchant"</span> <span class="hljs-keyword">if</span> state.cardInfo.Copper <span class="hljs-keyword">in</span> my.hand
    <span class="hljs-string">"Stables"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.choose(<span class="hljs-string">'stablesDiscard'</span>, state, my.hand.concat([<span class="hljs-literal">null</span>]))
    <span class="hljs-string">"Apprentice"</span>
    <span class="hljs-string">"Pearl Diver"</span>
    <span class="hljs-string">"Hamlet"</span>
    <span class="hljs-string">"Lighthouse"</span>
    <span class="hljs-string">"Haven"</span>
    <span class="hljs-string">"Minion"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>6: terminal card-drawers, if we have actions to spare. (600-699)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"Library"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> my.hand.length &lt;= <span class="hljs-number">4</span>  <span class="hljs-comment"># 695</span>
    <span class="hljs-string">"Torturer"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span>
    <span class="hljs-string">"Margrave"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span>
    <span class="hljs-string">"Rabble"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span>
    <span class="hljs-string">"Witch"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span>
    <span class="hljs-string">"Ghost Ship"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span>
    <span class="hljs-string">"Smithy"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span>
    <span class="hljs-string">"Embassy"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span>
    <span class="hljs-string">"Watchtower"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> my.hand.length &lt;= <span class="hljs-number">4</span>
    <span class="hljs-string">"Library"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> my.hand.length &lt;= <span class="hljs-number">5</span> <span class="hljs-comment"># 620</span>
    <span class="hljs-string">"Council Room"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span>
    <span class="hljs-string">"Courtyard"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (my.discard.length + my.draw.length) &lt;= <span class="hljs-number">3</span>
    <span class="hljs-string">"Oracle"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>7: Let’s insert here an overly simplistic idea of how to play Crossroads.
Or if we don’t have a Crossroads, play a Great Hall that we might otherwise
have played in priority level 5. (500-599)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"Crossroads"</span> <span class="hljs-keyword">unless</span> my.countInPlay(state.cardInfo.Crossroads) &gt; <span class="hljs-number">0</span>
    <span class="hljs-string">"Great Hall"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>8: card-cycling that might improve the hand. (400-499)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"Upgrade"</span> <span class="hljs-keyword">if</span> wantsToTrash &gt;= multiplier
    <span class="hljs-string">"Oasis"</span>
    <span class="hljs-string">"Pawn"</span>
    <span class="hljs-string">"Warehouse"</span>
    <span class="hljs-string">"Cellar"</span>
    <span class="hljs-string">"Library"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> my.hand.length &lt;= <span class="hljs-number">6</span>
    <span class="hljs-string">"Spice Merchant"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.choose(<span class="hljs-string">'spiceMerchantTrash'</span>, state, my.hand.concat([<span class="hljs-literal">null</span>]))</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>9: non-terminal cards that don’t succeed but at least give us something. (300-399)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"King's Court"</span>
    <span class="hljs-string">"Throne Room"</span> <span class="hljs-keyword">if</span> okayToPlayMultiplier
    <span class="hljs-string">"Tournament"</span>
    <span class="hljs-string">"Menagerie"</span>
    <span class="hljs-string">"Shanty Town"</span> <span class="hljs-keyword">if</span> my.actions &lt; <span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>10: terminals. Of course, Nobles might be a non-terminal
if we decide we need the actions more than the cards. (100-299)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"Crossroads"</span>
    <span class="hljs-string">"Nobles"</span>
    <span class="hljs-string">"Treasure Map"</span> <span class="hljs-keyword">if</span> my.countInHand(<span class="hljs-string">"Treasure Map"</span>) &gt;= <span class="hljs-number">2</span>
    <span class="hljs-string">"Followers"</span>
    <span class="hljs-string">"Mountebank"</span> <span class="hljs-comment"># 290</span>
    <span class="hljs-string">"Witch"</span>
    <span class="hljs-string">"Sea Hag"</span>
    <span class="hljs-string">"Torturer"</span>
    <span class="hljs-string">"Young Witch"</span>
    <span class="hljs-string">"Tribute"</span> <span class="hljs-comment"># after Cursers but before other terminals, there is probably a better spot for it</span>
    <span class="hljs-string">"Margrave"</span> <span class="hljs-comment"># 280</span>
    <span class="hljs-string">"Goons"</span>
    <span class="hljs-string">"Wharf"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Tactician needs a play condition, but I don’t know what it would be.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"Tactician"</span> 
    <span class="hljs-string">"Masquerade"</span> <span class="hljs-comment"># 270</span>
    <span class="hljs-string">"Vault"</span> 
    <span class="hljs-string">"Ghost Ship"</span>
    <span class="hljs-string">"Princess"</span> 
    <span class="hljs-string">"Explorer"</span> <span class="hljs-keyword">if</span> my.countInHand(<span class="hljs-string">"Province"</span>) &gt;= <span class="hljs-number">1</span>
    <span class="hljs-string">"Library"</span> <span class="hljs-keyword">if</span> my.hand.length &lt;= <span class="hljs-number">3</span>  <span class="hljs-comment"># 260</span>
    <span class="hljs-string">"Jester"</span>
    <span class="hljs-string">"Militia"</span>
    <span class="hljs-string">"Cutpurse"</span>  <span class="hljs-comment"># 250</span>
    <span class="hljs-string">"Bridge"</span>
    <span class="hljs-string">"Bishop"</span>
    <span class="hljs-string">"Horse Traders"</span>  <span class="hljs-comment"># 240</span>
    <span class="hljs-string">"Jack of All Trades"</span>
    <span class="hljs-string">"Steward"</span>
    <span class="hljs-string">"Moneylender"</span> <span class="hljs-keyword">if</span> countInHandCopper &gt;= <span class="hljs-number">1</span> <span class="hljs-comment"># 230</span>
    <span class="hljs-string">"Expand"</span>
    <span class="hljs-string">"Remodel"</span>  
    <span class="hljs-string">"Salvager"</span> <span class="hljs-comment"># 220</span>
    <span class="hljs-string">"Mine"</span>
    <span class="hljs-string">"Coppersmith"</span> <span class="hljs-keyword">if</span> countInHandCopper &gt;= <span class="hljs-number">3</span>
    <span class="hljs-string">"Library"</span> <span class="hljs-keyword">if</span> my.hand.length &lt;= <span class="hljs-number">4</span>  <span class="hljs-comment"># 210</span>
    <span class="hljs-string">"Rabble"</span>
    <span class="hljs-string">"Envoy"</span>
    <span class="hljs-string">"Smithy"</span>   <span class="hljs-comment"># 200</span>
    <span class="hljs-string">"Embassy"</span>
    <span class="hljs-string">"Watchtower"</span> <span class="hljs-keyword">if</span> my.hand.length &lt;= <span class="hljs-number">3</span>
    <span class="hljs-string">"Council Room"</span>
    <span class="hljs-string">"Library"</span> <span class="hljs-keyword">if</span> my.hand.length &lt;= <span class="hljs-number">5</span>
    <span class="hljs-string">"Watchtower"</span> <span class="hljs-keyword">if</span> my.hand.length &lt;= <span class="hljs-number">4</span>  <span class="hljs-comment"># 190</span>
    <span class="hljs-string">"Courtyard"</span> <span class="hljs-keyword">if</span> (my.discard.length + my.draw.length) &gt; <span class="hljs-number">0</span>
    <span class="hljs-string">"Merchant Ship"</span>
    <span class="hljs-string">"Baron"</span> <span class="hljs-keyword">if</span> my.countInHand(<span class="hljs-string">"Estate"</span>) &gt;= <span class="hljs-number">1</span>
    <span class="hljs-string">"Monument"</span>
    <span class="hljs-string">"Oracle"</span> <span class="hljs-comment"># 180</span>
    <span class="hljs-string">"Remake"</span> <span class="hljs-keyword">if</span> wantsToTrash &gt;= multiplier * <span class="hljs-number">2</span>   <span class="hljs-comment"># has a low priority so it'll mostly be played early in the game</span>
    <span class="hljs-string">"Adventurer"</span>
    <span class="hljs-string">"Harvest"</span>
    <span class="hljs-string">"Haggler"</span> <span class="hljs-comment"># probably needs to make sure the gained card will be wanted; 170</span>
    <span class="hljs-string">"Mandarin"</span>
    <span class="hljs-string">"Explorer"</span>
    <span class="hljs-string">"Woodcutter"</span>
    <span class="hljs-string">"Nomad Camp"</span>
    <span class="hljs-string">"Chancellor"</span> <span class="hljs-comment"># 160</span>
    <span class="hljs-string">"Counting House"</span>
    <span class="hljs-string">"Coppersmith"</span> <span class="hljs-keyword">if</span> countInHandCopper &gt;= <span class="hljs-number">2</span>
    <span class="hljs-string">"Outpost"</span> <span class="hljs-keyword">if</span> state.extraturn == <span class="hljs-literal">false</span>
    <span class="hljs-string">"Ambassador"</span> <span class="hljs-keyword">if</span> wantsToTrash <span class="hljs-comment"># 150</span>
    <span class="hljs-string">"Trading Post"</span> <span class="hljs-keyword">if</span> wantsToTrash + my.countInHand(<span class="hljs-string">"Silver"</span>) &gt;= <span class="hljs-number">2</span> * multiplier
    <span class="hljs-string">"Chapel"</span> <span class="hljs-keyword">if</span> wantsToTrash
    <span class="hljs-string">"Trader"</span> <span class="hljs-keyword">if</span> wantsToTrash &gt;= multiplier
    <span class="hljs-string">"Trade Route"</span> <span class="hljs-keyword">if</span> wantsToTrash &gt;= multiplier
    <span class="hljs-string">"Mint"</span> <span class="hljs-keyword">if</span> my.ai.choose(<span class="hljs-string">'mint'</span>, state, my.hand) <span class="hljs-comment"># 140</span>
    <span class="hljs-string">"Secret Chamber"</span>
    <span class="hljs-string">"Pirate Ship"</span>
    <span class="hljs-string">"Noble Brigand"</span>
    <span class="hljs-string">"Thief"</span>
    <span class="hljs-string">"Island"</span>  <span class="hljs-comment"># could be moved</span>
    <span class="hljs-string">"Fortune Teller"</span> <span class="hljs-comment"># 130</span>
    <span class="hljs-string">"Bureaucrat"</span>
    <span class="hljs-string">"Navigator"</span>
    <span class="hljs-string">"Conspirator"</span> <span class="hljs-keyword">if</span> my.actions &lt; <span class="hljs-number">2</span>
    <span class="hljs-string">"Herbalist"</span>
    <span class="hljs-string">"Moat"</span>  <span class="hljs-comment"># 120</span>
    <span class="hljs-string">"Library"</span> <span class="hljs-keyword">if</span> my.hand.length &lt;= <span class="hljs-number">6</span>
    <span class="hljs-string">"Ironworks"</span> <span class="hljs-comment"># should have higher priority if condition can see it will gain an Action card</span>
    <span class="hljs-string">"Workshop"</span>
    <span class="hljs-string">"Smugglers"</span> <span class="hljs-keyword">if</span> state.smugglerChoices().length &gt; <span class="hljs-number">1</span> <span class="hljs-comment"># 110</span>
    <span class="hljs-string">"Feast"</span>
    <span class="hljs-string">"Transmute"</span> <span class="hljs-keyword">if</span> wantsToTrash &gt;= multiplier
    <span class="hljs-string">"Coppersmith"</span>
    <span class="hljs-string">"Saboteur"</span>
    <span class="hljs-string">"Poor House"</span>
    <span class="hljs-string">"Duchess"</span>
    <span class="hljs-string">"Library"</span> <span class="hljs-keyword">if</span> my.hand.length &lt;= <span class="hljs-number">7</span>
    <span class="hljs-string">"Thief"</span>  <span class="hljs-comment"># 100</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>11: cards that have become useless. Maybe they’ll decrease
the cost of Peddler, trigger Conspirator, or something. (20-99)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"Treasure Map"</span> <span class="hljs-keyword">if</span> my.countInDeck(<span class="hljs-string">"Gold"</span>) &gt;= <span class="hljs-number">4</span> <span class="hljs-keyword">and</span> state.current.countInDeck(<span class="hljs-string">"Treasure Map"</span>) == <span class="hljs-number">1</span>
    <span class="hljs-string">"Spice Merchant"</span>
    <span class="hljs-string">"Shanty Town"</span>
    <span class="hljs-string">"Stables"</span> <span class="hljs-comment"># 50</span>
    <span class="hljs-string">"Chapel"</span>
    <span class="hljs-string">"Library"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>12: Conspirator when +actions remain. (10)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"Conspirator"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>   “Baron”</p>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>At this point, we take no action if that choice is available.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Nope, something is forcing us to take an action.</p>
<p>Last priority: cards that are actively harmful to play at this point,
in order of increasing badness.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">"Baron"</span>
    <span class="hljs-string">"Mint"</span>
    <span class="hljs-string">"Watchtower"</span>
    <span class="hljs-string">"Outpost"</span>
    <span class="hljs-string">"Ambassador"</span> <span class="hljs-comment"># -20</span>
    <span class="hljs-string">"Trader"</span>
    <span class="hljs-string">"Transmute"</span>
    <span class="hljs-string">"Trade Route"</span>
    <span class="hljs-string">"Upgrade"</span>  <span class="hljs-comment"># -30</span>
    <span class="hljs-string">"Remake"</span>
    <span class="hljs-string">"Trading Post"</span>
    <span class="hljs-string">"Treasure Map"</span> <span class="hljs-comment"># -40</span>
    <span class="hljs-string">"Throne Room"</span>
    ]</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p><code>multipliedActionPriority</code> is similar to <code>actionPriority</code>, but is used when
we have played a Throne Room or King’s Court.</p>
<p>This list emphasizes cards that are really good when multiplied, especially
terminals when there are +actions left. At the end, it falls back on the
usual actionPriority list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">old_multipliedActionPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    [
      <span class="hljs-string">"King's Court"</span>  <span class="hljs-comment"># 2000</span>
      <span class="hljs-string">"Throne Room"</span>   <span class="hljs-comment"># 1900</span>
      <span class="hljs-string">"Followers"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> 
      <span class="hljs-string">"Grand Market"</span>
      <span class="hljs-string">"Mountebank"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Witch"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> state.countInSupply(<span class="hljs-string">"Curse"</span>) &gt;= <span class="hljs-number">2</span>
      <span class="hljs-string">"Sea Hag"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> state.countInSupply(<span class="hljs-string">"Curse"</span>) &gt;= <span class="hljs-number">2</span>
      <span class="hljs-string">"Torturer"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> state.countInSupply(<span class="hljs-string">"Curse"</span>) &gt;= <span class="hljs-number">2</span>
      <span class="hljs-string">"Young Witch"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> state.countInSupply(<span class="hljs-string">"Curse"</span>) &gt;= <span class="hljs-number">2</span>
      <span class="hljs-string">"Crossroads"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> my.countInPlay(state.cardInfo.Crossroads) == <span class="hljs-number">0</span>  <span class="hljs-comment"># 1800</span>
      <span class="hljs-string">"Scheme"</span> <span class="hljs-keyword">if</span> my.countInDeck(<span class="hljs-string">"King's Court"</span>) &gt;= <span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Scrying Pool was here once, but I think you’d rather use it to <em>draw</em>
actions for your KC</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-string">"Wharf"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Bridge"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Minion"</span>  <span class="hljs-comment"># 1700</span>
      <span class="hljs-string">"Ghost Ship"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Jester"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Horse Traders"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Mandarin"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Rabble"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>  <span class="hljs-comment"># 1600</span>
      <span class="hljs-string">"Council Room"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Margrave"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Smithy"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Embassy"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Merchant Ship"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>  <span class="hljs-comment"># 1500</span>
      <span class="hljs-string">"Pirate Ship"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Saboteur"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Noble Brigand"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Thief"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Monument"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>  <span class="hljs-comment"># 1400</span>
      <span class="hljs-string">"Feast"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Conspirator"</span>
      <span class="hljs-string">"Nobles"</span>
      <span class="hljs-string">"Tribute"</span>
      <span class="hljs-string">"Steward"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>  <span class="hljs-comment"># 1300</span>
      <span class="hljs-string">"Goons"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Mine"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Masquerade"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Vault"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Oracle"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>  <span class="hljs-comment"># 1200</span>
      <span class="hljs-string">"Cutpurse"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span>
      <span class="hljs-string">"Coppersmith"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> my.countInHand(<span class="hljs-string">"Copper"</span>) &gt;= <span class="hljs-number">2</span>
      <span class="hljs-string">"Ambassador"</span> <span class="hljs-keyword">if</span> my.actions &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">this</span>.wantsToTrash(state)  <span class="hljs-comment"># 1100</span>
      <span class="hljs-string">"wait"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>We could add here some more cards that would be nice to play with a
multiplier. Nicer than Lookout, let’s say, which appears pretty high
on the regular action priority list.</p>
<p>But at this point, just fall back on that priority list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ].concat(<span class="hljs-keyword">this</span>.old_actionPriority(state, my, skipMultipliers=<span class="hljs-literal">true</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p><code>treasurePriority</code> determines what order to play treasures in.
Most of the order has no effect on gameplay. The
important part is that Bank and Horn of Plenty are last.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">treasurePriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [
    <span class="hljs-string">"Platinum"</span>
    <span class="hljs-string">"Diadem"</span>
    <span class="hljs-string">"Philosopher's Stone"</span>
    <span class="hljs-string">"Gold"</span>
    <span class="hljs-string">"Cache"</span>
    <span class="hljs-string">"Hoard"</span>
    <span class="hljs-string">"Royal Seal"</span>
    <span class="hljs-string">"Harem"</span>
    <span class="hljs-string">"Silver"</span>
    <span class="hljs-string">"Fool's Gold"</span>
    <span class="hljs-string">"Quarry"</span>
    <span class="hljs-string">"Talisman"</span>
    <span class="hljs-string">"Copper"</span>
    <span class="hljs-string">"Masterpiece"</span>
    <span class="hljs-string">"Potion"</span>  <span class="hljs-comment"># 100 from here up</span>
    <span class="hljs-string">"Loan"</span>    <span class="hljs-comment"># 90</span>
    <span class="hljs-string">"Venture"</span> <span class="hljs-comment"># 80</span>
    <span class="hljs-string">"Ill-Gotten Gains"</span>
    <span class="hljs-string">"Bank"</span>
    <span class="hljs-string">"Horn of Plenty"</span> <span class="hljs-keyword">if</span> my.numUniqueCardsInPlay() &gt;= <span class="hljs-number">2</span>
    <span class="hljs-string">"Spoils"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.wantsToPlaySpoils(state)
    <span class="hljs-literal">null</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>The default <code>discardPriority</code> is tuned for Big Money where the decisions
are obvious. But many strategies would probably prefer a different
priority list, especially one that knows about action cards.</p>
<p>It doesn’t understand
discarding cards to make Shanty Town or Menagerie work, for example.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">discardPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [
    <span class="hljs-string">"Tunnel"</span>
    <span class="hljs-string">"Vineyard"</span>
    <span class="hljs-string">"Colony"</span>
    <span class="hljs-string">"Duke"</span>
    <span class="hljs-string">"Duchy"</span>
    <span class="hljs-string">"Fairgrounds"</span>
    <span class="hljs-string">"Gardens"</span>
    <span class="hljs-string">"Province"</span>  <span class="hljs-comment"># Provinces are occasionally useful in hand</span>
    <span class="hljs-string">"Curse"</span>
    <span class="hljs-string">"Estate"</span>
  ]

  <span class="hljs-attribute">discardValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>If we can discard excess actions, do so. Otherwise, discard the cheapest
cards. Victory cards would already have been discarded by discardPriority,
but if Tunnel fell through somehow we discard it here.</p>
<p>First, check to see if it’s our turn. That changes whether we want to discard
actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    myTurn = (state.current == my)
    <span class="hljs-keyword">if</span> card.name == <span class="hljs-string">'Tunnel'</span>
      <span class="hljs-number">25</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> card.isAction <span class="hljs-keyword">and</span> myTurn <span class="hljs-keyword">and</span> \
         ((card.actions == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> my.actionBalance() &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">or</span> (my.actions == <span class="hljs-number">0</span>))
      <span class="hljs-number">20</span> - card.cost
    <span class="hljs-keyword">else</span>
      <span class="hljs-number">0</span> - card.cost

  <span class="hljs-attribute">trashPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [
    <span class="hljs-string">"Curse"</span>
    <span class="hljs-string">"Estate"</span> <span class="hljs-keyword">if</span> state.gainsToEndGame() &gt; <span class="hljs-number">4</span>
    <span class="hljs-string">"Copper"</span> <span class="hljs-keyword">if</span> my.getTotalMoney() &gt; <span class="hljs-number">4</span>
    <span class="hljs-string">"Potion"</span> <span class="hljs-keyword">if</span> my.turnsTaken &gt;= <span class="hljs-number">10</span>
    <span class="hljs-string">"Estate"</span> <span class="hljs-keyword">if</span> state.gainsToEndGame() &gt; <span class="hljs-number">2</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>If we have to trash a card we don’t want to, assign a value to each card.
By default, we want to trash the card with the lowest (cost + VP).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">trashValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span>
    <span class="hljs-number">0</span> - card.vp - card.cost</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>developPriority: (state, my) =&gt; 
  trashPriority(state, my)</p>

            </div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>developValue: (state, card, my) =&gt;
 this.trashValue(state, card, my)</p>

            </div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Some cards give you a choice to discard an opponent’s deck. These are
evaluated with <code>discardFromOpponentDeckValue</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">discardFromOpponentDeckValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> card.name == <span class="hljs-string">'Tunnel'</span>
      <span class="hljs-keyword">return</span> -<span class="hljs-number">2000</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (card.isAction) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (card.isTreasure)
      <span class="hljs-keyword">return</span> -<span class="hljs-number">10</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> card.coins + card.cost + <span class="hljs-number">2</span>*card.isAttack</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p><code>discardHandValue</code> decides whether to discard an entire hand of cards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">discardHandValue</span>: <span class="hljs-function"><span class="hljs-params">(state, hand, my, nCards = <span class="hljs-number">5</span>)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> hand <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
    deck = my.discard.concat(my.draw)
    total = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>.<span class="hljs-number">.5</span>]
      shuffle(deck)
      randomHand = deck[<span class="hljs-number">0.</span>..nCards]</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>If a random hand from this deck is better, discard this hand.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      total += my.ai.compareByDiscarding(state, randomHand, hand)
    <span class="hljs-keyword">return</span> total</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Prefer to gain action and treasure cards on the deck, assuming we want
them at all. Give other cards a value of -1 so that <code>null</code> is a better
choice.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">gainOnDeckValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> (card.isAction <span class="hljs-keyword">or</span> card.isTreasure)
      <span class="hljs-keyword">this</span>.getChoiceValue(<span class="hljs-string">'gain'</span>, state, card, my)
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Changed Priorities for putting cards back on deck.  Only works well for putting back 1 card, and for 1 buy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">putOnDeckPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Make a priority order of:</p>
<ol>
<li>Actions we can’t or don’t intend to play, from best to worst</li>
<li>Treasures we can afford to put back</li>
<li>Junk cards</li>
</ol>

            </div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>1) Actions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    actions = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.hand <span class="hljs-keyword">when</span> card.isAction)
    getChoiceValue = <span class="hljs-keyword">this</span>.getChoiceValue
    <span class="hljs-function"><span class="hljs-title">byPlayValue</span> = <span class="hljs-params">(x, y)</span> -&gt;</span>
      getChoiceValue(<span class="hljs-string">'play'</span>, state, y, my) - getChoiceValue(<span class="hljs-string">'play'</span>, state, x, my)

    actions.sort(byPlayValue)
    putBack = actions[my.countPlayableTerminals(state) ...]</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>2) Put back as much money as you can</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> putBack.length == <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Get a list of all distinct treasures in hand, in order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      treasures = []
      <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.hand
        <span class="hljs-keyword">if</span> (card.isTreasure) <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> (card <span class="hljs-keyword">in</span> treasures))
          treasures.push card
      treasures.sort<span class="hljs-function"><span class="hljs-params">( (x, y) -&gt; y.coins - x.coins )</span>

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Get the margin of how much money we’re willing to discard.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      margin = my.ai.coinLossMargin(state)</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Find the treasure cards worth less than that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> treasures
        <span class="hljs-keyword">if</span> my.ai.coinsDueToCard(state, card) &lt;= margin
          putBack.push(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Don’t put back last Potion if Alchemists are in play</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> my.countInPlay(state.cardInfo[<span class="hljs-string">"Alchemist"</span>])&gt;<span class="hljs-number">0</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">"Potion"</span> <span class="hljs-keyword">in</span> putBack
          putBack.remove(state.cardInfo[<span class="hljs-string">"Potion"</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>3) Put back the worst card (take priority for discard)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> putBack.length == <span class="hljs-number">0</span>
      putBack = [my.ai.choose(<span class="hljs-string">'discard'</span>, state, my.hand)]

    putBack
  
  <span class="hljs-attribute">putOnDeckValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> =&gt;</span>
    <span class="hljs-keyword">this</span>.discardValue(state, card, my)</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>How much does the AI want to discard its deck right now (for Chancellor)?
Here, we decide to reshuffle (returning a reshuffleValue over 0) when most
of the non-Action, non-Treasure cards are in the draw pile, or when there
are no such cards in the deck.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">reshuffleValue</span>: <span class="hljs-function"><span class="hljs-params">(state, choice, my)</span> -&gt;</span>
    junkToDraw = <span class="hljs-number">0</span>
    totalJunk = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.draw
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (card.isAction <span class="hljs-keyword">or</span> card.isTreasure)
        junkToDraw++
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.getDeck()
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (card.isAction <span class="hljs-keyword">or</span> card.isTreasure)
        totalJunk++
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> (totalJunk == <span class="hljs-number">0</span>)
    proportion = junkToDraw/totalJunk
    <span class="hljs-keyword">return</span> (proportion - <span class="hljs-number">0.5</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Choose opponent treasure to trash; go by the card’s base cost.
Diadems are comparable to the cost-5 treasures.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">trashOppTreasureValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> =&gt;</span>
    <span class="hljs-keyword">if</span> card <span class="hljs-keyword">is</span> <span class="hljs-string">'Diadem'</span>
      <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>
    <span class="hljs-keyword">return</span> card.cost</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <h3 id="decisions-for-particular-cards">Decisions for particular cards</h3>

            </div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p><code>ambassadorPriority</code> chooses a card to Ambassador and how many of it to
return.</p>
<p>These choices may look odd: remember that choices are evaluated as strings.
So if we return lists, they won’t match any of the choices. We need to
return their joined string versions.</p>
<p>This is a moderately acceptable way to deal with the fact that, in
JavaScript, lists are never “equal” to other lists anyway.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ambassadorPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    [
      <span class="hljs-string">"[Curse, 2]"</span>
      <span class="hljs-string">"[Curse, 1]"</span>
      <span class="hljs-string">"[Curse, 0]"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Handle a silly case:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-string">"[Ambassador, 2]"</span>
      <span class="hljs-string">"[Estate, 2]"</span>
      <span class="hljs-string">"[Estate, 1]"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Make sure we have at least $5 in the deck, including if we buy a Silver.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-string">"[Copper, 2]"</span> <span class="hljs-keyword">if</span> my.getTreasureInHand() &lt; <span class="hljs-number">3</span> <span class="hljs-keyword">and</span> my.getTotalMoney() &gt;= <span class="hljs-number">5</span>
      <span class="hljs-string">"[Copper, 2]"</span> <span class="hljs-keyword">if</span> my.getTreasureInHand() &gt;= <span class="hljs-number">5</span>
      <span class="hljs-string">"[Copper, 2]"</span> <span class="hljs-keyword">if</span> my.getTreasureInHand() == <span class="hljs-number">3</span> <span class="hljs-keyword">and</span> my.getTotalMoney() &gt;= <span class="hljs-number">7</span>
      <span class="hljs-string">"[Copper, 1]"</span> <span class="hljs-keyword">if</span> my.getTreasureInHand() &lt; <span class="hljs-number">3</span> <span class="hljs-keyword">and</span> my.getTotalMoney() &gt;= <span class="hljs-number">4</span>
      <span class="hljs-string">"[Copper, 1]"</span> <span class="hljs-keyword">if</span> my.getTreasureInHand() &gt;= <span class="hljs-number">4</span>
      <span class="hljs-string">"[Estate, 0]"</span>
      <span class="hljs-string">"[Copper, 0]"</span>
      <span class="hljs-string">"[Potion, 2]"</span>
      <span class="hljs-string">"[Potion, 1]"</span>
      <span class="hljs-literal">null</span>
    ].concat (<span class="hljs-string">"[<span class="hljs-subst">#{card}</span>, 1]"</span> <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.ai.trashPriority(state, my) <span class="hljs-keyword">when</span> card?)\
    .concat (<span class="hljs-string">"[<span class="hljs-subst">#{card}</span>, 0]"</span> <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.hand)
  
  <span class="hljs-attribute">apprenticeTrashPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-string">"Border Village"</span>
    <span class="hljs-string">"Mandarin"</span>
    <span class="hljs-string">"Ill-Gotten Gains"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.coinLossMargin(state) &gt; <span class="hljs-number">0</span>
    <span class="hljs-string">"Feodum"</span>
    <span class="hljs-string">"Estate"</span>
    <span class="hljs-string">"Curse"</span>
    <span class="hljs-string">"Apprentice"</span>
  
  <span class="hljs-attribute">apprenticeTrashValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span>
    vp = card.getVP(my)
    [coins, potions] = card.getCost(state)
    drawn = Math.min(my.draw.length + my.discard.length, coins+<span class="hljs-number">2</span>*potions)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.choiceToValue(<span class="hljs-string">'trash'</span>, state, card) + <span class="hljs-number">2</span>*drawn - vp</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>The question here is: do you want to discard an Estate using a Baron?
And the answer is yes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">baronDiscardPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [<span class="hljs-literal">yes</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p><code>bishopTrashPriority</code> lists cards that are especially good to trash.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">bishopTrashPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [
    <span class="hljs-string">"Farmland"</span>
    <span class="hljs-string">"Duchy"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.goingGreen(state) &lt; <span class="hljs-number">3</span>
    <span class="hljs-string">"Border Village"</span>
    <span class="hljs-string">"Mandarin"</span>
    <span class="hljs-string">"Feodum"</span>
    <span class="hljs-string">"Bishop"</span>
    <span class="hljs-string">"Ill-Gotten Gains"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.coinLossMargin(state) &gt; <span class="hljs-number">0</span>
    <span class="hljs-string">"Curse"</span>
  ]

  <span class="hljs-attribute">bishopTrashValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span>
    [coins, potions] = card.getCost(state)
    value = Math.floor(coins/<span class="hljs-number">2</span>) - card.getVP(my)</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>if we’re going for victory points, that’s all we care about.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.goingGreen(state) &gt;= <span class="hljs-number">3</span>
      <span class="hljs-keyword">return</span> value</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>otherwise, focus on what we want to trash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">if</span> card <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.trashPriority(state, my)
        value += <span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> card.isAction <span class="hljs-keyword">and</span> ((card.actions == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> my.actionBalance() &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">or</span> (my.actions == <span class="hljs-number">0</span>))
        value += <span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> card.isTreasure <span class="hljs-keyword">and</span> card.coins &gt; (<span class="hljs-keyword">this</span>.coinLossMargin(state) + <span class="hljs-number">1</span>)
        value -= <span class="hljs-number">10</span>
      <span class="hljs-keyword">return</span> value

  <span class="hljs-attribute">envoyValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Choose a card to discard from your opponent’s hand when it’s their turn.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    opp = state.current
    <span class="hljs-keyword">if</span> card.name == <span class="hljs-string">'Tunnel'</span>
      <span class="hljs-keyword">return</span> -<span class="hljs-number">25</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (card.isAction) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (card.isTreasure)
      <span class="hljs-keyword">return</span> -<span class="hljs-number">10</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> opp.actions == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> card.isAction
      <span class="hljs-keyword">return</span> -<span class="hljs-number">5</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> opp.actions &gt;= <span class="hljs-number">2</span>
      <span class="hljs-keyword">return</span> card.cards + card.coins + card.cost + <span class="hljs-number">2</span>*card.isAttack
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> card.coins + card.cost + <span class="hljs-number">2</span>*card.isAttack</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p><code>foolsGoldTrashPriority</code> will trash a Fool’s Gold for a real Gold if
it’s nearing the endgame (5 gains or less), there is one FG in hand,
and losing it will not change its buy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">foolsGoldTrashPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.countInHand(state.cardInfo[<span class="hljs-string">"Fool's Gold"</span>]) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> my.ai.coinLossMargin(state) &gt;= <span class="hljs-number">1</span>
      [<span class="hljs-literal">yes</span>]
    <span class="hljs-keyword">else</span>
      [<span class="hljs-literal">no</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Do you want to gain a copper from Ill-Gotten Gains? Yes, we want if that improves our buy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">gainCopperPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.ai.coinGainMargin(state) &lt;= my.countInHand(<span class="hljs-string">"Ill-Gotten Gains"</span>)+<span class="hljs-number">1</span>
      [<span class="hljs-literal">yes</span>]
    <span class="hljs-keyword">else</span>
      [<span class="hljs-literal">no</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>The <code>herbalist</code> decision puts a treasure card back on the deck. It sounds
the same as <code>putOnDeck</code>, but it’s for a different
situation — the card is coming from in play, not from your hand. So
actually we use the <code>mintValue</code> by default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">herbalistValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> =&gt;</span>
    <span class="hljs-keyword">this</span>.mintValue(state, card, my)


  <span class="hljs-attribute">huntingGroundsGainPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [
    <span class="hljs-string">"Duchy"</span>
    <span class="hljs-string">"Estates"</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>islandPriority chooses which card to set aside with Island. At present this
list is incomplete, but covers just about everything that we would want to set aside
with an Island.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">islandPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    [
      <span class="hljs-string">"Colony"</span>
      <span class="hljs-string">"Province"</span>
      <span class="hljs-string">"Fairgrounds"</span>
      <span class="hljs-string">"Duchy"</span>
      <span class="hljs-string">"Duke"</span>
      <span class="hljs-string">"Gardens"</span>
      <span class="hljs-string">"Vineyard"</span>
      <span class="hljs-string">"Estate"</span>
      <span class="hljs-string">"Copper"</span>
      <span class="hljs-string">"Curse"</span>
      <span class="hljs-string">"Island"</span>
      <span class="hljs-string">"Tunnel"</span>
    ]
  
  <span class="hljs-attribute">islandValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span> <span class="hljs-keyword">this</span>.discardValue(state, card, my)

  <span class="hljs-attribute">librarySetAsideValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span> [
    <span class="hljs-keyword">if</span> my.actions == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> card.isAction
      <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">1</span>
  ]

  <span class="hljs-attribute">miningVillageTrashValue</span>: <span class="hljs-function"><span class="hljs-params">(state, choice, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.goingGreen(state) <span class="hljs-keyword">and</span> <span class="hljs-keyword">this</span>.coinGainMargin(state) &lt;= <span class="hljs-number">2</span>
      <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>
      -<span class="hljs-number">1</span>

  <span class="hljs-attribute">minionDiscardValue</span>: <span class="hljs-function"><span class="hljs-params">(state, choice, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> choice == <span class="hljs-literal">yes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Find out how valuable it would be to discard these cards and draw 4.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      value = <span class="hljs-keyword">this</span>.discardHandValue(state, my.hand, my, <span class="hljs-number">4</span>)
      opponent = state.players[state.players.length - <span class="hljs-number">1</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>If the attack would decrease an opponent’s hand size, it’s more valuable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> opponent.hand.length &gt; <span class="hljs-number">4</span>
        value += <span class="hljs-number">2</span>
      <span class="hljs-keyword">return</span> value
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Mint anything but Copper and Diadem. Otherwise, go mostly by the card’s base cost.
There is only 1 Diadem, never any available to gain, so never Mint it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">mintValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span> 
    <span class="hljs-keyword">return</span> card.cost - <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Choose whether we want these cards or two random cards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">oracleDiscardValue</span>: <span class="hljs-function"><span class="hljs-params">(state, cards, my)</span> -&gt;</span>
    deck = my.discard.concat(my.draw)
    shuffle(deck)
    randomCards = deck[<span class="hljs-number">0.</span>..cards.length]

    <span class="hljs-keyword">return</span> my.ai.compareByDiscarding(state, my.hand.concat(randomCards), my.hand.concat(cards))</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Choose to attack or use available coins when playing Pirate Ship.
Current strategy is basically Geronimoo’s attackUntil5Coins play strategy,
but only with Provinces—or technically, cards costing 8 or more.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">pirateShipPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [
    <span class="hljs-string">'coins'</span> <span class="hljs-keyword">if</span> state.current.mats.pirateShip &gt;= <span class="hljs-number">5</span> <span class="hljs-keyword">and</span> state.current.getAvailableMoney()+state.current.mats.pirateShip &gt;= <span class="hljs-number">8</span>
    <span class="hljs-string">'attack'</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>might want to think about something more clever, but for first, just discard Coppers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">plazaDiscardPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [
    <span class="hljs-string">"Copper"</span>
    <span class="hljs-literal">null</span>
  ]       

  <span class="hljs-attribute">rogueGainValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span>
    [coins, potions] = card.getCost(state)
    <span class="hljs-keyword">return</span> coins

  <span class="hljs-attribute">rogueTrashValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span>
    [coins, potions] = card.getCost(state)
    <span class="hljs-keyword">return</span> coins

  <span class="hljs-attribute">salvagerTrashPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span> [
    <span class="hljs-string">"Border Village"</span>
    <span class="hljs-string">"Mandarin"</span>
    <span class="hljs-string">"Ill-Gotten Gains"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.coinLossMargin(state) &gt; <span class="hljs-number">0</span>
    <span class="hljs-string">"Feodum"</span>
    <span class="hljs-string">"Salvager"</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>To calculate the salvagerTrashValue, we simulate trashing each card, determine
the best card we would buy as a result, and evaluate it as if we were
upgrading the trashed card into the bought one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">salvagerTrashValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span>
    [hypothesis, hypothetically_my] = state.hypothetical(<span class="hljs-keyword">this</span>)
    hypothetically_my.hand.remove(card)
    [coins, potions] = card.getCost(hypothesis)
    hypothetically_my.coins += coins
    hypothetically_my.buys += <span class="hljs-number">1</span>
    buyState = <span class="hljs-keyword">this</span>.fastForwardToBuy(hypothesis, hypothetically_my)
    gained = buyState.getSingleBuyDecision()

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.upgradeValue(state, [card, gained], my)</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Scheme uses the same priority function as multiplied actions.  Good actions
to multiply this turn are typically good actions to have around next turn.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">schemeValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Project a little of what the state will look like at the beginning of the
next turn.  This keeps multipliedActionPriority from evaluating a card
as though it will be used in the current (finished) turn.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    myNext = {}
    myNext[key] = value <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> my
    myNext.actions = <span class="hljs-number">1</span>
    myNext.buys = <span class="hljs-number">1</span>
    myNext.coins = <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getChoiceValue(<span class="hljs-string">'multiplied'</span>, state, card, myNext)</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p><code>scryingPoolDiscardValue</code> is like <code>discardValue</code>, except it strongly
prefers to discard non-actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">scryingPoolDiscardValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> card.isAction
      <span class="hljs-number">2000</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">this</span>.choiceToValue(<span class="hljs-string">'discard'</span>, state, card)

  <span class="hljs-attribute">spiceMerchantTrashPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [
    <span class="hljs-string">"Copper"</span>,
    <span class="hljs-string">"Potion"</span>,
    <span class="hljs-string">"Loan"</span>,
    <span class="hljs-string">"Ill-Gotten Gains"</span>,
    <span class="hljs-string">"Fool's Gold"</span> <span class="hljs-keyword">if</span> my.countInDeck(<span class="hljs-string">"Fool's Gold"</span>) == <span class="hljs-number">1</span>,
    <span class="hljs-string">"Silver"</span> <span class="hljs-keyword">if</span> my.getTotalMoney() &gt;= <span class="hljs-number">8</span>,
    <span class="hljs-literal">null</span>,
    <span class="hljs-string">"Silver"</span>,
    <span class="hljs-string">"Venture"</span>,
    <span class="hljs-string">"Cache"</span>,
    <span class="hljs-string">"Gold"</span>,
    <span class="hljs-string">"Harem"</span>,
    <span class="hljs-string">"Platinum"</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Which treasure, if any, should be discarded to feed Stables? Defaults
to a list of generally crappy treasures. Doesn’t include $1 Fool’s Gold
because you presumably have another one you’re trying to draw.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">stablesDiscardPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [
    <span class="hljs-string">"Copper"</span>
    <span class="hljs-string">"Potion"</span> <span class="hljs-keyword">if</span> my.countInPlay(state.cardInfo[<span class="hljs-string">"Alchemist"</span>]) == <span class="hljs-number">0</span>
    <span class="hljs-string">"Ill-Gotten Gains"</span>
    <span class="hljs-string">"Silver"</span>
    <span class="hljs-string">"Horn of Plenty"</span>
    <span class="hljs-literal">null</span>
    <span class="hljs-string">"Potion"</span>
    <span class="hljs-string">"Venture"</span>
    <span class="hljs-string">"Cache"</span>
    <span class="hljs-string">"Gold"</span>
    <span class="hljs-string">"Platinum"</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Do you want to discard a Province to win a Tournament? The answer is
<em>very</em> yes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">tournamentDiscardPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [<span class="hljs-literal">yes</span>]

  <span class="hljs-attribute">transmuteValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> card.isAction <span class="hljs-keyword">and</span> <span class="hljs-keyword">this</span>.goingGreen(state)
      <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> card.isAction <span class="hljs-keyword">and</span> card.isVictory <span class="hljs-keyword">and</span> card.cost &lt;= <span class="hljs-number">4</span>
      <span class="hljs-keyword">return</span> <span class="hljs-number">1000</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.choiceToValue(<span class="hljs-string">'trash'</span>, state, card)</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p><code>wishValue</code> prefers to wish for the card its draw pile contains
the most of.</p>
<p>The fact that this doesn’t make a hypothetical copy is a shortcut. We are
technically “peeking” at the deck, but we don’t use any information except
the count of each card, which would be the same in any hypothetical version.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">wishValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span>
    pile = my.draw
    <span class="hljs-keyword">if</span> pile.length == <span class="hljs-number">0</span>
      pile = my.discard
    <span class="hljs-keyword">return</span> countInList(pile, card)</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Choose to discard or to gain a curse when attacked by Torturer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">torturerPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [
    <span class="hljs-string">'curse'</span> <span class="hljs-keyword">if</span> state.countInSupply(<span class="hljs-string">"Curse"</span>) == <span class="hljs-number">0</span>
    <span class="hljs-string">'discard'</span> <span class="hljs-keyword">if</span> my.ai.wantsToDiscard(state) &gt;= <span class="hljs-number">2</span>
    <span class="hljs-string">'discard'</span> <span class="hljs-keyword">if</span> my.hand.length &lt;= <span class="hljs-number">1</span>
    <span class="hljs-string">'curse'</span> <span class="hljs-keyword">if</span> my.trashingInHand() &gt; <span class="hljs-number">0</span>
    <span class="hljs-string">'curse'</span> <span class="hljs-keyword">if</span> my.hand.length &lt;= <span class="hljs-number">3</span>
    <span class="hljs-string">'discard'</span>
    <span class="hljs-string">'curse'</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <h3 id="trash-for-benefit-decisions">Trash-for-benefit decisions</h3>

            </div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Taking into account gain priorities, gain values, trash priorities, and
trash values, how much do we like having this card in our deck overall?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cardInDeckValue</span>: <span class="hljs-function"><span class="hljs-params">(state, card, my)</span> -&gt;</span>
    endgamePower = <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Are we in the late game? If so, we care much more about getting cards
at the top of our priority order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> state.gainsToEndGame() &lt;= <span class="hljs-number">5</span>
      endgamePower = <span class="hljs-number">3</span>

    <span class="hljs-keyword">return</span> -(<span class="hljs-keyword">this</span>.choiceToValue(<span class="hljs-string">'trash'</span>, state, card)) + \
           Math.pow(<span class="hljs-keyword">this</span>.choiceToValue(<span class="hljs-string">'gain'</span>, state, card), endgamePower)</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>upgradeValue measures the benefit of choices on Remodel, Upgrade,
and so on, where you exchange one card for a better one.</p>
<p>So here’s a really basic thing that might work.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">upgradeValue</span>: <span class="hljs-function"><span class="hljs-params">(state, choice, my)</span> -&gt;</span>
    [oldCard, newCard] = choice
    <span class="hljs-keyword">return</span> my.ai.cardInDeckValue(state, newCard, my) - \
           my.ai.cardInDeckValue(state, oldCard, my)</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>developValue measures the benefit of choices Develop,
where you exchange one card for two.</p>
<p>So here’s a really basic thing that might work.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">developValue</span>: <span class="hljs-function"><span class="hljs-params">(state, choice, my)</span> -&gt;</span>
    [oldCard, [newCard1, newCard2]] = choice
    <span class="hljs-keyword">return</span> my.ai.cardInDeckValue(state, newCard1, my) + \
           my.ai.cardInDeckValue(state, newCard2, my) - \
           my.ai.cardInDeckValue(state, oldCard, my)</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p><code>chooseOrderOnDeck</code> handles situations where multiple cards are returned
to the deck, such as Scout and Apothecary.</p>
<p>This decision doesn’t fit into the xPriority / xValue framework, as there
are a number of mostly indistinguishable choices. Instead of listing all
the permutations of cards as choices, we just list the cards to arrange.</p>
<p>The default decision is to put the cards with the lowest discard value on
top.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">chooseOrderOnDeck</span>: <span class="hljs-function"><span class="hljs-params">(state, cards, my)</span> -&gt;</span>
    <span class="hljs-function"><span class="hljs-title">sorter</span> = <span class="hljs-params">(card1, card2)</span> -&gt;</span>
      my.ai.choiceToValue(<span class="hljs-string">'discard'</span>, state, card1)\
      - my.ai.choiceToValue(<span class="hljs-string">'discard'</span>, state, card2)
    
    choice = cards.slice(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> choice.sort(sorter)</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>How much do we want to overpay for Masterpiece?
If we care to buy it probably as much as possible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">chooseOverpayMasterpiece</span>: <span class="hljs-function"><span class="hljs-params">(state, maxAmount)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> maxAmount</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>How many Coin Tokens do we want to spend?
Try to buy the ‘best’ card you can afford, and spend as less as possible for this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">spendCoinTokens</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    cardsBoughtOld = []
    ct = my.coinTokens      
    <span class="hljs-keyword">loop</span>
      [hypState, hypMy] = state.hypothetical(<span class="hljs-keyword">this</span>)
      
      hypMy.coins += ct
      hypMy.coinTokensSpendThisTurn = ct
      cardsBought = []
      <span class="hljs-keyword">while</span> hypMy.buys &gt; <span class="hljs-number">0</span>
        cardBought = hypState.getSingleBuyDecision()
        <span class="hljs-keyword">if</span> cardBought?
          [coinCost, potionCost] = cardBought.getCost(hypState)
          hypMy.coins -= coinCost
          hypMy.potions -= potionCost
          cardsBought.push cardBought
        hypMy.buys -= <span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> ((ct &lt; my.coinTokens) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (arrayEqual(cardsBought, cardsBoughtOld)))
        ct += <span class="hljs-number">1</span>
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">if</span> ct == <span class="hljs-number">0</span>
        <span class="hljs-keyword">break</span>
      ct -= <span class="hljs-number">1</span>
      cardsBoughtOld = cardsBought
    <span class="hljs-keyword">return</span> ct</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <h3 id="informational-methods">Informational methods</h3>

            </div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>When presented with a card with simple but variable benefits, such as
Nobles, this is the default way for an AI to decide which benefit it wants.
This function should actually handle a number of common situations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">benefitValue</span>: <span class="hljs-function"><span class="hljs-params">(state, choice, my)</span> -&gt;</span>
    buyValue = <span class="hljs-number">1</span>
    cardValue = <span class="hljs-number">2</span>
    coinValue = <span class="hljs-number">3</span>
    trashValue = <span class="hljs-number">4</span>      <span class="hljs-comment"># if there are cards we want to trash</span>
    actionValue = <span class="hljs-number">10</span>    <span class="hljs-comment"># if we need more actions</span>

    actionBalance = my.actionBalance()
    usableActions = Math.max(<span class="hljs-number">0</span>, -actionBalance)

    <span class="hljs-keyword">if</span> actionBalance &gt;= <span class="hljs-number">1</span>
      cardValue += actionBalance
    <span class="hljs-keyword">if</span> my.ai.wantsToTrash(state) &lt; (choice.trash ? <span class="hljs-number">0</span>)
      trashValue = -<span class="hljs-number">4</span>
    
    value = cardValue * (choice.cards ? <span class="hljs-number">0</span>)
    value += coinValue * (choice.coins ? <span class="hljs-number">0</span>)
    value += buyValue * (choice.buys ? <span class="hljs-number">0</span>)
    value += trashValue * (choice.trash ? <span class="hljs-number">0</span>)
    value += actionValue * Math.min((choice.actions ? <span class="hljs-number">0</span>), usableActions)
    value</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p><code>wantsToTrash</code> returns the number of cards in hand that we would trash
for no benefit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">wantsToTrash</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    my = <span class="hljs-keyword">this</span>.myPlayer(state)
    trashableCards = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.hand
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.chooseTrash(state, [card, <span class="hljs-literal">null</span>]) <span class="hljs-keyword">is</span> card
        trashableCards += <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> trashableCards</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p><code>wantsToPlayRats</code> is like <code>wantsToTrash</code> except that the answer is no.</p>
<p>Come on, it’s a first-order approximation of good strategy. If you’ve got
a better idea, put it in a strategy file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">wantsToPlayRats</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span> <span class="hljs-literal">no</span></pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p><code>wantsToDiscard</code> returns the number of cards in hand that we would
freely discard.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">wantsToDiscard</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    my = <span class="hljs-keyword">this</span>.myPlayer(state)
    discardableCards = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.hand
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.chooseDiscard(state, [card, <span class="hljs-literal">null</span>]) <span class="hljs-keyword">is</span> card
        discardableCards += <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> discardableCards
  
  <span class="hljs-attribute">multiplierChoices</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    my = <span class="hljs-keyword">this</span>.myPlayer(state)
    mults = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.hand <span class="hljs-keyword">when</span> card.isMultiplier)
    <span class="hljs-keyword">if</span> mults.length &gt; <span class="hljs-number">0</span>
      mult = mults[<span class="hljs-number">0</span>]
      choices = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> my.hand <span class="hljs-keyword">when</span> card.isAction)
      choices.remove(mult)
      choices.push(<span class="hljs-literal">null</span>)
      <span class="hljs-keyword">return</span> choices
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> []

  <span class="hljs-attribute">okayToPlayMultiplier</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    choices = <span class="hljs-keyword">this</span>.multiplierChoices(state)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.choose(<span class="hljs-string">'multiplied'</span>, state, choices)?
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

  <span class="hljs-attribute">wantsToPlayMultiplier</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    my = <span class="hljs-keyword">this</span>.myPlayer(state)
    choices = <span class="hljs-keyword">this</span>.multiplierChoices(state)
    <span class="hljs-keyword">if</span> choices.length &gt; <span class="hljs-number">1</span>
      choice = <span class="hljs-keyword">this</span>.choose(<span class="hljs-string">'multiplied'</span>, state, choices)
      multipliedValue = <span class="hljs-keyword">this</span>.getChoiceValue(<span class="hljs-string">'multiplied'</span>, state, choice, my)
      <span class="hljs-keyword">if</span> choice? <span class="hljs-keyword">and</span> choice.isMultiplier</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>prevent infinite loops</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        unmultipliedValue = <span class="hljs-number">0</span>
      <span class="hljs-keyword">else</span>
        unmultipliedValue = <span class="hljs-keyword">this</span>.getChoiceValue(<span class="hljs-string">'play'</span>, state, choice, my)
      <span class="hljs-keyword">return</span> (multipliedValue &gt; unmultipliedValue)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>play Spoils if it changes your buys this turn.  Or if in hypothetical state to solve recursion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">wantsToPlaySpoils</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.depth &gt; <span class="hljs-number">0</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">else</span>
      cardsGainedWithout = <span class="hljs-keyword">this</span>.pessimisticCardsGained(state)
      [hypState, hypMy] = state.hypothetical(<span class="hljs-keyword">this</span>)
      hypState.current.hand.remove(c[<span class="hljs-string">"Spoils"</span>])
      cardsGainedWith = <span class="hljs-keyword">this</span>.pessimisticCardsGained(hypState)
      <span class="hljs-keyword">if</span> arrayEqual(cardsGainedWithout, cardsGainedWith)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>wantsToRebuild and rebuildPriority: taken from the Rebuild strategy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">wantsToRebuild</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> my.countInHand(<span class="hljs-string">"Rebuild"</span>) &gt;= state.countInSupply(<span class="hljs-string">"Province"</span>) \
       <span class="hljs-keyword">and</span> my.ai.getScoreDifference(state, my) &gt; <span class="hljs-number">0</span>
          answer = <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> state.countInSupply(<span class="hljs-string">"Province"</span>) == <span class="hljs-number">1</span> \
            <span class="hljs-keyword">and</span> my.ai.getScoreDifference(state, my) &lt; -<span class="hljs-number">4</span>
              answer = <span class="hljs-number">0</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> state.countInSupply(<span class="hljs-string">"Duchy"</span>) == <span class="hljs-number">0</span> \
            <span class="hljs-keyword">and</span> my.ai.countNotInHand(my, <span class="hljs-string">"Duchy"</span>) == <span class="hljs-number">0</span>\
            <span class="hljs-keyword">and</span> my.ai.getScoreDifference(state, my) &lt; <span class="hljs-number">0</span>
              answer = <span class="hljs-number">0</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> my.getTreasureInHand() &gt; <span class="hljs-number">7</span> <span class="hljs-keyword">and</span> state.countInSupply(<span class="hljs-string">"Province"</span>) == <span class="hljs-number">1</span>
              answer = <span class="hljs-number">0</span>
    <span class="hljs-keyword">else</span>
          answer = state.countInSupply(<span class="hljs-string">"Province"</span>) &gt; <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> answer

  <span class="hljs-attribute">rebuildPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [
    <span class="hljs-string">"Province"</span>
    <span class="hljs-string">"Duchy"</span>
    <span class="hljs-string">"Estate"</span>
  ]

  <span class="hljs-attribute">nameVPPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span> [
    <span class="hljs-string">"Colony"</span> <span class="hljs-keyword">if</span> my.countInDeck(<span class="hljs-string">"Colony"</span>) &gt; <span class="hljs-number">0</span>
    <span class="hljs-string">"Province"</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>Assume we always want to play Journeyman</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">wantsToJM</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-literal">true</span>
  
  <span class="hljs-attribute">wantsToDiscardBeggar</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p><code>goingGreen</code>: determine when we’re playing for victory points. By default,
it’s if there are any Colonies, Provinces, or Duchies in the deck.</p>
<p>The bigger the number, the greener the deck, but a true (greater than 0)
value is a good indication in itself that we want victory cards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">goingGreen</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    my = <span class="hljs-keyword">this</span>.myPlayer(state)
    bigGreen = my.countInDeck(<span class="hljs-string">"Colony"</span>) + my.countInDeck(<span class="hljs-string">"Province"</span>) + my.countInDeck(<span class="hljs-string">"Duchy"</span>)
    <span class="hljs-keyword">return</span> bigGreen</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p><code>pessimisticMoneyInHand</code> establishes a minimum on how much money the
player will be able to spend in this game state. It assumes the player
will draw no money from the deck.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">pessimisticMoneyInHand</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>Don’t recurse more than once. If we’re already in a hypothetical
situation, use the stupid version instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> state.depth &gt; <span class="hljs-number">0</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.myPlayer(state).getAvailableMoney()

    buyPhase = <span class="hljs-keyword">this</span>.pessimisticBuyPhase(state)
    <span class="hljs-keyword">return</span> buyPhase.current.coins</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>Look ahead to the buy phase, assuming we draw no money from the deck.</p>
<p>TODO: when we can handle known cards on top of the deck, take them
into account.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">pessimisticBuyPhase</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.depth &gt; <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>A last-ditch effort to avoid recursion, by simply fast-forwarding
to the next phase.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> state.phase == <span class="hljs-string">'action'</span>
        state.phase = <span class="hljs-string">'treasure'</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> state.phase == <span class="hljs-string">'treasure'</span>
        state.phase = <span class="hljs-string">'buy'</span>
    
    [hypothesis, hypothetically_my] = state.hypothetical(<span class="hljs-keyword">this</span>)
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fastForwardToBuy(hypothesis, hypothetically_my)

  <span class="hljs-attribute">fastForwardToBuy</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> state.depth == <span class="hljs-number">0</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"Can only fast-forward in a hypothetical state"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>We need to save draw and discard before emptying and restore them before buyPhase, to be able to choose the right buys in actionPriority(state)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    oldDraws   = my.draw.slice(<span class="hljs-number">0</span>)
    oldDiscard = my.discard.slice(<span class="hljs-number">0</span>)
    my.draw = []
    my.discard = []
    
    <span class="hljs-keyword">while</span> state.phase != <span class="hljs-string">'buy'</span>
      state.doPlay()
      
    my.draw = oldDraws
    my.discard = oldDiscard

    <span class="hljs-keyword">return</span> state
  
  <span class="hljs-attribute">pessimisticCardsGained</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    newState = <span class="hljs-keyword">this</span>.pessimisticBuyPhase(state)
    newState.doPlay()
    <span class="hljs-keyword">return</span> newState.current.gainedThisTurn</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>coinLossMargin determines how much treasure the player can lose
“for free” (because it won’t change their buy decision). Intended to be
more efficient than calling pessimisticCardsGained on a number
of different states.</p>
<p>TODO: do we need an equivalent for potions?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">coinLossMargin</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    newState = <span class="hljs-keyword">this</span>.pessimisticBuyPhase(state)
    coins = newState.current.coins
    cardToBuy = newState.getSingleBuyDecision()
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> cardToBuy <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
    [coinsCost, potionsCost] = cardToBuy.getCost(newState)
    <span class="hljs-keyword">return</span> coins - coinsCost</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>coinGainMargin determines how much treasure the player wants to gain,
in order to get a better card. Tries up to +$8, then returns Infinity
if nothing changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">coinGainMargin</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    newState = <span class="hljs-keyword">this</span>.pessimisticBuyPhase(state)
    coins = newState.current.coins
    baseCard = newState.getSingleBuyDecision()
    <span class="hljs-keyword">for</span> increment <span class="hljs-keyword">in</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>]
      newState.current.coins = coins+increment
      cardToBuy = newState.getSingleBuyDecision()
      <span class="hljs-keyword">if</span> cardToBuy != baseCard
        <span class="hljs-keyword">return</span> increment
    <span class="hljs-keyword">return</span> Infinity</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>Estimate the number of coins we’d lose by discarding/trashing/putting back
a card.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">coinsDueToCard</span>: <span class="hljs-function"><span class="hljs-params">(state, card)</span> -&gt;</span>
    c = state.cardInfo
    value = card.getCoins(state)
    <span class="hljs-keyword">if</span> card.isTreasure
      banks = state.current.countInHand(state.cardInfo.Bank)
      value += banks
      <span class="hljs-keyword">if</span> card <span class="hljs-keyword">is</span> state.cardInfo.Bank
        nonbanks = (aCard <span class="hljs-keyword">for</span> aCard <span class="hljs-keyword">in</span> state.current.hand <span class="hljs-keyword">when</span> aCard.isTreasure).length
        value += nonbanks
    value</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Figure out whether hand1 or hand2 is better by discarding their cards
in priority order, until one of them gets to 2 or fewer cards.</p>
<p>Returns a -1 or 1 that can be used in sorting; it’s
positive if the first hand is better.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">compareByDiscarding</span>: <span class="hljs-function"><span class="hljs-params">(state, hand1, hand2)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Guard against accidental mutation; we’re going to be messing with
these lists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    hand1 = hand1.slice(<span class="hljs-number">0</span>)
    hand2 = hand2.slice(<span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>Preserve our number of actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    savedActions = state.current.actions
    state.current.actions = <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>state.log(“hand1 = #{hand1}”)
state.log(“hand2 = #{hand2}”)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    counter = <span class="hljs-number">0</span>
    <span class="hljs-keyword">loop</span>
      counter++
      <span class="hljs-keyword">if</span> counter &gt;= <span class="hljs-number">100</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"got stuck in a loop"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>Figure out whether we’d rather discard from hand1 or hand2.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      discard1 = <span class="hljs-keyword">this</span>.choose(<span class="hljs-string">'discard'</span>, state, hand1)
      value1 = <span class="hljs-keyword">this</span>.choiceToValue(<span class="hljs-string">'discard'</span>, state, discard1)
      discard2 = <span class="hljs-keyword">this</span>.choose(<span class="hljs-string">'discard'</span>, state, hand2)
      value2 = <span class="hljs-keyword">this</span>.choiceToValue(<span class="hljs-string">'discard'</span>, state, discard2)
      <span class="hljs-keyword">if</span> value1 &gt; value2
        hand1.remove(discard1)
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> value2 &gt; value1
        hand2.remove(discard2)
      <span class="hljs-keyword">else</span>
        hand1.remove(discard1)
        hand2.remove(discard2)
      <span class="hljs-keyword">if</span> hand1.length &lt;= <span class="hljs-number">2</span> <span class="hljs-keyword">and</span> hand2.length &lt;= <span class="hljs-number">2</span>
        state.current.actions = savedActions
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>      
      <span class="hljs-keyword">if</span> hand1.length &lt;= <span class="hljs-number">2</span>
        state.current.actions = savedActions
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> hand2.length &lt;= <span class="hljs-number">2</span>
        state.current.actions = savedActions
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <h3 id="utility-methods">Utility methods</h3>
<p><code>copy</code> makes a copy of the AI. It will have the same behavior but a
different name, and will not be equal to this AI.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">copy</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span>
    ai = <span class="hljs-keyword">new</span> BasicAI()
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> <span class="hljs-keyword">this</span>
      ai[key] = value
    ai.name = <span class="hljs-keyword">this</span>.name+<span class="hljs-string">'*'</span>
    ai</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Some functions need to check the actionPriority a lot. This pair of
methods will save a cached value so you don’t need to run such an expensive
function over and over.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cachedActionPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    my.ai.cachedAP
    
  <span class="hljs-attribute">cacheActionPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my)</span> -&gt;</span>
    <span class="hljs-property">@cachedAP</span> = my.ai.actionPriority(state, my)

  <span class="hljs-attribute">toString</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> <span class="hljs-keyword">this</span>.name
  
<span class="hljs-keyword">this</span>.BasicAI = BasicAI</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <h2 id="utility-functions">Utility functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p><code>count</code> counts the number of times <code>elt</code> appears in <code>list</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">countInList</span> = <span class="hljs-params">(list, elt)</span> -&gt;</span>
  count = <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> member <span class="hljs-keyword">in</span> list
    <span class="hljs-keyword">if</span> member == elt
      count++
  count</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p><code>stringify</code> turns an object into a string, while handling <code>null</code> safely.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">stringify</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> obj <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> obj.toString()</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>General function to randomly shuffle a list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">shuffle</span> = <span class="hljs-params">(v)</span> -&gt;</span>
  i = v.length
  <span class="hljs-keyword">while</span> i
    j = parseInt(Math.random() * i)
    i -= <span class="hljs-number">1</span>
    temp = v[i]
    v[i] = v[j]
    v[j] = temp
  v</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>compare Arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">arrayEqual</span> = <span class="hljs-params">(a, b)</span> -&gt;</span>
  a.length <span class="hljs-keyword">is</span> b.length <span class="hljs-keyword">and</span> a.every <span class="hljs-function"><span class="hljs-params">(elem, i)</span> -&gt;</span> elem <span class="hljs-keyword">is</span> b[i]</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
