<!DOCTYPE html>

<html>
<head>
  <title>gameState.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="basicAI.html">
                basicAI.coffee
              </a>
            
              
              <a class="source" href="cards.html">
                cards.coffee
              </a>
            
              
              <a class="source" href="compileStrategies.html">
                compileStrategies.coffee
              </a>
            
              
              <a class="source" href="gameState.html">
                gameState.coffee
              </a>
            
              
              <a class="source" href="heuristics.html">
                heuristics.coffee
              </a>
            
              
              <a class="source" href="play.html">
                play.coffee
              </a>
            
              
              <a class="source" href="playWeb.html">
                playWeb.coffee
              </a>
            
              
              <a class="source" href="testSimulation.html">
                testSimulation.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>gameState.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>This “indecisive import” pattern is messy but it gets the job done, and it’s
explained at the bottom of this documentation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>{c,transferCard,transferCardToTop} = <span class="hljs-built_in">require</span> <span class="hljs-string">'./cards'</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">exports</span>?</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="the-playerstate-class">The PlayerState class</h2>
<p>A PlayerState stores the part of the game state
that is specific to each player, plus what AI is making the decisions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlayerState</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>At the start of the game, the State should
.initialize() each PlayerState, which assigns its AI and sets up its
starting state. Before then, it is an empty object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">initialize</span>: <span class="hljs-function"><span class="hljs-params">(ai, logFunc)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>These attributes of the PlayerState are okay for card effects and
AI strategies to refer to.</p>
<p>Often, you will want to find out something
about the player whose turn it is, who will appear as <code>state.current</code>.
For example, if you want to know how many actions the current player
has, you can look up <code>state.current.actions</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@actions</span> = <span class="hljs-number">1</span>
    <span class="hljs-property">@buys</span> = <span class="hljs-number">1</span>
    <span class="hljs-property">@coins</span> = <span class="hljs-number">0</span>
    <span class="hljs-property">@potions</span> = <span class="hljs-number">0</span>
    <span class="hljs-property">@coinTokens</span> = <span class="hljs-number">0</span>
    <span class="hljs-property">@coinTokensSpendThisTurn</span> = <span class="hljs-number">0</span>
    <span class="hljs-property">@multipliedDurations</span> = []
    <span class="hljs-property">@chips</span> = <span class="hljs-number">0</span>
    <span class="hljs-property">@hand</span> = []
    <span class="hljs-property">@discard</span> = [c.Copper, c.Copper, c.Copper, c.Copper, c.Copper,
                c.Copper, c.Copper, c.Estate, c.Estate, c.Estate]</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>A mat is a place where cards can store inter-turn state for a player.
It can correspond to a physical mat, like the Island or Pirate Ship
Mat or just a place to set things aside for cards like Haven.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@mats</span> = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>If you want to ask what’s in a player’s draw pile, be sure to only do
it to a <em>hypothetical</em> PlayerState that you retrieve with
<code>state.hypothetical(ai)</code>. Then the draw pile will contain a random
guess, as opposed to the actual hidden information.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@draw</span> = []
    <span class="hljs-property">@inPlay</span> = []
    <span class="hljs-property">@duration</span> = []
    <span class="hljs-property">@setAside</span> = []
    <span class="hljs-property">@gainedThisTurn</span> = []
    <span class="hljs-property">@turnsTaken</span> = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>To stack various card effects, we’ll have to keep track of the location
of the card we’re playing and the card we’re gaining. For example, if
you have two Feasts in hand and you Throne Room a Feast, you don’t
trash <em>both</em> Feasts — you trash one and then do nothing, based on the
fact that <em>that particular</em> Feast is already in the trash.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@playLocation</span> = <span class="hljs-string">'inPlay'</span>
    <span class="hljs-property">@gainLocation</span> = <span class="hljs-string">'discard'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>The <code>actionStack</code> is not a physical location for cards to be in; it’s
a computational list of what actions are in play but not yet resolved.
This becomes particularly important with King’s Courts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@actionStack</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Set the properties passed in from the State.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@ai</span> = ai
    <span class="hljs-property">@logFunc</span> = logFunc</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>To start the game, the player starts with the 10 starting cards
in the discard pile, then shuffles them and draws 5.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.drawCards(<span class="hljs-number">5</span>)
    <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3 id="informational-methods">Informational methods</h3>
<p>The methods here ask about general properties of a player’s deck,
discard pile, and so on. A number of similar methods appear on the <code>State</code>
class defined below, which deal with information that is not so
player-specific, such as the cards in the supply.</p>
<p>As an example:
Most AI code will start with a reference to the State, called <code>state</code>.
If you want to check the number of cards in the current player’s deck,
you would ask the <em>player object</em> <code>state.current</code>:</p>
<p>   state.current.numCardsInDeck()</p>
<p>If you want to check how many piles are currently empty, you would ask
the <em>state object</em> itself:</p>
<p>   state.numEmptyPiles()</p>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><code>getDeck()</code> returns all the cards in the player’s deck, even those in
strange places such as the Island mat.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getDeck</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    result = [].concat(<span class="hljs-property">@draw</span>, <span class="hljs-property">@discard</span>, <span class="hljs-property">@hand</span>, <span class="hljs-property">@inPlay</span>, <span class="hljs-property">@duration</span>, <span class="hljs-property">@setAside</span>)

    <span class="hljs-keyword">for</span> own name, contents <span class="hljs-keyword">of</span> <span class="hljs-property">@mats</span> <span class="hljs-keyword">when</span> contents?</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>If contents is a card or an array containing cards, add it to the list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> contents.hasOwnProperty(<span class="hljs-string">'playEffect'</span>) || contents[<span class="hljs-number">0</span>]?.hasOwnProperty(<span class="hljs-string">'playEffect'</span>)
        result = result.concat(contents)
    result</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><code>getCurrentAction()</code> returns the action being resolved that is on the
top of the stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getCurrentAction</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@actionStack</span>[<span class="hljs-property">@actionStack</span>.length - <span class="hljs-number">1</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><code>getMultiplier()</code> gets the value of the multipier that is currently being
played: 1 in most cases, 2 after playing Throne Room, 3 after playing
King’s Court.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getMultiplier</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    action = <span class="hljs-keyword">this</span>.getCurrentAction()
    <span class="hljs-keyword">if</span> action?
      <span class="hljs-keyword">return</span> action.getMultiplier()
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><code>countInDeck(card)</code> counts the number of copies of a card in the deck.
The card may be specified either by name or as a card object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">countInDeck</span>: <span class="hljs-function"><span class="hljs-params">(card)</span> -&gt;</span>
    count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> card2 <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.getDeck()
      <span class="hljs-keyword">if</span> card.toString() == card2.toString()
        count++
    count</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><code>numCardsInDeck()</code> returns the size of the player’s deck.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">numCardsInDeck</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> <span class="hljs-keyword">this</span>.getDeck().length</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Aliases for <code>numCardsInDeck</code> that you might use intuitively. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">countCardsInDeck</span>: <span class="hljs-keyword">this</span>.numCardsInDeck
  <span class="hljs-attribute">cardsInDeck</span>: <span class="hljs-keyword">this</span>.numCardsInDeck</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><code>countCardTypeInDeck(type)</code> counts the number of cards of a given type
in the deck. Curse is not a type for these purposes, it’s a card.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">countCardTypeInDeck</span>: <span class="hljs-function"><span class="hljs-params">(type)</span> -&gt;</span>
    typeChecker = <span class="hljs-string">'is'</span>+type
    count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.getDeck()
      <span class="hljs-keyword">if</span> card[typeChecker]
        count++
    count
  <span class="hljs-attribute">numCardTypeInDeck</span>: <span class="hljs-keyword">this</span>.countCardTypeInDeck</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><code>getVP()</code> returns the number of VP the player would have if the game
ended now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getVP</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    total = <span class="hljs-property">@chips</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.getDeck()
      total += card.getVP(<span class="hljs-keyword">this</span>)
    total
  <span class="hljs-attribute">countVP</span>: <span class="hljs-keyword">this</span>.getVP</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p><code>getTotalMoney()</code> adds up the total money in the player’s deck,
including both Treasure and +$x, +y Actions cards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getTotalMoney</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    total = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.getDeck()
      <span class="hljs-keyword">if</span> card.isTreasure <span class="hljs-keyword">or</span> card.actions &gt;= <span class="hljs-number">1</span>
        total += card.coins</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <pre><code>   total += card.coinTokens
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    total
  <span class="hljs-attribute">totalMoney</span>: <span class="hljs-keyword">this</span>.getTotalMoney</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p><code>getAvailableMoney()</code> counts the money the player might have upon playing
all treasure in hand. Banks, Ventures, and such are counted inaccurately
so far.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getAvailableMoney</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">this</span>.coins + <span class="hljs-keyword">this</span>.getTreasureInHand()
  <span class="hljs-attribute">availableMoney</span>: <span class="hljs-keyword">this</span>.getAvailableMoney</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><code>getTreasureInHand()</code> adds up the value of the treasure in the player’s
hand. Banks and Ventures and such will be inaccurate.</p>
<p>A <code>getMoneyInHand(state)</code> method that counted playable action cards would
be great, but I’m skipping it for now because it’s difficult to get right.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getTreasureInHand</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    total = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.hand
      <span class="hljs-keyword">if</span> card.isTreasure
        total += card.coins
    total
  <span class="hljs-attribute">treasureInHand</span>: <span class="hljs-keyword">this</span>.getTreasureInHand
  
  <span class="hljs-attribute">countPlayableTerminals</span>: <span class="hljs-function"><span class="hljs-params">(state)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-property">@actions</span>&gt;<span class="hljs-number">0</span>)
      <span class="hljs-property">@actions</span> + <span class="hljs-function"><span class="hljs-params">( (Math.max (card.getActions(state) - <span class="hljs-number">1</span>), <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.hand).reduce (s,t) -&gt; s + t)</span>
    <span class="hljs-title">else</span> 0
  <span class="hljs-title">numPlayableTerminals</span>: <span class="hljs-title">this</span>.<span class="hljs-title">countPlayableTerminals</span>    
  <span class="hljs-title">playableTerminals</span>: <span class="hljs-title">this</span>.<span class="hljs-title">countPlayableTerminals</span>    
   
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p><code>countInHand(card)</code> counts the number of copies of a card in hand.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">countInHand</span>: <span class="hljs-function"><span class="hljs-params">(card)</span> -&gt;</span>
    countStr(<span class="hljs-property">@hand</span>, card)</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p><code>countInDiscard(card)</code> counts the number of copies of a card in the discard
pile.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">countInDiscard</span>: <span class="hljs-function"><span class="hljs-params">(card)</span> -&gt;</span>
    countStr(<span class="hljs-property">@discard</span>, card)</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><code>countInPlay(card)</code>
counts the number of copies of a card in play. Don’t use this
for evaluating effects that stack, because you may also need
to take Throne Rooms and King’s Courts into account.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">countInPlay</span>: <span class="hljs-function"><span class="hljs-params">(card)</span> -&gt;</span>
    countStr(<span class="hljs-property">@inPlay</span>, card)</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><code>numActionCardsInDeck()</code> is the number of action cards in the player’s
entire deck.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">numActionCardsInDeck</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">this</span>.countCardTypeInDeck(<span class="hljs-string">'Action'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><code>getActionDensity()</code> returns a fractional value, between 0.0 and 1.0,
representing the proportion of actions in the deck.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getActionDensity</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">this</span>.numActionCardsInDeck() / <span class="hljs-keyword">this</span>.getDeck().length</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p><code>menagerieDraws()</code> is the number of cards the player would draw upon
playing a Menagerie: either 1 or 3.</p>
<p><em>TODO</em>: allow for a hypothetical version where it’s okay to have another
Menagerie.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">menagerieDraws</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    seen = {}
    cardsToDraw = <span class="hljs-number">3</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-property">@hand</span>
      <span class="hljs-keyword">if</span> seen[card.name]?
        cardsToDraw = <span class="hljs-number">1</span>
        <span class="hljs-keyword">break</span>
      seen[card.name] = <span class="hljs-literal">true</span>
    cardsToDraw</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p><code>shantyTownDraws()</code> is the number of cards the player draws upon
playing a Shanty town: either 0 or 2.</p>
<p>Set <code>hypothetical</code> to <code>true</code> if deciding whether to play a Shanty Town
(because it won’t be in your hand anymore when you do).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">shantyTownDraws</span>: <span class="hljs-function"><span class="hljs-params">(hypothetical = <span class="hljs-literal">false</span>)</span> -&gt;</span>
    cardsToDraw = <span class="hljs-number">2</span>
    skippedShanty = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-property">@hand</span>
      <span class="hljs-keyword">if</span> card.isAction
        <span class="hljs-keyword">if</span> hypothetical <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> skippedShanty
          skippedShanty = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">else</span>
          cardsToDraw = <span class="hljs-number">0</span>
          <span class="hljs-keyword">break</span>
    cardsToDraw</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p><code>actionBalance()</code> is a complex method meant to be used by AIs in
deciding whether they want +actions or +cards, for example.</p>
<p>If the actionBalance is
less than 0, you want +actions, because otherwise you will have dead
action cards in hand or risk drawing them dead. If it is greater than
0, you want +cards, because you have a surplus of actions and need
action cards to spend them on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">actionBalance</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    balance = <span class="hljs-property">@actions</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-property">@hand</span>
      <span class="hljs-keyword">if</span> card.isAction
        balance += card.actions
        balance--</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Estimate the risk of drawing an action card dead.</p>
<p><em>TODO</em>: do something better when there are variable card-drawers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> card.actions == <span class="hljs-number">0</span>
          balance -= card.cards * <span class="hljs-keyword">this</span>.getActionDensity()
    balance</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p><code>deckActionBalance()</code> is a measure of action balance across the entire
deck.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">deckActionBalance</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    balance = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.getDeck()
      <span class="hljs-keyword">if</span> card.isAction
        balance += card.actions
        balance--
    <span class="hljs-keyword">return</span> balance / <span class="hljs-keyword">this</span>.numCardsInDeck()</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>What is the trashing power of this hand?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">trashingInHand</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    trash = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.hand</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Count actions that simply trash a constant number of cards from hand.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      trash += card.trash</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Add other trashers, including the trash-on-gain power of Watchtower.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      trash += <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> card <span class="hljs-keyword">is</span> c.Steward
      trash += <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> card <span class="hljs-keyword">is</span> c[<span class="hljs-string">'Trading Post'</span>]
      trash += <span class="hljs-number">4</span> <span class="hljs-keyword">if</span> card <span class="hljs-keyword">is</span> c.Chapel
      trash += <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> card <span class="hljs-keyword">is</span> c.Masquerade
      trash += <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> card <span class="hljs-keyword">is</span> c.Ambassador
      trash += <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> card <span class="hljs-keyword">is</span> c.Watchtower
    <span class="hljs-keyword">return</span> trash
  
  <span class="hljs-attribute">numUniqueCardsInPlay</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    unique = []
    cards = <span class="hljs-property">@inPlay</span>.concat(<span class="hljs-property">@duration</span>)
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> cards
      <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> unique
        unique.push(card)
    <span class="hljs-keyword">return</span> unique.length
  <span class="hljs-attribute">countUniqueCardsInPlay</span>: <span class="hljs-keyword">this</span>.numUniqueCardsInPlay
  <span class="hljs-attribute">uniqueCardsInPlay</span>: <span class="hljs-keyword">this</span>.numUniqueCardsInPlay</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <h3 id="methods-that-modify-the-playerstate">Methods that modify the PlayerState</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-attribute">drawCards</span>: <span class="hljs-function"><span class="hljs-params">(nCards)</span> -&gt;</span>
    drawn = <span class="hljs-keyword">this</span>.getCardsFromDeck(nCards)
    <span class="hljs-attribute">Array</span>::push.apply <span class="hljs-property">@hand</span>, drawn
    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@ai</span>}</span> draws <span class="hljs-subst">#{drawn.length}</span> cards: <span class="hljs-subst">#{drawn}</span>."</span>)
    <span class="hljs-keyword">return</span> drawn</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p><code>getCardsFromDeck</code> is a sub-method of many things that need to happen
with the game. It takes <code>nCards</code> cards off the deck, and then
<em>returns</em> them so you can do something with them.</p>
<p>Code that calls <code>getCardsFromDeck</code>
is responsible for making sure the cards aren’t just “dropped on the
floor” after that, so to speak.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getCardsFromDeck</span>: <span class="hljs-function"><span class="hljs-params">(nCards)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@draw</span>.length &lt; nCards
      diff = nCards - <span class="hljs-property">@draw</span>.length
      drawn = <span class="hljs-property">@draw</span>.slice(<span class="hljs-number">0</span>)
      <span class="hljs-property">@draw</span> = []
      <span class="hljs-keyword">if</span> <span class="hljs-property">@discard</span>.length &gt; <span class="hljs-number">0</span>
        <span class="hljs-keyword">this</span>.shuffle()
        <span class="hljs-keyword">return</span> drawn.concat(<span class="hljs-keyword">this</span>.getCardsFromDeck(diff))
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> drawn
        
    <span class="hljs-keyword">else</span>
      drawn = <span class="hljs-property">@draw</span>[<span class="hljs-number">0.</span>..nCards]
      <span class="hljs-property">@draw</span> = <span class="hljs-property">@draw</span>[nCards...]
      <span class="hljs-keyword">return</span> drawn</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p><code>dig</code> is a function to draw and reveal cards from the deck until
certain ones are found. The cards to be found are defined by digFunc,
which takes (state, card) and returns true if card is one that we’re
trying find. For example, Venture’s and Adventurer’s would be
digFunc: (state, card) -&gt; card.isTreasure</p>
<p>nCards is the number of cards we’re looking for; usually 1, but Golem
and Adventurer look for 2 cards.</p>
<p>By default, discard the revealed and set aside cards, but Scrying Pool
digs for a card that is not an action, then draws up all the revealed
actions as well; discardSetAside allows a card calling dig to do
something with setAside other than discarding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">dig</span>: <span class="hljs-function"><span class="hljs-params">(state, digFunc, nCards=<span class="hljs-number">1</span>, discardSetAside=<span class="hljs-literal">true</span>)</span> -&gt;</span>
    foundCards = [] <span class="hljs-comment"># These are the cards you're looking for</span>
    revealedCards = [] <span class="hljs-comment"># All the cards drawn and revealed from the deck</span>
    <span class="hljs-keyword">while</span> foundCards.length &lt; nCards
      drawn = <span class="hljs-keyword">this</span>.getCardsFromDeck(<span class="hljs-number">1</span>)
      <span class="hljs-keyword">break</span> <span class="hljs-keyword">if</span> drawn.length == <span class="hljs-number">0</span>
      card = drawn[<span class="hljs-number">0</span>]
      revealedCards.push(card)
      <span class="hljs-keyword">if</span> digFunc(state, card)
        foundCards.push(card)
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">this</span>.setAside.push(card)
    <span class="hljs-keyword">if</span> revealedCards.length == <span class="hljs-number">0</span>
      <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"...<span class="hljs-subst">#{<span class="hljs-keyword">this</span>.ai}</span> has no cards to draw."</span>)
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"...<span class="hljs-subst">#{<span class="hljs-keyword">this</span>.ai}</span> reveals <span class="hljs-subst">#{revealedCards}</span>."</span>)
    <span class="hljs-keyword">if</span> discardSetAside
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.setAside.length &gt; <span class="hljs-number">0</span>
        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"...<span class="hljs-subst">#{<span class="hljs-keyword">this</span>.ai}</span> discards <span class="hljs-subst">#{<span class="hljs-keyword">this</span>.setAside}</span>."</span>)
      <span class="hljs-keyword">this</span>.discard = <span class="hljs-keyword">this</span>.discard.concat(<span class="hljs-keyword">this</span>.setAside)
      state.handleDiscards(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.setAside)
      <span class="hljs-keyword">this</span>.setAside = []
    foundCards
  
  <span class="hljs-attribute">discardFromDeck</span>: <span class="hljs-function"><span class="hljs-params">(nCards)</span> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"discardFromDeck is done by the state now"</span>)
  
  <span class="hljs-attribute">doDiscard</span>: <span class="hljs-function"><span class="hljs-params">(card)</span> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"doDiscard is done by the state now"</span>)
  
  <span class="hljs-attribute">doTrash</span>: <span class="hljs-function"><span class="hljs-params">(card)</span> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"doTrash is done by the state now"</span>)

  <span class="hljs-attribute">doPutOnDeck</span>: <span class="hljs-function"><span class="hljs-params">(card)</span> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"doPutOnDeck is done by the state now"</span>)
  
  <span class="hljs-attribute">shuffle</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"(<span class="hljs-subst">#{<span class="hljs-property">@ai</span>}</span> shuffles.)"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-property">@draw</span>.length &gt; <span class="hljs-number">0</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"Shuffling while there are cards left to draw"</span>)
    shuffle(<span class="hljs-property">@discard</span>)
    <span class="hljs-property">@draw</span> = <span class="hljs-property">@discard</span>
    <span class="hljs-property">@discard</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>TODO: add an AI decision for Stashes</p>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Most PlayerStates are created by copying an existing one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">copy</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    other = <span class="hljs-keyword">new</span> PlayerState()
    other.actions = <span class="hljs-property">@actions</span>
    other.buys = <span class="hljs-property">@buys</span>
    other.coins = <span class="hljs-property">@coins</span>
    other.potions = <span class="hljs-property">@potions</span>
    other.coinTokens = <span class="hljs-property">@coinTokens</span>
    other.multipliedDurations = <span class="hljs-property">@multipliedDurations</span>.slice(<span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Clone mat contents, deep-copying arrays of cards</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    other.mats = {}
    <span class="hljs-keyword">for</span> own name, contents <span class="hljs-keyword">of</span> <span class="hljs-property">@mats</span>
      <span class="hljs-keyword">if</span> contents <span class="hljs-keyword">instanceof</span> Array
        contents = contents.concat()
      other.mats[name] = contents

    other.chips = <span class="hljs-property">@chips</span>
    other.hand = <span class="hljs-property">@hand</span>.slice(<span class="hljs-number">0</span>)
    other.draw = <span class="hljs-property">@draw</span>.slice(<span class="hljs-number">0</span>)
    other.discard = <span class="hljs-property">@discard</span>.slice(<span class="hljs-number">0</span>)
    other.inPlay = <span class="hljs-property">@inPlay</span>.slice(<span class="hljs-number">0</span>)
    other.duration = <span class="hljs-property">@duration</span>.slice(<span class="hljs-number">0</span>)
    other.setAside = <span class="hljs-property">@setAside</span>.slice(<span class="hljs-number">0</span>)
    other.gainedThisTurn = <span class="hljs-property">@gainedThisTurn</span>.slice(<span class="hljs-number">0</span>)
    other.playLocation = <span class="hljs-property">@playLocation</span>
    other.gainLocation = <span class="hljs-property">@gainLocation</span>
    other.actionStack = <span class="hljs-property">@actionStack</span>.slice(<span class="hljs-number">0</span>)
    other.actionsPlayed = <span class="hljs-property">@actionsPlayed</span>
    other.ai = <span class="hljs-property">@ai</span>
    other.logFunc = <span class="hljs-property">@logFunc</span>
    other.turnsTaken = <span class="hljs-property">@turnsTaken</span>
    other.coinTokensSpendThisTurn = <span class="hljs-property">@coinTokensSpendThisTurn</span>
    other</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Games can provide output using the <code>log</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">log</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.logFunc?
      <span class="hljs-keyword">this</span>.logFunc(obj)
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">if</span> <span class="hljs-built_in">console</span>?
        <span class="hljs-built_in">console</span>.log(obj)</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h2 id="the-state-class">The State class</h2>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>A State instance stores the complete state of the game at a point in time.</p>
<p>Almost all operations work by changing the game state. This means that if
AI code wants to evaluate potential decisions, it should do them using a
copy of the state (often one with hidden information in it).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">State</span></span>
  <span class="hljs-attribute">basicSupply</span>: [c.Curse, c.Copper, c.Silver, c.Gold,
                c.Estate, c.Duchy, c.Province]
  <span class="hljs-attribute">extraSupply</span>: [c.Potion, c.Platinum, c.Colony]</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>AIs can get at the <code>c</code> object that stores information about cards
by looking up <code>state.cardInfo</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cardInfo</span>: c</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Set up the state at the start of the game. Takes these arguments:</p>
<ul>
<li><code>ais</code>: a list of AI objects that will make the decisions, one per player.
This sets the number of players in the game.</li>
<li><code>tableau</code>: the list of non-basic cards in the supply. Colony, Platinum,
and Potion have to be listed explicitly.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">initialize</span>: <span class="hljs-function"><span class="hljs-params">(ais, tableau, logFunc)</span> -&gt;</span>
    <span class="hljs-keyword">this</span>.logFunc = logFunc
    <span class="hljs-property">@players</span> = (<span class="hljs-keyword">new</span> PlayerState().initialize(ai, <span class="hljs-keyword">this</span>.logFunc) <span class="hljs-keyword">for</span> ai <span class="hljs-keyword">in</span> ais)
    <span class="hljs-property">@players</span> = []
    playerNum = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> ai <span class="hljs-keyword">in</span> ais</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>playerNum += 1
if ai.name[2] == ‘:’
 ai.name = ai.name[3…]
ai.name = “P#{playerNum}:#{ai.name}”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      player = <span class="hljs-keyword">new</span> PlayerState().initialize(ai, <span class="hljs-keyword">this</span>.logFunc)
      <span class="hljs-property">@players</span>.push(player)

    <span class="hljs-property">@nPlayers</span> = <span class="hljs-property">@players</span>.length
    <span class="hljs-property">@current</span> = <span class="hljs-property">@players</span>[<span class="hljs-number">0</span>]
    <span class="hljs-property">@supply</span> = <span class="hljs-keyword">this</span>.makeSupply(tableau)</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Cards like Tournament or Black Market may put cards in a special supply</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@specialSupply</span> = {}
    <span class="hljs-property">@trash</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>A map of Card to state object that allows cards to define lasting state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@cardState</span> = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>A list of objects which have a “modify” method that takes a card and returns
a modification to its cost.  Objects must also have a “source” property that
specifies which card caused the cost modification.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@costModifiers</span> = []

    <span class="hljs-property">@copperValue</span> = <span class="hljs-number">1</span>
    <span class="hljs-property">@phase</span> = <span class="hljs-string">'start'</span>
    <span class="hljs-property">@extraturn</span> = <span class="hljs-literal">false</span>
    
    <span class="hljs-property">@cache</span> = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>The <code>depth</code> indicates how deep into hypothetical situations we are. A depth of 0
indicates the state of the actual game.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@depth</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"Tableau: <span class="hljs-subst">#{tableau}</span>"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Let cards in the tableau know the game is starting so they can perform
any necessary initialization</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> tableau
      card.startGameEffect(<span class="hljs-keyword">this</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p><code>totalCards</code> tracks the total number of cards that are in the game. If it changes,
we screwed up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@totalCards</span> = <span class="hljs-keyword">this</span>.countTotalCards()

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p><code>setUpWithOptions</code> is the function I’d like to use as the primary way of setting up
a new game, doing the work of choosing a set of kingdom and extra cards (what I call
the tableau) with the cards they require plus random cards, and handling options.</p>
<p>It takes two arguments, <code>ais</code> and <code>options</code>. <code>ais</code> is the list of AI objects, and
<code>options</code> is an object with these keys and values:</p>
<ul>
<li><code>randomizeOrder</code>: whether to shuffle the player order. Defaults to true.</li>
<li><code>colonies</code>: whether to add Colonies and Platinums to the tableau. Defaults
to false-ish: it can be set to true by a strategy that requires Colony if
left undefined.</li>
<li>`log</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setUpWithOptions</span>: <span class="hljs-function"><span class="hljs-params">(ais, options)</span> -&gt;</span>
    tableau = []
    <span class="hljs-keyword">if</span> options.<span class="hljs-built_in">require</span>?
      <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> options.<span class="hljs-built_in">require</span>
        tableau.push(c[card])
    <span class="hljs-keyword">for</span> ai <span class="hljs-keyword">in</span> ais
      <span class="hljs-keyword">if</span> ai.requires?
        <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> ai.requires
          card = c[card]
          <span class="hljs-keyword">if</span> card <span class="hljs-keyword">in</span> [c.Colony, c.Platinum]
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.colonies?
              options.colonies = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> options.colonies <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span>
              <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"This setup forbids Colonies, but <span class="hljs-subst">#{ai}</span> requires them"</span>)
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> tableau <span class="hljs-keyword">and</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.basicSupply\
               <span class="hljs-keyword">and</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.extraSupply <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> card.isPrize
            tableau.push(card)

    <span class="hljs-keyword">if</span> tableau.length &gt; <span class="hljs-number">10</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"These strategies require too many different cards to play against each other."</span>)
    
    index = <span class="hljs-number">0</span>
    moreCards = c.allCards.slice(<span class="hljs-number">0</span>)
    shuffle(moreCards)
    <span class="hljs-keyword">while</span> tableau.length &lt; <span class="hljs-number">10</span>
      card = c[moreCards[index]]
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (card <span class="hljs-keyword">in</span> tableau <span class="hljs-keyword">or</span> card <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.basicSupply <span class="hljs-keyword">or</span> card <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.extraSupply <span class="hljs-keyword">or</span> card.isPrize)
        tableau.push(card)
      index++

    <span class="hljs-keyword">if</span> options.colonies
      tableau.push(c.Colony)
      tableau.push(c.Platinum)
    
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> tableau
      <span class="hljs-keyword">if</span> card.costPotion &gt; <span class="hljs-number">0</span>
        <span class="hljs-keyword">if</span> c.Potion <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> tableau
          tableau.push(c.Potion)
    
    <span class="hljs-keyword">if</span> options.randomizeOrder
      shuffle(ais)
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.initialize(ais, tableau, options.log ? <span class="hljs-built_in">console</span>.log)</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Given the tableau (the set of non-basic cards in play), construct the
appropriate supply for the number of players.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">makeSupply</span>: <span class="hljs-function"><span class="hljs-params">(tableau)</span> -&gt;</span>
    allCards = <span class="hljs-keyword">this</span>.basicSupply.concat(tableau)
    supply = {}
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> allCards
      <span class="hljs-keyword">if</span> c[card].startingSupply(<span class="hljs-keyword">this</span>) &gt; <span class="hljs-number">0</span>
        card = c[card] ? card
        supply[card] = card.startingSupply(<span class="hljs-keyword">this</span>)
    supply</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <h3 id="informational-methods">Informational methods</h3>
<p>These methods are referred to by some card effects, but can also be useful
in crafting a strategy.</p>
<p><code>emptyPiles()</code> determines which supply piles are empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">emptyPiles</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    piles = []
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> <span class="hljs-property">@supply</span>
      <span class="hljs-keyword">if</span> value == <span class="hljs-number">0</span>
        piles.push(key)
    piles</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p><code>numEmptyPiles()</code> simply returns the number of empty piles.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">numEmptyPiles</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">this</span>.emptyPiles().length</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p><code>filledPiles()</code> determines which supply piles are not empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">filledPiles</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    piles = []
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> <span class="hljs-property">@supply</span>
      <span class="hljs-keyword">if</span> value &gt; <span class="hljs-number">0</span>
        piles.push(key)
    piles</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p><code>gameIsOver()</code> returns whether the game is over.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">gameIsOver</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>The game can only end after a player has taken a full turn. Check that
by making sure the phase is <code>&#39;start&#39;</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@phase</span> != <span class="hljs-string">'start'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Check all the conditions in which empty piles can end the game.
Add a fake game-ending condition, too, which is a stalemate the SillyAI
sometimes ends up in.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    emptyPiles = <span class="hljs-keyword">this</span>.emptyPiles()
    <span class="hljs-keyword">if</span> emptyPiles.length &gt;= <span class="hljs-keyword">this</span>.totalPilesToEndGame() \
        <span class="hljs-keyword">or</span> (<span class="hljs-property">@nPlayers</span> &lt; <span class="hljs-number">5</span> <span class="hljs-keyword">and</span> emptyPiles.length &gt;= <span class="hljs-number">3</span>) \
        <span class="hljs-keyword">or</span> <span class="hljs-string">'Province'</span> <span class="hljs-keyword">in</span> emptyPiles \
        <span class="hljs-keyword">or</span> <span class="hljs-string">'Colony'</span> <span class="hljs-keyword">in</span> emptyPiles \
        <span class="hljs-keyword">or</span> (<span class="hljs-string">'Curse'</span> <span class="hljs-keyword">in</span> emptyPiles <span class="hljs-keyword">and</span> <span class="hljs-string">'Copper'</span> <span class="hljs-keyword">in</span> emptyPiles <span class="hljs-keyword">and</span> <span class="hljs-property">@current</span>.turnsTaken &gt;= <span class="hljs-number">100</span>)
      <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"Empty piles: <span class="hljs-subst">#{emptyPiles}</span>"</span>)
      <span class="hljs-keyword">for</span> [playerName, vp, turns] <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.getFinalStatus()
        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{playerName}</span> took <span class="hljs-subst">#{turns}</span> turns and scored <span class="hljs-subst">#{vp}</span> points."</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p><code>getFinalStatus()</code> is a useful thing to call when <code>gameIsOver()</code> is true.
It returns a list of triples of [player name, score, turns taken].</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getFinalStatus</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    ([player.ai.toString(), player.getVP(<span class="hljs-keyword">this</span>), player.turnsTaken] <span class="hljs-keyword">for</span> player <span class="hljs-keyword">in</span> <span class="hljs-property">@players</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p><code>getWinners()</code> returns a list (usually of length 1) of the names of players
that won the game, or would win if it were over now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getWinners</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    scores = <span class="hljs-keyword">this</span>.getFinalStatus()
    best = []
    bestScore = -Infinity
    
    <span class="hljs-keyword">for</span> [player, score, turns] <span class="hljs-keyword">in</span> scores</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Modify the score by subtracting a fraction of turnsTaken.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      modScore = score - turns/<span class="hljs-number">100</span>

      <span class="hljs-keyword">if</span> modScore == bestScore
        best.push(player)
      <span class="hljs-keyword">if</span> modScore &gt; bestScore
        best = [player]
        bestScore = modScore
    best</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p><code>countInSupply()</code> returns the number of copies of a card that remain
in the supply. It can take in either a card object or card name.</p>
<p>If the card has never been in the supply, it returns 0,
so it is safe to refer to <code>state.countInSupply(&#39;Colony&#39;)</code> even in
a non-Colony game. This does not count as an empty pile, of course.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">countInSupply</span>: <span class="hljs-function"><span class="hljs-params">(card)</span> -&gt;</span>
    <span class="hljs-property">@supply</span>[card] ? <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p><code>totalPilesToEndGame()</code> returns the number of empty piles that triggers
the end of the game, which is almost always 3.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">totalPilesToEndGame</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">switch</span> <span class="hljs-property">@nPlayers</span>
      <span class="hljs-keyword">when</span> <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span> <span class="hljs-keyword">then</span> <span class="hljs-number">3</span>
      <span class="hljs-keyword">else</span> <span class="hljs-number">4</span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>As a useful heuristic, <code>gainsToEndGame()</code> returns the minimum number of
buys/gains that would have to be used by an opponent who is determined to
end the game. A low number means the game is probably ending soon.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">gainsToEndGame</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@cache</span>.gainsToEndGame?
      <span class="hljs-keyword">return</span> <span class="hljs-property">@cache</span>.gainsToEndGame
    counts = (count <span class="hljs-keyword">for</span> card, count <span class="hljs-keyword">of</span> <span class="hljs-property">@supply</span>)
    numericSort(counts)</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>First, add up the smallest 3 (or 4) piles.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    piles = <span class="hljs-keyword">this</span>.totalPilesToEndGame()
    minimum = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> count <span class="hljs-keyword">in</span> counts[...piles]
      minimum += count</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Then compare this to the number of Provinces or possibly Colonies
remaining, and see which one is smallest.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    minimum = Math.min(minimum, <span class="hljs-property">@supply</span>[<span class="hljs-string">'Province'</span>])
    <span class="hljs-keyword">if</span> <span class="hljs-property">@supply</span>[<span class="hljs-string">'Colony'</span>]?
      minimum = Math.min(minimum, <span class="hljs-property">@supply</span>[<span class="hljs-string">'Colony'</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Cache the result; apparently it’s expensive to compute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@cache</span>.gainsToEndGame = minimum
    minimum</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p><code>smugglerChoices</code> determines the set of cards that could be gained with a
Smuggler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">smugglerChoices</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    choices = [<span class="hljs-literal">null</span>]
    prevPlayer = <span class="hljs-property">@players</span>[<span class="hljs-property">@nPlayers</span> - <span class="hljs-number">1</span>]
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> prevPlayer.gainedThisTurn
      [coins, potions] = card.getCost(<span class="hljs-keyword">this</span>)
      <span class="hljs-keyword">if</span> potions == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> coins &lt;= <span class="hljs-number">6</span>
        choices.push(card)
    choices</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p><code>countTotalCards</code> counts the number of cards that exist anywhere.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">countTotalCards</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    total = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> player <span class="hljs-keyword">in</span> <span class="hljs-property">@players</span>
      total += player.numCardsInDeck()
    <span class="hljs-keyword">for</span> card, count <span class="hljs-keyword">of</span> <span class="hljs-property">@supply</span>
      total += count
    <span class="hljs-keyword">for</span> card, count <span class="hljs-keyword">of</span> <span class="hljs-property">@specialSupply</span>
      total += count
    total += <span class="hljs-property">@trash</span>.length
    total
    
  <span class="hljs-attribute">buyCausesToLose</span>: <span class="hljs-function"><span class="hljs-params">(player, state, card)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> card? || <span class="hljs-property">@supply</span>[card] &gt; <span class="hljs-number">1</span> || state.gainsToEndGame() &gt; <span class="hljs-number">1</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Check to see if the player would be in the lead after buying this card</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    maxOpponentScore = -Infinity
    <span class="hljs-keyword">for</span> status <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.getFinalStatus()
      [name, score, turns] = status
      <span class="hljs-keyword">if</span> name == player.ai.toString()
        myScore = score + card.getVP(player)
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> score &gt; maxOpponentScore
        maxOpponentScore = score

    <span class="hljs-keyword">if</span> myScore &gt; maxOpponentScore
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>One level of recursion is enough for first</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.depth==<span class="hljs-number">0</span>)
      [hypState, hypMy] = state.hypothetical(player.ai)
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>try to buy this card
C&amp;P from below</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [coinCost, potionCost] = card.getCost(<span class="hljs-keyword">this</span>)
    hypMy.coins -= coinCost
    hypMy.potions -= potionCost
    hypMy.buys -= <span class="hljs-number">1</span>

    hypState.gainCard(hypMy, card, <span class="hljs-string">'discard'</span>, <span class="hljs-literal">true</span>)
    card.onBuy(hypState)
      

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [hypMy.inPlay.length-<span class="hljs-number">1.</span>..-<span class="hljs-number">1</span>]
        cardInPlay = hypMy.inPlay[i]
      <span class="hljs-keyword">if</span> cardInPlay?
        cardInPlay.buyInPlayEffect(hypState, card)

      goonses = hypMy.countInPlay(<span class="hljs-string">'Goons'</span>)
      <span class="hljs-keyword">if</span> goonses &gt; <span class="hljs-number">0</span>
        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"...gaining <span class="hljs-subst">#{goonses}</span> VP."</span>)
        hypMy.chips += goonses</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>C&amp;P until here</p>

            </div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>finish buyPhase</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    hypState.doBuyPhase()</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>find out if game ended and who if we have won it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    hypState.phase = <span class="hljs-string">'start'</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> hypState.gameIsOver() 
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">if</span> ( hypMy.ai.toString() <span class="hljs-keyword">in</span> hypState.getWinners() )
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    state.log(<span class="hljs-string">"Buying <span class="hljs-subst">#{card}</span> will cause <span class="hljs-subst">#{player.ai}</span> to lose the game"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <h3 id="playing-a-turn">Playing a turn</h3>
<p><code>doPlay</code> performs the next step of the game, which is a particular phase
of a particular player’s turn. If the phase is…</p>
<ul>
<li>‘start’: resolve duration effects, then go to action phase</li>
<li>‘action’: play and resolve some number of actions, then go to
  treasure phase</li>
<li>‘treasure’: play and resolve some number of treasures, then go to
  buy phase</li>
<li>‘buy’: buy some number of cards, then go to cleanup phase</li>
<li>‘cleanup’: resolve cleanup effects, discard everything, draw 5 cards,
  and go to the start phase of the next player’s turn.</li>
</ul>
<p>To play the entire game, iterate <code>doPlay()</code> until <code>gameIsOver()</code>. Putting
this in a single loop would be a bad idea because it would make Web
browsers freeze up. Browser-facing code should return control after each
call to <code>doPlay()</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">doPlay</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>  
    <span class="hljs-keyword">switch</span> <span class="hljs-property">@phase</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">'start'</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@extraturn</span>
          <span class="hljs-property">@current</span>.turnsTaken += <span class="hljs-number">1</span>
          <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"\n== <span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span>'s turn <span class="hljs-subst">#{<span class="hljs-property">@current</span>.turnsTaken}</span> =="</span>)
          <span class="hljs-keyword">this</span>.doDurationPhase()
          <span class="hljs-property">@phase</span> = <span class="hljs-string">'action'</span>
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"\n== <span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span>'s turn <span class="hljs-subst">#{<span class="hljs-property">@current</span>.turnsTaken}</span>+ =="</span>)
          <span class="hljs-keyword">this</span>.doDurationPhase()
          <span class="hljs-property">@phase</span> = <span class="hljs-string">'action'</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">'action'</span>
        <span class="hljs-keyword">this</span>.doActionPhase()
        <span class="hljs-property">@phase</span> = <span class="hljs-string">'treasure'</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">'treasure'</span>
        <span class="hljs-keyword">this</span>.doTreasurePhase()
        <span class="hljs-property">@phase</span> = <span class="hljs-string">'buy'</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">'buy'</span>
        <span class="hljs-keyword">this</span>.doBuyPhase()
        <span class="hljs-property">@phase</span> = <span class="hljs-string">'cleanup'</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">'cleanup'</span>
        <span class="hljs-keyword">this</span>.doCleanupPhase()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@extraturn</span>
          <span class="hljs-keyword">this</span>.rotatePlayer()
        <span class="hljs-keyword">else</span>
          <span class="hljs-property">@phase</span> = <span class="hljs-string">'start'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p><code>@current.duration</code> contains all cards that are in play with duration
effects. At the start of the turn, check all of these cards and run their
<code>onDuration</code> method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">doDurationPhase</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Clear out the list of cards gained. (We clear it here because this
information is actually used by Smugglers.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@current</span>.gainedThisTurn = []</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>iterate backwards because cards might move</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-property">@current</span>.duration.length-<span class="hljs-number">1.</span>..-<span class="hljs-number">1</span>]
      card = <span class="hljs-property">@current</span>.duration[i]
      <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span> resolves the duration effect of <span class="hljs-subst">#{card}</span>."</span>)
      card.onDuration(<span class="hljs-keyword">this</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p><code>@current.multipliedDurations</code> contains virtual copies of cards, which
exist because a multiplier was played on a Duration card.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-property">@current</span>.multipliedDurations
      <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span> resolves the duration effect of <span class="hljs-subst">#{card}</span> again."</span>)
      card.onDuration(<span class="hljs-keyword">this</span>)
    
    <span class="hljs-property">@current</span>.multipliedDurations = []</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Perform the action phase. Ask the AI repeatedly which action to play,
until there are no more action cards to play or there are no
actions remaining to play them with, or the AI chooses <code>null</code>, indicating
that it doesn’t want to play an action.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">doActionPhase</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">while</span> <span class="hljs-property">@current</span>.actions &gt; <span class="hljs-number">0</span>
      validActions = [<span class="hljs-literal">null</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Determine the set of unique actions that may be played.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-property">@current</span>.hand
        <span class="hljs-keyword">if</span> card.isAction <span class="hljs-keyword">and</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> validActions
          validActions.push(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Ask the AI for its choice.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      action = <span class="hljs-property">@current</span>.ai.chooseAction(<span class="hljs-keyword">this</span>, validActions)
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> action <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Remove the action from the hand and put it in the play area.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> action <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-property">@current</span>.hand
        <span class="hljs-keyword">this</span>.warn(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span> chose an invalid action."</span>)
        <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">this</span>.playAction(action)</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>The current player plays an action from the hand, and performs the effect
of the action.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">playAction</span>: <span class="hljs-function"><span class="hljs-params">(action)</span> -&gt;</span>
    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span> plays <span class="hljs-subst">#{action}</span>."</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Subtract 1 from the action count and perform the action.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@current</span>.hand.remove(action)
    <span class="hljs-property">@current</span>.inPlay.push(action)
    <span class="hljs-property">@current</span>.playLocation = <span class="hljs-string">'inPlay'</span>
    <span class="hljs-property">@current</span>.actions -= <span class="hljs-number">1</span>
    <span class="hljs-keyword">this</span>.resolveAction(action)</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Another event that causes actions to be played, such as Throne Room,
should skip straight to <code>resolveAction</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">resolveAction</span>: <span class="hljs-function"><span class="hljs-params">(action)</span> -&gt;</span>
    <span class="hljs-property">@current</span>.actionStack.push(action)
    <span class="hljs-property">@current</span>.actionsPlayed += <span class="hljs-number">1</span>
    action.onPlay(<span class="hljs-keyword">this</span>)
    <span class="hljs-property">@current</span>.actionStack.pop()</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>The “treasure phase” is a concept introduced in Prosperity. After playing
actions, you play any number of treasures in some order. This loop
repeats until the AI chooses <code>null</code>, either because there are no treasures
left to play or because it does not want to play any more treasures.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">doTreasurePhase</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">loop</span>
      validTreasures = [<span class="hljs-literal">null</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Determine the set of unique treasures that may be played.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-property">@current</span>.hand
        <span class="hljs-keyword">if</span> card.isTreasure <span class="hljs-keyword">and</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> validTreasures
          validTreasures.push(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Ask the AI for its choice.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      treasure = <span class="hljs-property">@current</span>.ai.chooseTreasure(<span class="hljs-keyword">this</span>, validTreasures)
      <span class="hljs-keyword">break</span> <span class="hljs-keyword">if</span> treasure <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
      <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span> plays <span class="hljs-subst">#{treasure}</span>."</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Remove the treasure from the hand and put it in the play area.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> treasure <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-property">@current</span>.hand
        <span class="hljs-keyword">this</span>.warn(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span> chose an invalid treasure"</span>)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">this</span>.playTreasure(treasure)
    
    <span class="hljs-keyword">while</span> (ctd = <span class="hljs-keyword">this</span>.getCoinTokenDecision()) &gt; <span class="hljs-number">0</span>
      <span class="hljs-property">@current</span>.coins += ctd
      <span class="hljs-property">@current</span>.coinTokens -= ctd
  
  <span class="hljs-attribute">getCoinTokenDecision</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    ct = <span class="hljs-property">@current</span>.ai.spendCoinTokens(<span class="hljs-keyword">this</span>, <span class="hljs-property">@current</span>)
    <span class="hljs-keyword">if</span> (ct &gt; <span class="hljs-property">@current</span>.coinTokens)
      <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span> wants to spend more Coin Tokens as it possesses (<span class="hljs-subst">#{ct}</span>/<span class="hljs-subst">#{<span class="hljs-property">@current</span>.coinTokens}</span>)"</span>)
      ct = <span class="hljs-property">@current</span>.coinTokens
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">if</span> (ct &gt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span> spends <span class="hljs-subst">#{ct}</span> Coin Token<span class="hljs-subst">#{<span class="hljs-keyword">if</span> ct &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-string">"s"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>}</span>"</span>)
    <span class="hljs-property">@current</span>.coinTokensSpendThisTurn = ct
    <span class="hljs-keyword">return</span> ct
    
  
  <span class="hljs-attribute">playTreasure</span>: <span class="hljs-function"><span class="hljs-params">(treasure)</span> -&gt;</span>
    <span class="hljs-property">@current</span>.hand.remove(treasure)
    <span class="hljs-property">@current</span>.inPlay.push(treasure)
    <span class="hljs-property">@current</span>.playLocation = <span class="hljs-string">'inPlay'</span>
    treasure.onPlay(<span class="hljs-keyword">this</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p><code>getSingleBuyDecision</code> determines what single card (or none) the AI
wants to buy in the current state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getSingleBuyDecision</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    buyable = [<span class="hljs-literal">null</span>]
    checkSuicide = (<span class="hljs-keyword">this</span>.depth == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">this</span>.gainsToEndGame() &lt;= <span class="hljs-number">2</span>)
    <span class="hljs-keyword">for</span> cardname, count <span class="hljs-keyword">of</span> <span class="hljs-property">@supply</span></pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Because the supply must reference cards by their names, we use
<code>c[cardname]</code> to get the actual object for the card.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      card = c[cardname]</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Determine whether each card can be bought in the current state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> card.mayBeBought(<span class="hljs-keyword">this</span>) <span class="hljs-keyword">and</span> count &gt; <span class="hljs-number">0</span>
        [coinCost, potionCost] = card.getCost(<span class="hljs-keyword">this</span>)
        <span class="hljs-keyword">if</span> coinCost &lt;= <span class="hljs-property">@current</span>.coins <span class="hljs-keyword">and</span> potionCost &lt;= <span class="hljs-property">@current</span>.potions
          buyable.push(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Don’t allow cards that will lose us the game</p>
<p>Note that this just cares for the buyPhase, gains by other means (Workshop) are not covered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> checkSuicide
      buyable = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> buyable <span class="hljs-keyword">when</span> (<span class="hljs-keyword">not</span> <span class="hljs-keyword">this</span>.buyCausesToLose(<span class="hljs-property">@current</span>, <span class="hljs-keyword">this</span>, card)))</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Ask the AI for its choice.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"Coins: <span class="hljs-subst">#{<span class="hljs-property">@current</span>.coins}</span>, Potions: <span class="hljs-subst">#{<span class="hljs-property">@current</span>.potions}</span>, Buys: <span class="hljs-subst">#{<span class="hljs-property">@current</span>.buys}</span>"</span>)
    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"Coin Tokens left: <span class="hljs-subst">#{<span class="hljs-property">@current</span>.coinTokens}</span>"</span>)
    choice = <span class="hljs-property">@current</span>.ai.chooseGain(<span class="hljs-keyword">this</span>, buyable)
    <span class="hljs-keyword">return</span> choice</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p><code>doBuyPhase</code> steps through the buy phase, asking the AI to choose
a card to buy until it has no buys left or chooses to buy nothing.</p>
<p>Setting <code>hypothetical</code> to true will skip gaining the cards and simply
return the card list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">doBuyPhase</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">while</span> <span class="hljs-property">@current</span>.buys &gt; <span class="hljs-number">0</span>
      choice = <span class="hljs-keyword">this</span>.getSingleBuyDecision()
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
      <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span> buys <span class="hljs-subst">#{choice}</span>."</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Update money and buys.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      [coinCost, potionCost] = choice.getCost(<span class="hljs-keyword">this</span>)
      <span class="hljs-property">@current</span>.coins -= coinCost
      <span class="hljs-property">@current</span>.potions -= potionCost
      <span class="hljs-property">@current</span>.buys -= <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>Gain the card and deal with the effects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.gainCard(<span class="hljs-property">@current</span>, choice, <span class="hljs-string">'discard'</span>, <span class="hljs-literal">true</span>)
      choice.onBuy(<span class="hljs-keyword">this</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Handle cards such as Talisman that respond to cards being bought.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-property">@current</span>.inPlay.length-<span class="hljs-number">1.</span>..-<span class="hljs-number">1</span>]
        cardInPlay = <span class="hljs-property">@current</span>.inPlay[i]</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>If a Mandarin put cards back on the deck, this card may not be
there anymore. This showed up in a fascinating interaction among
Talisman, Quarry, Border Village, and Mandarin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> cardInPlay?
          cardInPlay.buyInPlayEffect(<span class="hljs-keyword">this</span>, choice)</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Handle all the things that happen at the end of the turn.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">doCleanupPhase</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Clean up Walled Villages first</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    actionCardsInPlay = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> <span class="hljs-property">@current</span>.inPlay
      <span class="hljs-keyword">if</span> card.isAction
        actionCardsInPlay += <span class="hljs-number">1</span>

    <span class="hljs-keyword">if</span> actionCardsInPlay &lt;= <span class="hljs-number">2</span>  
      <span class="hljs-keyword">while</span> c[<span class="hljs-string">'Walled Village'</span>] <span class="hljs-keyword">in</span> <span class="hljs-property">@current</span>.inPlay
        transferCardToTop(c[<span class="hljs-string">'Walled Village'</span>], <span class="hljs-property">@current</span>.inPlay, <span class="hljs-property">@current</span>.draw)
        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span> returns a Walled Village to the top of the deck."</span>)

    <span class="hljs-property">@extraturn</span> = <span class="hljs-keyword">not</span> <span class="hljs-property">@extraturn</span> <span class="hljs-keyword">and</span> (c[<span class="hljs-string">'Outpost'</span>] <span class="hljs-keyword">in</span> <span class="hljs-property">@current</span>.inPlay)</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>Discard old duration cards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@current</span>.discard = <span class="hljs-property">@current</span>.discard.concat <span class="hljs-property">@current</span>.duration
    <span class="hljs-property">@current</span>.duration = []</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>If there are cards set aside at this point, it probably means something
went wrong in performing an action. But clean them up anyway.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-property">@current</span>.setAside.length &gt; <span class="hljs-number">0</span>
      <span class="hljs-keyword">this</span>.warn([<span class="hljs-string">"Cards were set aside at the end of turn"</span>, <span class="hljs-property">@current</span>.setAside])
      <span class="hljs-property">@current</span>.discard = <span class="hljs-property">@current</span>.discard.concat <span class="hljs-property">@current</span>.setAside
      <span class="hljs-property">@current</span>.setAside = []</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>Check which multiplier cards ended up in <code>multipliedDurations</code>, which means
they should be cleaned up as if they were duration cards. Remove them once
they’re dealt with. Disregard the other cards there for now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-property">@current</span>.multipliedDurations.length-<span class="hljs-number">1.</span>..-<span class="hljs-number">1</span>]
      card = <span class="hljs-property">@current</span>.multipliedDurations[i]
      <span class="hljs-keyword">if</span> card.isMultiplier
        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span> puts a <span class="hljs-subst">#{card}</span> in the duration area."</span>)
        <span class="hljs-property">@current</span>.inPlay.remove(card)
        <span class="hljs-property">@current</span>.duration.push(card)
        <span class="hljs-property">@current</span>.multipliedDurations.splice(i, <span class="hljs-number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>Handle effects of cleaning up the card, which may involve moving it
somewhere else.  We do this before removing cards from play because
cards such as Scheme and Herbalist need to consider cards in play.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cardsToCleanup = <span class="hljs-property">@current</span>.inPlay.concat().reverse()
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [cardsToCleanup.length-<span class="hljs-number">1.</span>..-<span class="hljs-number">1</span>]
      card = cardsToCleanup[i]
      card.onCleanup(<span class="hljs-keyword">this</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>Clean up cards in play.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">while</span> <span class="hljs-property">@current</span>.inPlay.length &gt; <span class="hljs-number">0</span>
      card = <span class="hljs-property">@current</span>.inPlay[<span class="hljs-number">0</span>]
      <span class="hljs-property">@current</span>.inPlay = <span class="hljs-property">@current</span>.inPlay[<span class="hljs-number">1.</span>..]</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Put duration cards by default in the duration area, and other cards
in play in the discard pile.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> card.isDuration
        <span class="hljs-property">@current</span>.duration.push(card)
      <span class="hljs-keyword">else</span>
        <span class="hljs-property">@current</span>.discard.push(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Discard the remaining cards in hand.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@current</span>.discard = <span class="hljs-property">@current</span>.discard.concat(<span class="hljs-property">@current</span>.hand)
    <span class="hljs-property">@current</span>.hand = []</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>Reset things for the next turn.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@current</span>.actions = <span class="hljs-number">1</span>
    <span class="hljs-property">@current</span>.buys = <span class="hljs-number">1</span>
    <span class="hljs-property">@current</span>.coins = <span class="hljs-number">0</span>
    <span class="hljs-property">@current</span>.potions = <span class="hljs-number">0</span>
    <span class="hljs-property">@current</span>.actionsPlayed = <span class="hljs-number">0</span>
    <span class="hljs-property">@copperValue</span> = <span class="hljs-number">1</span>

    <span class="hljs-property">@costModifiers</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>Announce extra turn</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-property">@extraturn</span>       
      <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@current</span>.ai}</span> takes an extra turn from Outpost."</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>Finally, draw the next hand of three/five cards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (c.Outpost <span class="hljs-keyword">in</span> <span class="hljs-property">@current</span>.duration)
      <span class="hljs-property">@current</span>.drawCards(<span class="hljs-number">5</span>)
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@current</span>.drawCards(<span class="hljs-number">3</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Make sure we didn’t drop cards on the floor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.countTotalCards() != <span class="hljs-property">@totalCards</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"The game started with <span class="hljs-subst">#{<span class="hljs-property">@totalCards</span>}</span> cards; now there are <span class="hljs-subst">#{<span class="hljs-keyword">this</span>.countTotalCards()}</span>"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>The player list is implemented so that the current player is always first
in the list; the list rotates after every turn.</p>
<p>For convenience, the attribute <code>@current</code> always points to the current
player.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">rotatePlayer</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@players</span> = <span class="hljs-property">@players</span>[<span class="hljs-number">1.</span>..<span class="hljs-property">@nPlayers</span>].concat [<span class="hljs-property">@players</span>[<span class="hljs-number">0</span>]]
    <span class="hljs-property">@current</span> = <span class="hljs-property">@players</span>[<span class="hljs-number">0</span>]
    <span class="hljs-property">@phase</span> = <span class="hljs-string">'start'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <h3 id="small-scale-effects">Small-scale effects</h3>
<p><code>gainCard</code> performs the effects of a player gaining a card.</p>
<p>This is one of many events that affects a particular player, and
also has some effect on the overall state (in that the supply is
decreased). In this function and others like it, the <code>player</code> argument
is the appropriate PlayerState object to affect. This must, of course,
be one of the objects in the <code>@players</code> array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">gainCard</span>: <span class="hljs-function"><span class="hljs-params">(player, card, gainLocation=<span class="hljs-string">'discard'</span>, suppressMessage=<span class="hljs-literal">false</span>)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.depth == <span class="hljs-number">0</span>
      <span class="hljs-keyword">delete</span> <span class="hljs-property">@cache</span>.gainsToEndGame
    <span class="hljs-keyword">if</span> <span class="hljs-property">@supply</span>[card] &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-property">@specialSupply</span>[card] &gt; <span class="hljs-number">0</span>
      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [player.hand.length-<span class="hljs-number">1.</span>..-<span class="hljs-number">1</span>]
        reactCard = player.hand[i]
        <span class="hljs-keyword">if</span> reactCard? <span class="hljs-keyword">and</span> reactCard.isReaction <span class="hljs-keyword">and</span> reactCard.reactReplacingGain?
          card = reactCard.reactReplacingGain(<span class="hljs-keyword">this</span>, player, card)</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Keep track of the card gained, for Smugglers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> player <span class="hljs-keyword">is</span> <span class="hljs-property">@current</span>
        player.gainedThisTurn.push(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p><code>suppressMessage</code> is true when this happens as the direct result of a
buy. Nobody wants to read “X buys Y. X gains Y.” all the time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> suppressMessage
        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> gains <span class="hljs-subst">#{card}</span>."</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>Determine what list the card is being gained in, and add it to the
front of that list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      location = player[gainLocation]
      location.unshift(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Remove the card from the supply</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> <span class="hljs-property">@supply</span>[card] &gt; <span class="hljs-number">0</span>
        <span class="hljs-property">@supply</span>[card] -= <span class="hljs-number">1</span>
        gainSource = <span class="hljs-string">'supply'</span>
      <span class="hljs-keyword">else</span>
        <span class="hljs-property">@specialSupply</span>[card] -= <span class="hljs-number">1</span>
        gainSource = <span class="hljs-string">'specialSupply'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Delegate to <code>handleGainCard</code> to deal with reactions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.handleGainCard(player, card, gainLocation, gainSource)
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"There is no <span class="hljs-subst">#{card}</span> to gain."</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p><code>handleGainCard</code> deals with the reactions that result from gaining a card.
A card effect such as Thief needs to call this explicitly after gaining a
card from someplace that is not the supply or the prize list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">handleGainCard</span>: <span class="hljs-function"><span class="hljs-params">(player, card, gainLocation=<span class="hljs-string">'discard'</span>, gainSource=<span class="hljs-string">'supply'</span>)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>Remember where the card was gained, so that reactions can find it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    player.gainLocation = gainLocation

    <span class="hljs-keyword">for</span> own supplyCard, quantity <span class="hljs-keyword">of</span> <span class="hljs-property">@supply</span>
      c[supplyCard].globalGainEffect(<span class="hljs-keyword">this</span>, player, card, gainSource)

    <span class="hljs-keyword">for</span> own supplyCard, quantity <span class="hljs-keyword">of</span> <span class="hljs-property">@specialSupply</span>
      c[supplyCard].globalGainEffect(<span class="hljs-keyword">this</span>, player, card, gainSource)</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>Handle cards such as Royal Seal that respond to gains while they are
in play.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [player.inPlay.length-<span class="hljs-number">1.</span>..-<span class="hljs-number">1</span>]
      cardInPlay = player.inPlay[i]
      cardInPlay.gainInPlayEffect(<span class="hljs-keyword">this</span>, card)</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Handle cards such as Watchtower that react to gains as a Reaction card.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [player.hand.length-<span class="hljs-number">1.</span>..-<span class="hljs-number">1</span>]
      reactCard = player.hand[i]
      <span class="hljs-keyword">if</span> reactCard.isReaction
        reactCard.reactToGain(<span class="hljs-keyword">this</span>, player, card)
    
    <span class="hljs-keyword">for</span> opp <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.players[<span class="hljs-number">1.</span>..]
      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [opp.hand.length-<span class="hljs-number">1.</span>..-<span class="hljs-number">1</span>]
        reactCard = opp.hand[i]
        <span class="hljs-keyword">if</span> reactCard.isReaction
          reactCard.reactToOpponentGain(<span class="hljs-keyword">this</span>, opp, player, card)</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>Handle the card’s own effects of being gained.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    card.onGain(<span class="hljs-keyword">this</span>, player)</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>Effects of an action could cause players to reveal their hand.
So far, nothing happens as a result, but in the future, AIs might
be able to take advantage of the information.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">revealHand</span>: <span class="hljs-function"><span class="hljs-params">(player)</span> -&gt;</span>
    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> reveals the hand (<span class="hljs-subst">#{player.hand}</span>)."</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p><code>drawCards</code> causes the player to draw <code>num</code> cards.</p>
<p>This currently passes through directly to the PlayerState, without
passing any information from the global state.
An improved version would pass the state in case the player shuffles,
and has Stash in the deck, and wants to use information from the state
to decide where to put the Stash.</p>
<p>The drawn cards will be returned.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">drawCards</span>: <span class="hljs-function"><span class="hljs-params">(player, num)</span> -&gt;</span>
    player.drawCards(num)</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p><code>discardFromDeck</code> puts <em>num</em> cards from the top of the deck directly
in the discard pile. It returns the set of cards, for the benefit of
actions that do something based on which cards were discarded.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">discardFromDeck</span>: <span class="hljs-function"><span class="hljs-params">(player, nCards)</span> -&gt;</span>
    drawn = player.getCardsFromDeck(nCards)
    player.discard = player.discard.concat(drawn)
    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> draws and discards <span class="hljs-subst">#{drawn.length}</span> cards (<span class="hljs-subst">#{drawn}</span>)."</span>)
    <span class="hljs-keyword">this</span>.handleDiscards(player, drawn)
    <span class="hljs-keyword">return</span> drawn</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p><code>doDiscard</code> causes the player to discard a particular card.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">doDiscard</span>: <span class="hljs-function"><span class="hljs-params">(player, card)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> player.hand
      <span class="hljs-keyword">this</span>.warn(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> has no <span class="hljs-subst">#{card}</span> to discard"</span>)
      <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> discards <span class="hljs-subst">#{card}</span>."</span>)
    player.hand.remove(card)
    player.discard.push(card)
    <span class="hljs-keyword">this</span>.handleDiscards(player, [card])</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p><code>handleDiscards</code> looks through a list of cards and triggers their discard
reactions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">handleDiscards</span>: <span class="hljs-function"><span class="hljs-params">(player, cards)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> cards
      <span class="hljs-keyword">if</span> card.isReaction
        card.reactToDiscard(<span class="hljs-keyword">this</span>, player)</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p><code>doTrash</code> causes the player to trash a particular card.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">doTrash</span>: <span class="hljs-function"><span class="hljs-params">(player, card)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> player.hand
      <span class="hljs-keyword">this</span>.warn(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> has no <span class="hljs-subst">#{card}</span> to trash"</span>)
      <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> trashes <span class="hljs-subst">#{card}</span>."</span>)
    player.hand.remove(card)
    card.onTrash(<span class="hljs-keyword">this</span>, player)
    <span class="hljs-property">@trash</span>.push(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p><code>doPutOnDeck</code> puts a particular card from the player’s hand on top of
the player’s draw pile.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">doPutOnDeck</span>: <span class="hljs-function"><span class="hljs-params">(player, card)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> card <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> player.hand
      <span class="hljs-keyword">this</span>.warn(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> has no <span class="hljs-subst">#{card}</span> to put on deck."</span>)
      <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"<span class="hljs-subst">#{player.ai}</span> puts <span class="hljs-subst">#{card}</span> on deck."</span>)
    player.hand.remove(card)
    player.draw.unshift(card)</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p><code>getCardsFromDeck</code> is superficially similar to <code>drawCards</code>, but it does
not put the cards into the hand. Any code that calls it needs to determine
what happens to those cards (otherwise they’ll be dropped on the floor!)</p>
<p>This is useful
for effects that say “draw <em>n</em> cards, do something based on them, and
discard them”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getCardsFromDeck</span>: <span class="hljs-function"><span class="hljs-params">(player, num)</span> -&gt;</span>
    player.getCardsFromDeck(num)</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p><code>allowDiscard</code> allows a player to discard 0 through <code>num</code> cards.
added typeFunc to only allow discards of certain type of cards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">allowDiscard</span>: <span class="hljs-function"><span class="hljs-params">(player, num, typeFunc = (card) -&gt; <span class="hljs-literal">true</span>)</span> -&gt;</span>
    discarded = []
    <span class="hljs-keyword">while</span> discarded.length &lt; num</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>In <code>allowDiscard</code>, valid discards are the entire hand, plus <code>null</code>
to stop discarding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      validDiscards = ( card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> player.hand <span class="hljs-keyword">when</span> typeFunc(card?) ).slice(<span class="hljs-number">0</span>)
      validDiscards.push(<span class="hljs-literal">null</span>)
      choice = player.ai.chooseDiscard(<span class="hljs-keyword">this</span>, validDiscards)
      <span class="hljs-keyword">return</span> discarded <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
      discarded.push(choice)
      <span class="hljs-keyword">this</span>.doDiscard(player, choice)
    <span class="hljs-keyword">return</span> discarded</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p><code>requireDiscard</code> requires the player to discard exactly <code>num</code> cards,
except that it stops if the player has 0 cards in hand.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">requireDiscard</span>: <span class="hljs-function"><span class="hljs-params">(player, num, typeFunc = (card) -&gt; <span class="hljs-literal">true</span>)</span> -&gt;</span>
    discarded = []
    <span class="hljs-keyword">while</span> discarded.length &lt; num
      validDiscards = ( card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> player.hand <span class="hljs-keyword">when</span> typeFunc(card) ).slice(<span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span> discarded <span class="hljs-keyword">if</span> validDiscards.length == <span class="hljs-number">0</span>
      choice = player.ai.chooseDiscard(<span class="hljs-keyword">this</span>, validDiscards)
      discarded.push(choice)
      <span class="hljs-keyword">this</span>.doDiscard(player, choice)
    <span class="hljs-keyword">return</span> discarded</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p><code>allowTrash</code> and <code>requireTrash</code> are similar to <code>allowDiscard</code> and
<code>requireDiscard</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">allowTrash</span>: <span class="hljs-function"><span class="hljs-params">(player, num)</span> -&gt;</span>
    trashed = []
    <span class="hljs-keyword">while</span> trashed.length &lt; num
      valid = player.hand.slice(<span class="hljs-number">0</span>)
      valid.push(<span class="hljs-literal">null</span>)
      choice = player.ai.chooseTrash(<span class="hljs-keyword">this</span>, valid)
      <span class="hljs-keyword">return</span> trashed <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
      trashed.push(choice)
      <span class="hljs-keyword">this</span>.doTrash(player, choice)
    <span class="hljs-keyword">return</span> trashed
  
  <span class="hljs-attribute">requireTrash</span>: <span class="hljs-function"><span class="hljs-params">(player, num)</span> -&gt;</span>
    trashed = []
    <span class="hljs-keyword">while</span> trashed.length &lt; num
      valid = player.hand.slice(<span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span> trashed <span class="hljs-keyword">if</span> valid.length == <span class="hljs-number">0</span>
      choice = player.ai.chooseTrash(<span class="hljs-keyword">this</span>, valid)
      trashed.push(choice)
      <span class="hljs-keyword">this</span>.doTrash(player, choice)
    <span class="hljs-keyword">return</span> trashed</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p><code>gainOneOf</code> gives the player a choice of cards to gain. Include
<code>null</code> if gaining nothing is an option.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">gainOneOf</span>: <span class="hljs-function"><span class="hljs-params">(player, options, location=<span class="hljs-string">'discard'</span>)</span> -&gt;</span>
    choice = player.ai.chooseGain(<span class="hljs-keyword">this</span>, options)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> choice <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">this</span>.gainCard(player, choice, location)
    <span class="hljs-keyword">return</span> choice</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p><code>attackOpponents</code> takes in a function of one argument, and applies
it to all players except the one whose turn it is.</p>
<p>The function should take in the PlayerState of the player to attack,
and alter it somehow. This function can also involve the global state:
it doesn’t need to be passed in because it’s already in scope in the place
where the action is defined. See <code>Militia</code> in <code>cards.coffee</code> for an
example.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">attackOpponents</span>: <span class="hljs-function"><span class="hljs-params">(effect)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> opp <span class="hljs-keyword">in</span> <span class="hljs-property">@players</span>[<span class="hljs-number">1.</span>..]
      <span class="hljs-keyword">this</span>.attackPlayer(opp, effect)</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p><code>attackPlayer</code> does the work of attacking a particular player, including
handling their reactions to attacks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">attackPlayer</span>: <span class="hljs-function"><span class="hljs-params">(player, effect)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>attackEvent gets passed to each reactToAttack method.  Any card
may block the attack by setting attackEvent.blocked to true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    attackEvent = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Reaction cards in the hand can react to the attack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    reactionCards = (card <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> player.hand <span class="hljs-keyword">when</span> card.isReaction)

    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> reactionCards
      card.reactToAttack(<span class="hljs-keyword">this</span>, player, attackEvent)
    
    <span class="hljs-keyword">for</span> card <span class="hljs-keyword">in</span> player.duration
      card.durationReactToAttack(<span class="hljs-keyword">this</span>, player, attackEvent)</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>Apply the attack’s effect unless it’s been blocked by a card such as
Moat or Lighthouse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    effect(player) <span class="hljs-keyword">unless</span> attackEvent.blocked</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <h3 id="bookkeeping">Bookkeeping</h3>
<p><code>copy()</code> makes a copy of this state that can be safely mutated
without affecting the original state.</p>
<p>Ideally, the AI would be passed a copy of the state, with unknown
information randomized, when it is asked to make a decision. This would
allow it to try simulating the effects of various plays without actually
breaking the game. But this isn’t implemented yet, so make this a TODO.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">copy</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    newSupply = {}
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> <span class="hljs-property">@supply</span>
      newSupply[key] = value
    
    newSpecialSupply = {}
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> <span class="hljs-property">@specialSupply</span>
      newSpecialSupply[key] = value

    newState = <span class="hljs-keyword">new</span> State()</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>If something overrode the log function, make sure that’s preserved.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    newState.logFunc = <span class="hljs-property">@logFunc</span>

    newPlayers = []
    <span class="hljs-keyword">for</span> player <span class="hljs-keyword">in</span> <span class="hljs-property">@players</span>
      playerCopy = player.copy()
      playerCopy.<span class="hljs-function"><span class="hljs-title">logFunc</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
      newPlayers.push(playerCopy)</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>Copy card-specific state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    newCardState = {}
    <span class="hljs-keyword">for</span> card, state <span class="hljs-keyword">of</span> <span class="hljs-property">@cardState</span></pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>If the card state has a copy method, call it, otherwise just shallow
copy the state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> state.copy?</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>Objects with a copy method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        newCardState[card] = state.copy?()
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> state == <span class="hljs-string">'object'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>Objects with no copy method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        newCardState[card] = copy = {}
        copy[k] = v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> state
      <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>Simple types</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        newCardState[card] = state
    
    newState.players = newPlayers
    newState.supply = newSupply
    newState.specialSupply = newSpecialSupply
    newState.cardState = newCardState
    newState.trash = <span class="hljs-property">@trash</span>.slice(<span class="hljs-number">0</span>)
    newState.current = newPlayers[<span class="hljs-number">0</span>]
    newState.nPlayers = <span class="hljs-property">@nPlayers</span>
    newState.costModifiers = <span class="hljs-property">@costModifiers</span>.concat()
    newState.copperValue = <span class="hljs-property">@copperValue</span>
    newState.phase = <span class="hljs-property">@phase</span>
    newState.cache = {}

    newState</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p><code>hypothetical(ai)</code> returns a State and PlayerState that an AI can do
whatever it wants to without affecting the real state:</p>
<ul>
<li>Modifying the state will not affect the game (it is a copy, after all).</li>
<li>The hidden information in the state is randomized.</li>
<li>All the other AIs will be replaced by copies of the given AI.</li>
</ul>
<p>An AI that wants to test a hypothesis should do this:
  [state, my] = state.hypothetical(this)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">hypothetical</span>: <span class="hljs-function"><span class="hljs-params">(ai)</span> -&gt;</span>
    state = <span class="hljs-keyword">this</span>.copy()</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>Rotate through players until this AI is the current player.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    counter = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> state.players[<span class="hljs-number">0</span>].ai <span class="hljs-keyword">isnt</span> ai
      counter++
      <span class="hljs-keyword">if</span> counter &gt; state.nPlayers
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"Can't find this AI in the player list"</span>)
      state.players = state.players[<span class="hljs-number">1.</span>..].concat([state.players[<span class="hljs-number">0</span>]])

    state.depth = <span class="hljs-keyword">this</span>.depth + <span class="hljs-number">1</span>
    my = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">for</span> player <span class="hljs-keyword">in</span> state.players
      <span class="hljs-keyword">if</span> player.ai <span class="hljs-keyword">isnt</span> ai
        player.ai = ai.copy()</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>We don’t know what’s in their hand or their deck, so shuffle them
together randomly, preserving the number of cards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        handSize = player.hand.length
        combined = player.hand.concat(player.draw)
        shuffle(combined)
        player.hand = combined[...handSize]
        player.draw = combined[handSize...]
      <span class="hljs-keyword">else</span>
        shuffle(player.draw)
        my = player

    [state, my]</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>Functions for comparing, used for sorting</p>
<p>Rob says: this is pretty AI-specific. It’s also an unnecessarily complex operation,
even given caching. The choices are already in order in the actionPriority; they need
to be filtered, not sorted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">compareByActionPriority</span>: <span class="hljs-function"><span class="hljs-params">(state, my, x, y)</span> -&gt;</span>
    my.ai.cacheActionPriority(state,my)
    my.ai.choiceToValue(<span class="hljs-string">'cachedAction'</span>, state, x) - my.ai.choiceToValue(<span class="hljs-string">'cachedAction'</span>, state, y)
    
  <span class="hljs-attribute">compareByCoinCost</span>: <span class="hljs-function"><span class="hljs-params">(state, my, x, y)</span> -&gt;</span>
    x.getCost(state)[<span class="hljs-number">0</span>] - y.getCost(state)[<span class="hljs-number">0</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>Games can provide output using the <code>log</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">log</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>Only log things that actually happen.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-property">@depth</span> == <span class="hljs-number">0</span>
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.logFunc?
        <span class="hljs-keyword">this</span>.logFunc(obj)
      <span class="hljs-keyword">else</span> 
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">console</span>?
          <span class="hljs-built_in">console</span>.log(obj)</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>A warning has a similar effect to a log message, but indicates that
something has gone wrong with the gameplay.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">warn</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">console</span>?
      <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"WARNING: "</span>, obj)</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>Define some possible tableaux to play the game with. None of these are
actually legal tableaux, but that gives strategies more room to play.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">this</span>.tableaux = {
  <span class="hljs-attribute">moneyOnly</span>: []
  <span class="hljs-attribute">moneyOnlyColony</span>: [<span class="hljs-string">'Platinum'</span>, <span class="hljs-string">'Colony'</span>]
  <span class="hljs-attribute">all</span>: c.allCards
}</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>How to remove something from a JavaScript array. Modifies the list and
returns the 0 or 1 removed elements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Array.prototype.<span class="hljs-function"><span class="hljs-title">remove</span> = <span class="hljs-params">(elt)</span> -&gt;</span>
  idx = <span class="hljs-keyword">this</span>.lastIndexOf(elt)
  <span class="hljs-keyword">if</span> idx != -<span class="hljs-number">1</span>
    <span class="hljs-keyword">this</span>.splice(idx, <span class="hljs-number">1</span>)
  <span class="hljs-keyword">else</span>
    []</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>Define the additional tableau of everything but Platinum/Colony.
If there’s a better way to remove items from a JS array, I’d like to know
what it is.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>noColony = <span class="hljs-keyword">this</span>.tableaux.all.slice(<span class="hljs-number">0</span>)
noColony.remove(<span class="hljs-string">'Platinum'</span>)
noColony.remove(<span class="hljs-string">'Colony'</span>)
<span class="hljs-keyword">this</span>.tableaux.noColony = noColony</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <h2 id="utility-functions">Utility functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>This customized clone function will not make unnecessary copies of
cards and AIs. However, it doesn’t seem to work.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">cloneDominionObject</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> obj? <span class="hljs-keyword">or</span> <span class="hljs-keyword">typeof</span> obj <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span>
    <span class="hljs-keyword">return</span> obj

  <span class="hljs-keyword">if</span> (obj.gainPriority?) <span class="hljs-keyword">or</span> (obj.costInCoins?)
    <span class="hljs-keyword">return</span> obj
  newInstance = <span class="hljs-keyword">new</span> obj.constructor()
  <span class="hljs-keyword">for</span> own key, value <span class="hljs-keyword">of</span> obj
    newInstance[key] = cloneDominionObject(value)
  newInstance</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>General function to randomly shuffle a list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">shuffle</span> = <span class="hljs-params">(v)</span> -&gt;</span>
  i = v.length
  <span class="hljs-keyword">while</span> i
    j = parseInt(Math.random() * i)
    i -= <span class="hljs-number">1</span>
    temp = v[i]
    v[i] = v[j]
    v[j] = temp
  v</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>Count the number of times a value appears in a list, coercing everything
to its string value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">countStr</span> = <span class="hljs-params">(list, elt)</span> -&gt;</span>
  count = <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> member <span class="hljs-keyword">in</span> list
    <span class="hljs-keyword">if</span> member.toString() == elt.toString()
      count++
  count</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>Sort by numeric value. You’d think this would be in the standard library.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">numericSort</span> = <span class="hljs-params">(array)</span> -&gt;</span>
  array.sort<span class="hljs-function"><span class="hljs-params">( (a, b) -&gt; (a-b) )</span>

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>When modifying built-in methods of core types, we need to play nice with
other libraries.  For instance, our Array#toString method modifies the
behavior in a way that breaks the CoffeeScript compiler.</p>

            </div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>Modifies built-in methods of core Javascript types in a way that’s reversible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">modifyCoreTypes</span> = -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>Make Array#toString output more readable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">Array</span>::_originalToString ||= <span class="hljs-attribute">Array</span>::toString
  <span class="hljs-attribute">Array</span>::<span class="hljs-function"><span class="hljs-title">toString</span> = -&gt;</span>
    <span class="hljs-string">'['</span> + <span class="hljs-keyword">this</span>.join(<span class="hljs-string">', '</span>) + <span class="hljs-string">']'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>Reverses modifications to core Javascript types</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">restoreCoreTypes</span> = -&gt;</span>
  <span class="hljs-attribute">Array</span>::toString = <span class="hljs-attribute">Array</span>::_originalToString <span class="hljs-keyword">if</span> <span class="hljs-attribute">Array</span>::_originalToString?
  <span class="hljs-keyword">delete</span> <span class="hljs-attribute">Array</span>::_originalToString</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>useCoreTypeMods takes an object and the name of a method.  It then wraps
that method so that it correctly uses and restores our core type
modifications.  The modifications are visible within the method body and
any child method calls, but they are cleaned up when leaving the method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">useCoreTypeMods</span> = <span class="hljs-params">(object, method)</span> -&gt;</span>
  originalMethod = <span class="hljs-string">"_original_<span class="hljs-subst">#{method}</span>"</span>
  <span class="hljs-keyword">unless</span> object[originalMethod]?
    object[originalMethod] = object[method]
    object[method] =<span class="hljs-function"> -&gt;</span>
      <span class="hljs-keyword">try</span>
        modifyCoreTypes()
        <span class="hljs-keyword">this</span>[originalMethod](arguments...)
      <span class="hljs-keyword">finally</span>
        restoreCoreTypes()</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>Use our core type modifications within the State object.  These three
methods are the ones called by external functions to set up and play
a game.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>useCoreTypeMods(<span class="hljs-attribute">State</span>::, <span class="hljs-string">'setUpWithOptions'</span>)
useCoreTypeMods(<span class="hljs-attribute">State</span>::, <span class="hljs-string">'gameIsOver'</span>)
useCoreTypeMods(<span class="hljs-attribute">State</span>::, <span class="hljs-string">'doPlay'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <h2 id="exports">Exports</h2>

            </div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>Export the State and PlayerState classes for other modules to use.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">this</span>.State = State
<span class="hljs-keyword">this</span>.PlayerState = PlayerState</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <h2 id="indecisive-imports">Indecisive imports</h2>

            </div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>Recall that this code begins with:</p>
<pre><code>{c} = <span class="hljs-built_in">require</span> <span class="hljs-string">'./cards'</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">exports</span>?
</code></pre><p>This means “get the variable named <code>c</code> from the module <code>./cards</code>. Unless
there’s no module system. In that case, don’t.”</p>
<p>Here’s why that is useful. When the code
is running inside node.js, it will use node.js’s import system. This
uses the predefined function <code>require</code>, which doesn’t exist in a 
Web browser’s JS environment.</p>
<p>When running in a web browser, there is no sane way for one module to
import another. Instead,
the typical practice — which we will use too — is to just load a bunch of
JavaScript files into the same global namespace.</p>
<p>In that case, the variable <code>c</code> already exists without any additional effort
from us. We’re polluting the global namespace and defeating some of the
point of modules, but that’s how most JavaScript in the wild works anyway.</p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
